---
phase: 06-security-review
plan: 01
type: execute
---

<objective>
Create security scanning foundation with type definitions and GitHub Advisory Database client.

Purpose: Establish the core types and threat intelligence fetching that all security features depend on.
Output: Security types, advisory client with 24hr caching, dependency vulnerability matching.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-security-review/06-RESEARCH.md
@.planning/phases/06-security-review/06-CONTEXT.md
@src/utils/webFetch.ts
@src/chat/commands/verifyWork.ts

**From research:**
- GitHub Advisory Database API: `api.github.com/advisories` with ecosystem=npm filter
- No auth required for public advisories
- OWASP Top 10:2025 categories (A01-A10)
- CVSS severity ranges: 0-3.9=Low, 4-6.9=Medium, 7-8.9=High, 9-10=Critical

**Patterns established:**
- Web fetching via native fetch API (see webFetch.ts)
- VSCode globalState for caching (see verifyWork.ts pattern)
- Types in separate types.ts files
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create security types</name>
  <files>src/security/types.ts</files>
  <action>
Create comprehensive security type definitions:

```typescript
// Severity levels aligned with CVSS v4.0
type Severity = 'critical' | 'high' | 'medium' | 'low' | 'info';

// OWASP Top 10:2025 categories
type OWASPCategory =
  | 'A01:2025-Broken-Access-Control'
  | 'A02:2025-Security-Misconfiguration'
  | 'A03:2025-Supply-Chain-Failures'
  | 'A04:2025-Cryptographic-Failures'
  | 'A05:2025-Injection'
  | 'A06:2025-Insecure-Design'
  | 'A07:2025-Authentication-Failures'
  | 'A08:2025-Software-Data-Integrity-Failures'
  | 'A09:2025-Security-Logging-Alerting-Failures'
  | 'A10:2025-Mishandling-Exceptional-Conditions';

// Fix confidence determines auto-fix eligibility
type FixConfidence = 'high' | 'medium' | 'low';

// Core security issue interface
interface SecurityIssue {
  id: string;
  type: 'code' | 'dependency';
  file?: string;
  line?: number;
  column?: number;
  ruleId?: string;
  message: string;
  severity: Severity;
  owasp?: OWASPCategory;
  cvssScore?: number;
  fixable: boolean;
  fixConfidence?: FixConfidence;
  suggestedFix?: string;
}

// GitHub Advisory structure
interface GitHubAdvisory {
  ghsa_id: string;
  cve_id: string | null;
  summary: string;
  description: string;
  severity: 'low' | 'medium' | 'high' | 'critical';
  cvss: { score: number; vector_string: string } | null;
  cwes: Array<{ cwe_id: string; name: string }>;
  vulnerabilities: Array<{
    package: { ecosystem: string; name: string };
    vulnerable_version_range: string;
    patched_versions: string | null;
  }>;
  published_at: string;
  updated_at: string;
}

// Dependency issue from advisory matching
interface DependencyIssue extends SecurityIssue {
  type: 'dependency';
  ghsaId: string;
  cveId?: string;
  package: string;
  installedVersion: string;
  vulnerableRange: string;
  patchedVersions?: string;
  cwes: string[];
}

// Advisory cache structure
interface AdvisoryCache {
  timestamp: number;
  advisories: GitHubAdvisory[];
}

// Scan results
interface SecurityScanResult {
  codeIssues: SecurityIssue[];
  dependencyIssues: DependencyIssue[];
  advisoryCacheAge: number; // ms since last update
  scannedFiles: number;
  scanDuration: number; // ms
}
```

Export all types. Include JSDoc comments explaining each type's purpose.
  </action>
  <verify>npx tsc --noEmit src/security/types.ts compiles without errors</verify>
  <done>All security types defined and exported, TypeScript compiles</done>
</task>

<task type="auto">
  <name>Task 2: Implement GitHub Advisory client with caching</name>
  <files>src/security/advisories.ts</files>
  <action>
Create advisory fetching client:

1. **fetchNpmAdvisories function:**
   - Fetch from `https://api.github.com/advisories` with params:
     - ecosystem: 'npm'
     - severity: 'critical,high,medium' (skip low for noise reduction)
     - per_page: '100'
     - sort: 'updated'
     - direction: 'desc'
   - Headers: Accept: 'application/vnd.github+json', X-GitHub-Api-Version: '2022-11-28'
   - No auth required for public advisories
   - Return GitHubAdvisory[]

2. **Advisory caching:**
   - Use VSCode ExtensionContext.globalState (passed as parameter)
   - Cache key: 'hopper.security.advisoryCache'
   - TTL: 24 hours (24 * 60 * 60 * 1000 ms)
   - getCachedAdvisories(context): returns cached if fresh, null if expired
   - updateAdvisoryCache(context, advisories): saves with timestamp

3. **getLatestAdvisories function:**
   - Main entry point
   - Check cache first, fetch if expired
   - Handle offline gracefully (return cached even if stale, log warning)
   - Return { advisories: GitHubAdvisory[], fromCache: boolean, cacheAge: number }

4. **Error handling:**
   - Network errors: return cached data if available, empty array if not
   - API errors (rate limit, etc): log warning, return cached
   - Never throw - security scan should continue without advisories

Do NOT include version range matching in this file - that's Task 3.
  </action>
  <verify>Manual test: call getLatestAdvisories, verify returns advisories array and caches result</verify>
  <done>Advisory client fetches from GitHub API, caches in globalState with 24hr TTL, handles errors gracefully</done>
</task>

<task type="auto">
  <name>Task 3: Add dependency vulnerability matching</name>
  <files>src/security/advisories.ts, src/security/index.ts</files>
  <action>
Add dependency matching to advisories.ts:

1. **matchAdvisoriesToDependencies function:**
   - Parameters: advisories: GitHubAdvisory[], dependencies: Record<string, string>
   - For each advisory, check each vulnerability entry
   - If package.ecosystem === 'npm' and package name in dependencies
   - Use semver to check if installed version in vulnerable range
   - Install semver: `npm install semver` (dev dependency not needed, used at runtime)
   - Create DependencyIssue for each match with:
     - id: ghsa_id
     - severity: map advisory.severity to Severity type
     - owasp: 'A03:2025-Supply-Chain-Failures' (all dependency issues)
     - cvssScore: advisory.cvss?.score
     - fixable: patchedVersions !== null
     - suggestedFix: `Update to ${patchedVersions}` if available

2. **readPackageJson helper:**
   - Read package.json from workspace root
   - Extract dependencies + devDependencies
   - Return merged Record<string, string>

3. **Create src/security/index.ts:**
   - Export all types from types.ts
   - Export advisory functions
   - This becomes the main entry point for security module

**Semver range matching:**
Use semver.satisfies() to check if version is in vulnerable range. GitHub uses npm semver syntax (e.g., ">=1.0.0 <1.5.0").
  </action>
  <verify>Create test with known vulnerable package, verify it's detected</verify>
  <done>Dependency matching works with semver, creates DependencyIssue for vulnerable packages</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run compile` succeeds without errors
- [ ] Security types are comprehensive and well-documented
- [ ] Advisory client fetches from GitHub API
- [ ] Caching works (second call returns cached data)
- [ ] Dependency matching identifies vulnerable packages
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Advisory fetching and caching operational
- Dependency vulnerability detection working
</success_criteria>

<output>
After completion, create `.planning/phases/06-security-review/06-01-SUMMARY.md` following the summary template.
</output>
