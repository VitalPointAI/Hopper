---
phase: 06-security-review
plan: 02
type: execute
---

<objective>
Implement programmatic ESLint scanning with security plugins for code vulnerability detection.

Purpose: Enable static analysis of user code to find XSS, injection, and other OWASP vulnerabilities.
Output: ESLint scanner that detects security issues with severity and OWASP categorization.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-security-review/06-RESEARCH.md
@.planning/phases/06-security-review/06-CONTEXT.md
@src/security/types.ts
@src/security/index.ts

**From research:**
- ESLint 9.x with flat config
- eslint-plugin-security (14 rules for Node.js)
- eslint-plugin-no-unsanitized (Mozilla XSS detection)
- Use ESLint Node.js API for programmatic scanning
- Disable noisy rules like detect-object-injection

**Key insight:**
Don't scan node_modules - focus on user's own code. ESLint API returns line, column, ruleId, message for each finding.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install and configure ESLint security plugins</name>
  <files>package.json</files>
  <action>
Install ESLint and security plugins as dependencies (not devDependencies - needed at runtime for scanning user projects):

```bash
npm install eslint eslint-plugin-security eslint-plugin-no-unsanitized @typescript-eslint/parser
```

Note: These are bundled WITH the extension, not installed in user's project. The extension uses its own ESLint instance to scan user code.

Do NOT create an eslint.config.js file - we'll configure programmatically in the scanner.
  </action>
  <verify>npm ls eslint eslint-plugin-security eslint-plugin-no-unsanitized shows all installed</verify>
  <done>ESLint and security plugins installed as extension dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Implement ESLint scanner with security rules</name>
  <files>src/security/scanner.ts</files>
  <action>
Create programmatic ESLint scanner:

1. **getSecurityConfig function:**
   Return ESLint flat config object with security rules:
   ```typescript
   {
     plugins: {
       'security': pluginSecurity,
       'no-unsanitized': pluginNoUnsanitized
     },
     languageOptions: {
       parser: tsParser,
       parserOptions: {
         ecmaVersion: 2022,
         sourceType: 'module'
       }
     },
     rules: {
       // XSS prevention (HIGH priority)
       'no-unsanitized/method': 'error',
       'no-unsanitized/property': 'error',

       // Injection prevention (CRITICAL priority)
       'security/detect-eval-with-expression': 'error',
       'security/detect-child-process': 'error',
       'security/detect-non-literal-require': 'error',
       'security/detect-non-literal-fs-filename': 'warn',

       // Cryptography (MEDIUM priority)
       'security/detect-pseudoRandomBytes': 'error',

       // Other security rules
       'security/detect-buffer-noassert': 'warn',
       'security/detect-possible-timing-attacks': 'warn',
       'security/detect-no-csrf-before-method-override': 'warn',
       'security/detect-disable-mustache-escape': 'error',

       // DISABLE noisy rules
       'security/detect-object-injection': 'off', // Too many false positives
       'security/detect-unsafe-regex': 'off', // Let regex-dos-detector handle
     }
   }
   ```

2. **scanFiles function:**
   - Parameters: patterns: string[] (glob patterns like 'src/**/*.ts')
   - Create ESLint instance with overrideConfigFile: true, overrideConfig: getSecurityConfig()
   - Call eslint.lintFiles(patterns)
   - Transform results to SecurityIssue[] (see Task 3 for mapping)
   - Exclude node_modules automatically (ESLint default)
   - Return { issues: SecurityIssue[], filesScanned: number, duration: number }

3. **Error handling:**
   - If ESLint fails to parse a file, log warning but continue
   - If no files match patterns, return empty results (not an error)
   - Never throw - scan should be resilient

**Important:** Import plugins using require() for CommonJS compatibility:
```typescript
const pluginSecurity = require('eslint-plugin-security');
const pluginNoUnsanitized = require('eslint-plugin-no-unsanitized');
```
  </action>
  <verify>Create test file with eval(), verify scanner detects it</verify>
  <done>ESLint scanner runs programmatically with security rules, returns SecurityIssue[]</done>
</task>

<task type="auto">
  <name>Task 3: Add severity and OWASP category mapping</name>
  <files>src/security/scanner.ts, src/security/index.ts</files>
  <action>
Add rule-to-severity and rule-to-OWASP mappings:

1. **RULE_SEVERITY mapping:**
   ```typescript
   const RULE_SEVERITY: Record<string, Severity> = {
     // Critical (RCE potential)
     'security/detect-eval-with-expression': 'critical',
     'security/detect-child-process': 'critical',
     'security/detect-non-literal-require': 'high',

     // High (XSS, injection)
     'no-unsanitized/method': 'high',
     'no-unsanitized/property': 'high',

     // Medium
     'security/detect-non-literal-fs-filename': 'medium',
     'security/detect-pseudoRandomBytes': 'medium',
     'security/detect-disable-mustache-escape': 'medium',

     // Low
     'security/detect-possible-timing-attacks': 'low',
     'security/detect-buffer-noassert': 'low',
     'security/detect-no-csrf-before-method-override': 'low',
   };
   ```

2. **RULE_OWASP mapping:**
   ```typescript
   const RULE_OWASP: Record<string, OWASPCategory> = {
     // Injection (A05)
     'security/detect-eval-with-expression': 'A05:2025-Injection',
     'security/detect-child-process': 'A05:2025-Injection',
     'security/detect-non-literal-require': 'A05:2025-Injection',
     'no-unsanitized/method': 'A05:2025-Injection',
     'no-unsanitized/property': 'A05:2025-Injection',

     // Cryptographic Failures (A04)
     'security/detect-pseudoRandomBytes': 'A04:2025-Cryptographic-Failures',

     // Broken Access Control (A01)
     'security/detect-non-literal-fs-filename': 'A01:2025-Broken-Access-Control',

     // Security Misconfiguration (A02)
     'security/detect-no-csrf-before-method-override': 'A02:2025-Security-Misconfiguration',
     'security/detect-disable-mustache-escape': 'A02:2025-Security-Misconfiguration',
   };
   ```

3. **FIX_CONFIDENCE mapping:**
   ```typescript
   const FIX_CONFIDENCE: Record<string, FixConfidence> = {
     // HIGH - safe to auto-fix
     'security/detect-pseudoRandomBytes': 'high', // Math.random → crypto.randomBytes
     'security/detect-possible-timing-attacks': 'high', // === → crypto.timingSafeEqual

     // MEDIUM - may change behavior
     'no-unsanitized/property': 'medium', // innerHTML → DOMPurify.sanitize

     // LOW - needs context
     'security/detect-eval-with-expression': 'low',
     'security/detect-child-process': 'low',
   };
   ```

4. **Update scanFiles to use mappings:**
   - For each ESLint message, look up severity, owasp, fixConfidence
   - Default severity to 'medium' if not mapped
   - Set fixable based on whether fix exists AND confidence >= medium

5. **Export scanner from index.ts**
  </action>
  <verify>Scan file with multiple rule violations, verify each has correct severity and OWASP</verify>
  <done>All ESLint findings have severity, OWASP category, and fix confidence mapped</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run compile` succeeds without errors
- [ ] ESLint and plugins are installed
- [ ] Scanner detects eval(), innerHTML, child_process vulnerabilities
- [ ] Each finding has severity and OWASP category
- [ ] Fix confidence is set for applicable rules
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Scanner detects OWASP Top 10 vulnerabilities in code
- Severity and category mapping comprehensive
</success_criteria>

<output>
After completion, create `.planning/phases/06-security-review/06-02-SUMMARY.md` following the summary template.
</output>
