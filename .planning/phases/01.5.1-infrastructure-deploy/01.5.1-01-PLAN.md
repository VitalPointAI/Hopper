---
phase: 01.5.1-infrastructure-deploy
plan: 01
type: execute
---

<objective>
Deploy the licensing infrastructure (Cloudflare Worker and KV namespaces) to production.

Purpose: Enable wallet connection, license validation, and payment processing so users can authenticate and upgrade to Pro.

Output: Live Worker at https://specflow-license-api.{account}.workers.dev accessible from the VSCode extension.
</objective>

<execution_context>
When executing this plan:
1. Execute tasks sequentially - each task builds on the previous
2. Commit after each task with format: `feat(01.5.1-01): <description>`
3. After all tasks, create SUMMARY.md documenting what was deployed
4. Authentication gates may occur - if wrangler commands fail with auth errors, run `wrangler login` first
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context (what was built):
@.planning/phases/01.5-licensing/01.5-02-SUMMARY.md
@.planning/phases/01.5-licensing/01.5-06-SUMMARY.md

# Key files for deployment:
@workers/license-api/wrangler.toml
@workers/license-api/package.json
@workers/license-api/.dev.vars

**Tech stack available:** Cloudflare Workers, Wrangler CLI, Hono, NEAR SDK
**Established patterns:** KV namespace bindings, secret management via wrangler secret put

**Current state:**
- NEAR contract already deployed to specflow.testnet (01.5-02-FIX)
- Worker code complete but not deployed
- wrangler.toml has placeholder KV namespace IDs
- .dev.vars has development secrets (need production equivalents)

**Secrets required for production:**
- STRIPE_SECRET_KEY, STRIPE_WEBHOOK_SECRET, STRIPE_PRICE_ID
- NEAR_PRIVATE_KEY, LICENSE_CONTRACT_ID, NEAR_NETWORK
- FASTNEAR_API_KEY, NEAR_INTENTS_API_KEY
- ADMIN_SECRET
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Cloudflare KV namespaces and update wrangler.toml</name>
  <files>workers/license-api/wrangler.toml</files>
  <action>
Create the 4 required KV namespaces using wrangler CLI:

```bash
cd workers/license-api
wrangler kv:namespace create "PROCESSED_EVENTS"
wrangler kv:namespace create "SUBSCRIPTIONS"
wrangler kv:namespace create "CRYPTO_SUBSCRIPTIONS"
wrangler kv:namespace create "TELEMETRY"
```

Each command outputs the namespace ID. Update wrangler.toml with the actual IDs replacing the placeholders:

```toml
[[kv_namespaces]]
binding = "PROCESSED_EVENTS"
id = "<actual-id-from-output>"

[[kv_namespaces]]
binding = "SUBSCRIPTIONS"
id = "<actual-id-from-output>"

# etc for all 4 namespaces
```

Also update NEAR_RPC_URL to use testnet since contract is on testnet:
```toml
[vars]
NEAR_RPC_URL = "https://rpc.testnet.fastnear.com"
```

Remove preview_id lines (only needed for local dev, not production).
  </action>
  <verify>
wrangler kv:namespace list shows all 4 namespaces
grep -v placeholder wrangler.toml confirms no placeholder IDs remain
  </verify>
  <done>All 4 KV namespaces created with real IDs in wrangler.toml</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Set production secrets via wrangler</action>
  <instructions>
I'll attempt to set the secrets, but some require production values you must provide.

The following secrets need to be set. Run these commands (I'll set what I can from .dev.vars, you provide production values for Stripe):

```bash
cd workers/license-api

# NEAR secrets (can reuse testnet values for now)
wrangler secret put NEAR_PRIVATE_KEY
# Enter: (paste from .dev.vars or use production key)

wrangler secret put LICENSE_CONTRACT_ID
# Enter: specflow.testnet

wrangler secret put NEAR_NETWORK
# Enter: testnet

wrangler secret put FASTNEAR_API_KEY
# Enter: (paste from .dev.vars)

wrangler secret put NEAR_INTENTS_API_KEY
# Enter: (paste from .dev.vars)

# Stripe secrets (PRODUCTION values needed)
wrangler secret put STRIPE_SECRET_KEY
# Enter: sk_live_... (production Stripe key, NOT sk_test_)

wrangler secret put STRIPE_WEBHOOK_SECRET
# Enter: whsec_... (from Stripe dashboard webhook config)

wrangler secret put STRIPE_PRICE_ID
# Enter: price_... (production subscription price ID)

# Admin secret (generate a strong random value)
wrangler secret put ADMIN_SECRET
# Enter: (generate with: openssl rand -base64 32)
```

**Note:** For initial testing, you can use the testnet/test values from .dev.vars. Replace with production values before going live with real payments.
  </instructions>
  <verification>wrangler secret list shows all 9 secrets configured</verification>
  <resume-signal>Type "secrets set" when all secrets are configured, or describe any issues</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Deploy Worker to Cloudflare</name>
  <files>workers/license-api/</files>
  <action>
Deploy the Worker to Cloudflare:

```bash
cd workers/license-api
npm install  # Ensure dependencies installed
wrangler deploy
```

The output will show the deployed URL (e.g., https://specflow-license-api.{account}.workers.dev).

Verify the deployment is live:
```bash
curl https://specflow-license-api.{account}.workers.dev/health
# Should return 200 OK
```

Test admin login page loads:
```bash
curl -I https://specflow-license-api.{account}.workers.dev/admin/login
# Should return 200 with HTML
```
  </action>
  <verify>
wrangler deployments list shows successful deployment
curl to /health endpoint returns 200
curl to /admin/login returns HTML page
  </verify>
  <done>Worker deployed and responding to requests</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Cloudflare Worker deployed with licensing API endpoints</what-built>
  <how-to-verify>
1. Open browser to: https://specflow-license-api.{account}.workers.dev/admin/login
2. Verify: Login page loads with wallet connection option
3. Connect wallet (Meteor, HOT, or MyNearWallet)
4. Verify: After signing, redirects to dashboard
5. Check dashboard shows:
   - Stats cards (Total Installs, Logged In, Pro Users, Conversion Rate)
   - Navigation to Licenses, Subscriptions tabs
6. Try granting a test license:
   - Go to Licenses tab
   - Enter a NEAR account (e.g., test.testnet)
   - Click Grant
   - Verify success message

**If wallet connection fails:** Check browser console for errors. Common issues:
- CORS (should be handled by Hono)
- NEAR_NETWORK mismatch (should be testnet)
  </how-to-verify>
  <resume-signal>Type "approved" if dashboard works, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] All 4 KV namespaces created and bound in wrangler.toml
- [ ] All secrets configured via wrangler secret put
- [ ] Worker deployed and accessible at workers.dev URL
- [ ] /admin/login loads and wallet connection works
- [ ] License grant from admin dashboard succeeds
</verification>

<success_criteria>
- Worker deployed to Cloudflare Workers
- All KV namespaces created with real IDs
- All secrets configured
- Admin dashboard accessible and functional
- Ready for extension to connect
</success_criteria>

<output>
After completion, create `.planning/phases/01.5.1-infrastructure-deploy/01.5.1-01-SUMMARY.md`:

# Phase 1.5.1 Plan 01: Infrastructure Deploy Summary

**Cloudflare Worker deployed with KV namespaces and admin dashboard functional**

## Performance
- Duration: [X] min
- Tasks: 4 (2 auto, 2 checkpoints)

## Accomplishments
- Created 4 KV namespaces (PROCESSED_EVENTS, SUBSCRIPTIONS, CRYPTO_SUBSCRIPTIONS, TELEMETRY)
- Configured all secrets for production
- Deployed Worker to https://specflow-license-api.{account}.workers.dev
- Verified admin dashboard and license grant functionality

## Deployment Details
- Worker URL: [deployed URL]
- KV Namespace IDs: [list IDs]
- Contract: specflow.testnet (testnet for now)

## Decisions Made
- Using testnet for initial deployment (contract already there)
- Production Stripe keys vs test keys decision

## Next Steps
- Update extension configuration to point to deployed Worker URL
- Re-run /gsd:verify-work 03-03 to complete UAT
- Consider mainnet deployment for production

---
*Phase: 01.5.1-infrastructure-deploy*
*Completed: [date]*
</output>
