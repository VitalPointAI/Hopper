---
phase: 01.5.1-infrastructure-deploy
plan: 02
type: execute
---

<objective>
Configure extension to use the deployed Worker URL and verify end-to-end license flow.

Purpose: Complete the deployment by ensuring the VSCode extension can communicate with the deployed licensing infrastructure.

Output: Extension connects to deployed Worker, wallet auth works, license validation functional.
</objective>

<execution_context>
When executing this plan:
1. Execute tasks sequentially
2. Commit after each task with format: `feat(01.5.1-02): <description>`
3. After all tasks, create SUMMARY.md
4. This plan depends on 01.5.1-01 being complete (Worker deployed)
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan in this phase:
@.planning/phases/01.5.1-infrastructure-deploy/01.5.1-01-SUMMARY.md

# Extension configuration:
@package.json
@src/licensing/walletAuth.ts
@src/licensing/upgradeModal.ts
@src/telemetry/telemetryService.ts

**Deployed Worker URL:** (from 01.5.1-01 execution - format: https://specflow-license-api.{account}.workers.dev)

**Current extension defaults:**
- specflow.licenseApiUrl: https://license-api.specflow.workers.dev (placeholder)
- specflow.license.nearNetwork: mainnet (should be testnet until production)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update extension default API URL to deployed Worker</name>
  <files>package.json, src/licensing/walletAuth.ts, src/licensing/upgradeModal.ts, src/telemetry/telemetryService.ts</files>
  <action>
Update all references to the Worker URL to use the actual deployed URL from Plan 01.

In package.json, update the default:
```json
"specflow.licenseApiUrl": {
  "type": "string",
  "default": "https://specflow-license-api.{actual-subdomain}.workers.dev",
  "description": "License API URL for checkout endpoints"
}
```

In source files, update the fallback URLs in:
- src/licensing/walletAuth.ts (2 locations)
- src/licensing/upgradeModal.ts (2 locations)
- src/telemetry/telemetryService.ts (1 location - DEFAULT_API_URL constant)

Also update the default network to testnet since contract is on testnet:
```json
"specflow.license.nearNetwork": {
  "type": "string",
  "enum": ["mainnet", "testnet"],
  "default": "testnet",
  "description": "NEAR network for license contract"
}
```
  </action>
  <verify>
grep -r "license-api.specflow.workers.dev" src/ returns no matches (all updated)
npm run compile succeeds
  </verify>
  <done>All API URLs updated to deployed Worker URL, default network set to testnet</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Extension configured to use deployed licensing infrastructure</what-built>
  <how-to-verify>
1. Build and launch extension:
   ```bash
   npm run compile
   # Press F5 in VSCode to launch Extension Host
   ```

2. In Extension Host window, open Command Palette (Ctrl+Shift+P)

3. Run: "SpecFlow: Connect Wallet"
   - Browser should open to deployed Worker's /auth/sign endpoint
   - Sign with your NEAR wallet

4. Verify wallet connected:
   - Run: "SpecFlow: Show License Status"
   - Should show connected wallet and license status

5. Test license gating:
   - Open chat panel
   - Type: @specflow /plan-phase 1
   - If unlicensed: Should show upgrade prompt with working buttons
   - If licensed: Should allow command to proceed

6. If unlicensed, test upgrade flow:
   - Click "Upgrade with Stripe" or "Pay with Crypto"
   - Verify redirect to checkout page works

**Common issues:**
- CORS errors: Check browser console, Worker should allow extension origin
- 404 on /auth/sign: Verify Worker deployed correctly in Plan 01
- Network mismatch: Ensure both extension and contract use testnet
  </how-to-verify>
  <resume-signal>Type "approved" if wallet auth and license check work, or describe issues</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Re-verify 03-03 UAT issues are unblocked</name>
  <files>N/A</files>
  <action>
With infrastructure deployed, the blocking UAT-006 issue should be resolved.

Verify by testing the /plan-phase command scenarios from 03-03-ISSUES.md:

1. **UAT-006 (Blocker - should be RESOLVED):**
   - Wallet connection page loads
   - User can authenticate

2. **UAT-004 (License check order):**
   - Still needs fix - run @specflow /plan-phase with no args
   - Should show usage help, but may still show wallet prompt first
   - Note: This is a code fix needed, not deployment issue

3. **UAT-005 (Phase 1 should be free):**
   - Still needs fix - run @specflow /plan-phase 1
   - Should work without license for Phase 1
   - Note: This is a code fix needed, not deployment issue

Document which issues are resolved by deployment vs need code fixes.
  </action>
  <verify>
Wallet connection works (UAT-006 resolved)
03-03-ISSUES.md updated to mark UAT-006 as resolved
  </verify>
  <done>UAT-006 resolved, UAT-004 and UAT-005 documented as needing code fixes in 03-03-FIX2</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Extension defaults updated to deployed Worker URL
- [ ] Extension builds without errors
- [ ] Wallet connection works from extension
- [ ] License status check works
- [ ] UAT-006 marked as resolved in 03-03-ISSUES.md
</verification>

<success_criteria>
- Extension connects to deployed licensing infrastructure
- Wallet authentication flow works end-to-end
- License validation functional
- UAT blocker (UAT-006) resolved
- Phase 1.5.1 complete
</success_criteria>

<output>
After completion, create `.planning/phases/01.5.1-infrastructure-deploy/01.5.1-02-SUMMARY.md`:

# Phase 1.5.1 Plan 02: Extension Configuration Summary

**Extension configured for deployed licensing infrastructure with end-to-end verification**

## Performance
- Duration: [X] min
- Tasks: 3 (2 auto, 1 checkpoint)

## Accomplishments
- Updated extension defaults to deployed Worker URL
- Verified wallet authentication flow
- Confirmed license validation works
- Resolved UAT-006 blocker

## Files Modified
- package.json - Updated licenseApiUrl and nearNetwork defaults
- src/licensing/walletAuth.ts - Updated fallback URLs
- src/licensing/upgradeModal.ts - Updated fallback URLs
- src/telemetry/telemetryService.ts - Updated DEFAULT_API_URL

## UAT Status
- UAT-006: RESOLVED (infrastructure deployed)
- UAT-004: Still needs code fix (license check order)
- UAT-005: Still needs code fix (Phase 1 should be free)

## Next Steps
- Phase 1.5.1 complete
- Run /gsd:plan-fix 03-03 to create fix plan for remaining UAT issues
- Then proceed to Phase 4: Execution Commands

---
*Phase: 01.5.1-infrastructure-deploy*
*Completed: [date]*
</output>
