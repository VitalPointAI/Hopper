---
phase: 08-fix-improperly-built-functions
plan: 02-FIX
type: fix
---

<objective>
Fix 2 issues from 08-02 UAT feedback.

Source: User-reported issues during testing
Priority: 1 major (discuss-phase UX), 1 blocker (license check showing upgrade incorrectly)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
1. discuss-phase UX - Should use button-based flow like verify-work (non-blocking, chat input, state tracking)
2. License check showing "Upgrade to Pro" even with valid active license during Phase 2+ planning

**Reference implementations:**
@src/chat/commands/verifyWork.ts (button-based pattern to follow)
@src/chat/commands/discussPhase.ts (current implementation to fix)
@src/licensing/validator.ts (license validation logic)
@src/licensing/phaseGate.ts (phase access check)
@src/chat/commands/planPhase.ts (where license check happens)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Debug and fix license check false negatives</name>
  <files>src/licensing/validator.ts, src/licensing/phaseGate.ts, src/chat/commands/planPhase.ts</files>
  <action>
Investigate why license check shows "Upgrade to Pro" with valid active license.

Root cause investigation:
1. Add detailed console logging to trace the license check flow:
   - Log auth session state (userId, authType, token presence)
   - Log which backend is being used (contract vs API)
   - Log the raw API/contract response
   - Log cache state (hit/miss, cached value)

2. Potential issues to check:
   - Is session.token being passed correctly to API?
   - Is cache returning stale negative result?
   - Is expiresAt comparison failing (nanoseconds vs milliseconds)?
   - Is API URL correct in config?

3. In checkLicense(), add more robust logging:
   ```typescript
   console.log('[checkLicense] Session:', {
     userId: session.userId,
     authType: session.authType,
     hasToken: !!session.token
   });
   ```

4. In checkLicenseOnApi(), log the response:
   ```typescript
   console.log('[checkLicenseOnApi] Response:', data);
   ```

5. In phaseGate.ts checkPhaseAccess(), add logging before the isLicensed check:
   ```typescript
   console.log('[checkPhaseAccess] License status:', status);
   ```

6. Verify expiresAt comparison in phaseGate.ts:
   - Contract returns nanoseconds (status.expiresAt / 1_000_000)
   - API returns milliseconds (no conversion needed for OAuth)
   - Check if the conversion is being applied correctly based on auth type

The fix should ensure:
- Clear cache when debugging
- Add clearCache() call in checkPhaseAccess if status.isLicensed is false but there's an expiresAt
- Log all intermediate values to identify where the failure occurs
  </action>
  <verify>Run /plan-phase 2 with valid license, confirm it proceeds without showing upgrade modal</verify>
  <done>License check correctly identifies valid active license, no false upgrade prompts</done>
</task>

<task type="auto">
  <name>Task 2: Refactor discuss-phase to button-based flow</name>
  <files>src/chat/commands/discussPhase.ts, src/extension.ts</files>
  <action>
Refactor discuss-phase to use the same button-based UX pattern as verify-work:

1. **Add state interface for persistence:**
```typescript
interface DiscussionState {
  phaseNum: number;
  phaseName: string;
  phaseGoal: string;
  questions: Array<{
    question: string;
    interpretationOptions: string[];
    context: string;
  }>;
  responses: Array<{
    questionIndex: number;
    selectedOption?: string;
    customResponse?: string;
  }>;
  currentQuestionIndex: number;
  startedAt: string;
  pausedAt?: string;
  waitingForResponse?: boolean;
}
```

2. **Add state persistence functions** (following verifyWork pattern):
   - `getDiscussionStateKey(phaseNum)` - returns `hopper.discussionState.{phaseNum}`
   - `saveDiscussionState(context, state)` - save to globalState
   - `loadDiscussionState(context, phaseNum)` - load from globalState
   - `clearDiscussionState(context, phaseNum)` - clear after completion

3. **Create button display function:**
```typescript
function displayQuestionWithButtons(
  stream: vscode.ChatResponseStream,
  question: { question: string; interpretationOptions: string[]; context: string },
  questionIndex: number,
  totalQuestions: number,
  phaseNum: number
): void {
  stream.markdown(`---\n\n`);
  stream.markdown(`### Question ${questionIndex + 1} of ${totalQuestions}\n\n`);
  stream.markdown(`**${question.question}**\n\n`);
  stream.markdown(`*${question.context}*\n\n`);

  // Show interpretation options as buttons
  question.interpretationOptions.forEach((option, i) => {
    stream.button({
      command: 'hopper.discussPhaseResponse',
      arguments: [phaseNum, questionIndex, option],
      title: option.substring(0, 40) + (option.length > 40 ? '...' : '')
    });
    stream.markdown(' ');
  });

  // Other option for custom input
  stream.button({
    command: 'hopper.discussPhaseOther',
    arguments: [phaseNum, questionIndex],
    title: 'Other...'
  });

  stream.markdown('\n\n');
  stream.button({
    command: 'hopper.discussPhasePause',
    arguments: [phaseNum],
    title: '‚è∏ Pause'
  });
  stream.markdown('\n\n');
  stream.markdown('*Type in chat anytime to provide custom input. Buttons remain active.*\n\n');
}
```

4. **Register new commands in extension.ts:**
   - `hopper.discussPhaseResponse` - handle option selection
   - `hopper.discussPhaseOther` - prompt for custom input via inputBox
   - `hopper.discussPhasePause` - save state and pause

5. **Update handleDiscussPhase flow:**
   - Check for existing state (resume if found)
   - Generate 3-5 questions based on phase goal
   - Display first question with buttons
   - Save state with waitingForResponse: true
   - Return (non-blocking, wait for button click)

6. **Handle responses in command handlers:**
   - Load state
   - Record response
   - If more questions: display next question
   - If all answered: synthesize context, create CONTEXT.md, clear state
  </action>
  <verify>Run /discuss-phase 2, confirm buttons appear, select options, verify state persists across VSCode restart</verify>
  <done>discuss-phase uses button-based flow with state persistence, supports custom chat input via "Other" option</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run compile` succeeds without errors
- [ ] License check correctly identifies valid licenses
- [ ] /discuss-phase shows button-based question interface
- [ ] State persists across VSCode restarts
- [ ] Custom input via "Other" button works
- [ ] Pause/resume works for discuss-phase
</verification>

<success_criteria>
- All UAT issues addressed
- Tests pass (npm run compile)
- Ready for re-verification with both features working correctly
</success_criteria>

<output>
After completion, create `.planning/phases/08-fix-improperly-built-functions/08-02-FIX-SUMMARY.md`
</output>
