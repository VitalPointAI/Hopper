---
phase: 09-useability-and-skills
plan: 02-FIX
type: fix
---

<objective>
Fix 1 UAT issue from plan 09-02: Task marked complete despite verify step failure.

Source: 09-02-ISSUES.md
Priority: 0 critical, 1 major, 0 minor
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/09-useability-and-skills/09-02-ISSUES.md

**Original plan for reference:**
@.planning/phases/09-useability-and-skills/09-02-PLAN.md

**Key file to modify:**
@src/chat/commands/executePlan.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix UAT-001 - Detect verify step failures and prevent false completion</name>
  <files>src/chat/commands/executePlan.ts</files>
  <action>
The root cause: When a tool like `run_in_terminal` executes a command that fails (e.g., `npm test` returns non-zero), the tool invocation itself succeeds - it returns the error output as a successful tool result. The current code marks tasks complete without checking if the verify step actually passed.

**Fix approach:**

1. After the `executeWithTools` call completes (around line 1291), analyze the tool results to detect command failures:

   - Add a helper function `detectVerifyFailure(lastToolResults: string[]): { failed: boolean; reason?: string }` that:
     - Looks for common failure patterns in tool output: "npm error", "test failed", "error:", "failed", non-zero exit code patterns, "FAIL", "ERR!"
     - Returns `{ failed: true, reason: <extracted message> }` if failure detected
     - Returns `{ failed: false }` if output looks successful

2. Track the tool results text during execution:
   - In `executeWithTools`, when processing tool results, capture the text content
   - Return the concatenated tool output text so the caller can analyze it
   - Modify the function signature to return `Promise<{ toolOutput: string }>` instead of `Promise<void>`

3. After executeWithTools completes, check for verify failures:
   ```typescript
   const executionResult = await executeWithTools(...);
   const verifyCheck = detectVerifyFailure(executionResult.toolOutput);

   if (verifyCheck.failed) {
     // Do NOT mark as completed
     logger.warn(`Task ${task.id} verify failed: ${verifyCheck.reason}`);
     stream.markdown(`**Verify failed:** ${verifyCheck.reason}\n\n`);

     // In yolo mode, auto-log issue
     if (executionMode === 'yolo') {
       const failure: TaskFailure = {
         planPath,
         taskId: task.id,
         taskName: task.name,
         error: `Verify step failed: ${verifyCheck.reason}`,
         phase: plan.phase,
         timestamp: new Date()
       };
       const logResult = await logTaskFailure(workspaceUri, failure);
       // ... existing issue logging ...
     }

     results.push({ taskId: task.id, success: false, name: task.name });
     continue;
   }
   ```

4. Define failure patterns constant near the transient error patterns:
   ```typescript
   const VERIFY_FAILURE_PATTERNS = [
     /npm error/i,
     /npm ERR!/i,
     /test failed/i,
     /tests? failed/i,
     /FAIL\s+/,
     /Error:/,
     /error TS\d+:/i,  // TypeScript errors
     /build failed/i,
     /compilation failed/i,
     /exit code [1-9]/i,
     /non-zero exit/i,
     /command failed/i,
   ];
   ```

Do NOT change the retry logic or auto-issue creation for exceptions - that's working correctly. Only add detection for verify failures that appear in successful tool results.
  </action>
  <verify>
- Build succeeds: `npm run compile`
- Code inspection shows detectVerifyFailure function exists
- executeWithTools returns tool output text
- After task execution, verify failures are checked before marking complete
  </verify>
  <done>
- detectVerifyFailure helper function exists and checks for failure patterns
- executeWithTools returns tool output for analysis
- Tasks with failed verify steps are NOT marked as completed
- Failed verify steps in yolo mode auto-create issues
- Output channel shows verify failure reason
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run compile` succeeds without errors
- [ ] Verify failure detection patterns cover common cases
- [ ] Tasks with verify failures are marked as failed, not completed
- [ ] In yolo mode, verify failures create issues in ISSUES.md
- [ ] Successful verify steps still mark tasks as completed
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- UAT-001 issue addressed: verify failures now prevent false task completion
</success_criteria>

<output>
After completion, create `.planning/phases/09-useability-and-skills/09-02-FIX-SUMMARY.md`
</output>
