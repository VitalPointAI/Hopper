---
phase: 02-chat-participant
plan: 02-FIX
type: fix
---

<objective>
Fix 3 UAT issues from plan 02-02.

Source: 02-02-ISSUES.md
Priority: 0 critical, 2 major, 1 minor
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/02-chat-participant/02-02-ISSUES.md

**Original plan for reference:**
@.planning/phases/02-chat-participant/02-02-PLAN.md

**Root cause analysis:**

1. **UAT-001 (Buttons)**: `stream.button()` uses command `specflow.newProject` which is NOT registered in package.json. VSCode silently ignores buttons for unregistered commands.

2. **UAT-002 (Follow-ups)**: The ChatFollowup objects are missing the `command` property. Per VSCode samples, follow-ups need `{ prompt, label, command }` where `command` matches the slash command name (e.g., `'new-project'`).

3. **UAT-003 (General chat)**: Context injection works but could be more explicit about SpecFlow identity.
</context>

<tasks>

<task type="auto">
  <name>Fix UAT-001: Register commands for buttons</name>
  <files>package.json, src/chat/commands/index.ts</files>
  <action>
Two options for UAT-001:

**Option A (Recommended)**: Replace `stream.button()` with markdown command links.
Since the buttons trigger chat commands (not VSCode commands), use markdown links instead:
```typescript
const md = new vscode.MarkdownString();
md.isTrusted = { enabledCommands: ['workbench.action.chat.open'] };
md.appendMarkdown('[New Project](command:workbench.action.chat.open?%7B%22query%22%3A%22%40specflow%20%2Fnew-project%22%7D)');
stream.markdown(md);
```

However, this is overly complex. The simplest approach:

**Option B (Simplest)**: Remove buttons entirely, rely on follow-ups.
The follow-up suggestions (UAT-002 fix) will provide the clickable actions.
Update /help to just list commands without buttons - the follow-ups will handle actions.

Implement Option B:
1. Remove `stream.button()` call from helpHandler in `src/chat/commands/index.ts`
2. Remove the "Quick Actions" section header
3. The follow-up fixes (UAT-002) will provide clickable actions

This aligns with VSCode's intended UX - slash commands appear as follow-ups, not inline buttons.
  </action>
  <verify>/help shows clean command list without broken button section</verify>
  <done>UAT-001 resolved - buttons removed, follow-ups will provide actions</done>
</task>

<task type="auto">
  <name>Fix UAT-002: Add command property to follow-ups</name>
  <files>src/chat/specflowParticipant.ts</files>
  <action>
Fix the followupProvider to include the `command` property per VSCode API:

```typescript
// WRONG (current):
return [
  { prompt: '/new-project', label: 'Start new project' }
];

// CORRECT:
return [
  { prompt: 'Start a new project', label: 'Start new project', command: 'new-project' }
];
```

The `command` property should match the slash command name (without the `/`).
The `prompt` is the message text sent when clicked.

Update all follow-up returns in provideFollowups() to include the command property:
- For /help: `{ prompt: 'Initialize my project', label: 'Start new project', command: 'new-project' }`
- For /new-project: `{ prompt: 'Create a roadmap', label: 'Create roadmap', command: 'create-roadmap' }`
- etc.

Make prompts more natural (not just the command), while `command` triggers the slash command.
  </action>
  <verify>After running any @specflow command, follow-up buttons appear below response</verify>
  <done>Follow-up suggestions appear with clickable buttons that trigger slash commands</done>
</task>

<task type="auto">
  <name>Fix UAT-003: Improve general chat context</name>
  <files>src/chat/specflowParticipant.ts</files>
  <action>
Improve the system context for general chat (non-command) queries.

Current issue: Two User messages are sent, but the first one is context that should frame the assistant's identity more strongly.

Update the context message to be more directive:
```typescript
vscode.LanguageModelChatMessage.User(
  'IMPORTANT: You are SpecFlow, a VSCode extension for model-agnostic structured planning. ' +
  'When users ask what you do or how to use you, explain that SpecFlow helps organize software projects ' +
  'through planning documents (PROJECT.md, ROADMAP.md, PLAN.md). ' +
  'Available slash commands: /new-project (start here), /create-roadmap, /plan-phase, /execute-plan, /progress, /help. ' +
  'Always suggest relevant commands. Be concise and actionable. ' +
  'If unsure what the user needs, suggest /help to see all commands.'
)
```

This makes SpecFlow more self-aware in general chat.
  </action>
  <verify>@specflow "what is this extension for?" responds with SpecFlow-specific information</verify>
  <done>General chat responds with SpecFlow-aware context and suggests appropriate commands</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All critical issues fixed
- [ ] All major issues fixed (UAT-001, UAT-002)
- [ ] Minor issues fixed (UAT-003)
- [ ] `npm run compile` succeeds
- [ ] /help shows clean command list
- [ ] Follow-up buttons appear after commands
- [ ] General chat is SpecFlow-aware
</verification>

<success_criteria>
- All UAT issues from 02-02-ISSUES.md addressed
- Extension compiles without errors
- Ready for re-verification
</success_criteria>

<output>
After completion, create `.planning/phases/02-chat-participant/02-02-FIX-SUMMARY.md`
</output>
