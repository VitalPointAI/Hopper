---
phase: 02-chat-participant
plan: 01
type: execute
---

<objective>
Register @specflow chat participant with basic response handling and license gating.

Purpose: Create the chat participant that responds to @specflow mentions in VSCode's agent chat, with license validation for Phase 2+ execution.
Output: Working @specflow participant that appears in chat, responds to mentions, and checks license status.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries (dependency graph):
@.planning/phases/01-foundation/01-03-SUMMARY.md
@.planning/phases/01.5-licensing/01.5-04-SUMMARY.md

# Key source files:
@src/extension.ts
@src/licensing/validator.ts
@src/licensing/phaseGate.ts
@package.json

**Tech stack available:**
- VSCode ^1.104.0 (Language Model API, Chat Participants API)
- TypeScript ^5.6.3
- License validator with checkPhaseAccess function

**Established patterns:**
- Provider registration in activate() with disposable tracking
- License validation via LicenseValidator.checkLicense()
- Phase gating via checkPhaseAccess(phaseNumber, validator, context)

**Constraining decisions:**
- Phase 01.5-04: Wallet auth required for license check
- Phase 01-03: Models accessed via request.model in handlers

**Discovery (Level 1 - VSCode Chat Participants API):**
- Register participant via `vscode.chat.createChatParticipant(id, handler)`
- Handler signature: `(request, context, stream, token) => Promise<result>`
- Stream responses via `stream.markdown(text)`, `stream.progress(msg)`
- Package.json contribution: `chatParticipants` array with id, name, fullName, description, isSticky
- Access model via `request.model.sendRequest(messages, {}, token)`

**Key Patterns from Research:**
- Use `stream.progress()` before any operation taking >500ms
- Catch `vscode.LanguageModelError` for proper error handling (quota, offline, no consent)
- Check `token.isCancellationRequested` before each `stream.markdown()` call
- Use User messages for system instructions (System messages not supported)
- Return `IChatResult` with metadata for follow-up provider support
- Add follow-up provider for suggested next actions after responses
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add chatParticipants contribution to package.json</name>
  <files>package.json</files>
  <action>
Add chatParticipants contribution to package.json contributes section:
- id: "specflow.chat-participant"
- name: "specflow"
- fullName: "SpecFlow"
- description: "Model-agnostic structured planning for agent chat"
- isSticky: true (keeps @specflow in input after interaction)

Do NOT add commands yet - that's plan 02-02. Just the basic participant registration.

Also add "Chat" to the categories array if not present.

**Important:** The ID must match exactly between package.json and createChatParticipant() call - mismatches cause silent failures (Pitfall 3 from research).
  </action>
  <verify>npm run compile succeeds with no errors</verify>
  <done>package.json has chatParticipants contribution with correct structure</done>
</task>

<task type="auto">
  <name>Task 2: Create chat participant module with license-gated handler</name>
  <files>src/chat/specflowParticipant.ts</files>
  <action>
Create new chat participant module that:

1. Defines ISpecflowResult interface extending vscode.ChatResult:
   ```typescript
   interface ISpecflowResult extends vscode.ChatResult {
     metadata?: {
       lastCommand?: string;
       phaseNumber?: number;
     };
   }
   ```

2. Exports createSpecflowParticipant(context: vscode.ExtensionContext, licenseValidator: LicenseValidator) function that:
   - Creates handler: vscode.ChatRequestHandler
   - Handler checks license for Phase 2+ using checkPhaseAccess(2, licenseValidator, context)
   - If no license: stream.markdown explaining this requires a Pro license, offer upgrade button via stream.button()
   - If licensed:
     - Show progress: `stream.progress('Processing your request...')`
     - Forward prompt to request.model using User messages (not System - not supported)
     - Wrap sendRequest in try-catch for vscode.LanguageModelError (Pitfall 2)
     - Stream response fragments via stream.markdown(fragment)
     - Check `token.isCancellationRequested` before each stream.markdown() call (Pitfall 1)
   - Returns ISpecflowResult with metadata

3. Creates participant via vscode.chat.createChatParticipant('specflow.chat-participant', handler)

4. Sets iconPath to vscode.Uri.joinPath(context.extensionUri, 'resources', 'icon.png')

5. Sets up followupProvider for suggested next actions:
   ```typescript
   participant.followupProvider = {
     provideFollowups(result, context, token) {
       return [
         { prompt: '/help', label: 'Show commands' },
         { prompt: '/progress', label: 'Check progress' }
       ];
     }
   };
   ```

6. Returns the participant disposable

Import checkPhaseAccess from '../licensing/phaseGate'.

**Error handling pattern from research:**
```typescript
try {
  const response = await request.model.sendRequest(messages, {}, token);
  for await (const fragment of response.text) {
    if (token.isCancellationRequested) break;
    stream.markdown(fragment);
  }
} catch (err) {
  if (err instanceof vscode.LanguageModelError) {
    stream.markdown(`**Error:** ${err.message}\n\nPlease check your model connection.`);
    return { metadata: { lastCommand: 'error' } };
  }
  throw err;
}
```
  </action>
  <verify>npm run compile succeeds with no TypeScript errors</verify>
  <done>src/chat/specflowParticipant.ts exists with exported createSpecflowParticipant function, error handling, and followup provider</done>
</task>

<task type="auto">
  <name>Task 3: Register chat participant in extension activation</name>
  <files>src/extension.ts</files>
  <action>
Modify activate() function to:

1. Import createSpecflowParticipant from './chat/specflowParticipant'

2. After license validator initialization, create and register the chat participant:
   ```typescript
   const chatParticipant = createSpecflowParticipant(context, licenseValidator);
   context.subscriptions.push(chatParticipant);
   ```

Place this after the licenseValidator initialization but before the command registrations.

Do NOT modify any existing functionality - just add the chat participant registration.
  </action>
  <verify>npm run compile succeeds, extension activates in Extension Development Host, @specflow appears in chat</verify>
  <done>Extension registers chat participant on activation, @specflow is mentionable in agent chat</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run compile` succeeds without errors
- [ ] Extension loads in Extension Development Host (F5)
- [ ] @specflow appears as option when typing @ in chat
- [ ] Mentioning @specflow triggers the participant handler
- [ ] Without license: Shows upgrade prompt with button
- [ ] With license: Forwards to model and streams response
- [ ] Progress indicator shows before model response
- [ ] Follow-up suggestions appear after responses
- [ ] Cancellation stops streaming (user clicks stop)
- [ ] Model errors show friendly message (disconnect network to test)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Chat participant responds to @specflow mentions
- License gating works correctly (Phase 2 requires Pro)
- Error handling catches LanguageModelError gracefully
- Cancellation token properly checked in streaming loop
- Follow-up provider suggests next actions
</success_criteria>

<output>
After completion, create `.planning/phases/02-chat-participant/02-01-SUMMARY.md`
</output>
