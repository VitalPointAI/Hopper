---
phase: 01.5.2-dual-auth
plan: 04
type: execute
---

<objective>
Test end-to-end authentication and payment flows for both OAuth and wallet users. Deploy Worker updates and verify production readiness.

Purpose: Ensure both authentication paths work correctly before releasing to users.
Output: Working dual auth system, deployed Worker with OAuth support, admin dashboard showing both user types.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.5.2-dual-auth/01.5.2-DESIGN.md

# Prior work
@.planning/phases/01.5.2-dual-auth/01.5.2-01-SUMMARY.md (OAuth handlers)
@.planning/phases/01.5.2-dual-auth/01.5.2-02-SUMMARY.md (Extension auth)
@.planning/phases/01.5.2-dual-auth/01.5.2-03-SUMMARY.md (Stripe updates)

# Key source files
@workers/license-api/wrangler.toml (deployment config)
@workers/license-api/src/index.ts (routes)
@src/extension.ts (extension entry)

**Tech stack available:** Wrangler CLI, VSCode Extension Host, Stripe Test Mode
**Required secrets:** GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET, GITHUB_CLIENT_ID, GITHUB_CLIENT_SECRET
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure OAuth provider secrets</name>
  <files>workers/license-api/wrangler.toml</files>
  <action>
1. Add OAuth secrets to Worker using wrangler:
   ```bash
   cd workers/license-api

   # Set Google OAuth credentials
   # Get these from Google Cloud Console: https://console.cloud.google.com/apis/credentials
   npx wrangler secret put GOOGLE_CLIENT_ID
   npx wrangler secret put GOOGLE_CLIENT_SECRET

   # Set GitHub OAuth credentials
   # Get these from GitHub: https://github.com/settings/developers
   npx wrangler secret put GITHUB_CLIENT_ID
   npx wrangler secret put GITHUB_CLIENT_SECRET
   ```

2. Update wrangler.toml comments to document required secrets:
   ```toml
   # [vars]
   # Required secrets (set via `wrangler secret put`):
   # - ADMIN_SECRET: JWT signing secret
   # - STRIPE_SECRET_KEY: Stripe API secret key
   # - STRIPE_WEBHOOK_SECRET: Stripe webhook signing secret
   # - NEAR_PRIVATE_KEY: NEAR account private key for contract calls
   # - GOOGLE_CLIENT_ID: Google OAuth client ID
   # - GOOGLE_CLIENT_SECRET: Google OAuth client secret
   # - GITHUB_CLIENT_ID: GitHub OAuth client ID
   # - GITHUB_CLIENT_SECRET: GitHub OAuth client secret
   ```

3. Deploy updated Worker:
   ```bash
   npx wrangler deploy
   ```

**Note:** If OAuth credentials are not available yet, create placeholder values and document as blocker.
  </action>
  <verify>
- `npx wrangler secret list` shows all OAuth secrets configured
- `npx wrangler deploy` succeeds
- Worker logs show no missing env errors on startup
  </verify>
  <done>
- OAuth secrets configured in Worker
- wrangler.toml documents all required secrets
- Worker deployed with OAuth support
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Configure OAuth provider applications</action>
  <instructions>
The Worker needs OAuth credentials from Google and GitHub. These require manual setup:

**Google OAuth Setup:**
1. Go to [Google Cloud Console](https://console.cloud.google.com/apis/credentials)
2. Create OAuth 2.0 Client ID (Web application type)
3. Add authorized redirect URI: `https://specflow-license-api.vitalpointai.workers.dev/auth/oauth/google/callback`
4. Copy Client ID and Client Secret
5. Run: `cd workers/license-api && npx wrangler secret put GOOGLE_CLIENT_ID` (paste ID)
6. Run: `npx wrangler secret put GOOGLE_CLIENT_SECRET` (paste secret)

**GitHub OAuth Setup:**
1. Go to [GitHub Developer Settings](https://github.com/settings/developers)
2. Create new OAuth App
3. Set Authorization callback URL: `https://specflow-license-api.vitalpointai.workers.dev/auth/oauth/github/callback`
4. Copy Client ID and Client Secret
5. Run: `cd workers/license-api && npx wrangler secret put GITHUB_CLIENT_ID` (paste ID)
6. Run: `npx wrangler secret put GITHUB_CLIENT_SECRET` (paste secret)
  </instructions>
  <verification>
After setting secrets, verify with:
```bash
npx wrangler secret list
```
Should show: GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET, GITHUB_CLIENT_ID, GITHUB_CLIENT_SECRET
  </verification>
  <resume-signal>Type "secrets configured" when OAuth credentials are set up</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Update admin dashboard for dual user types</name>
  <files>workers/license-api/src/handlers/admin/ui.ts, workers/license-api/src/handlers/admin/licenses.ts</files>
  <action>
1. Update admin license search to show both user types:
   ```typescript
   // In handleAdminSearchLicense or equivalent
   async function searchLicenses(env: Env, query: string): Promise<LicenseResult[]> {
     const results: LicenseResult[] = [];

     // Search NEAR contract (wallet users)
     // ... existing search ...

     // Search USER_LICENSES KV (OAuth users)
     // List keys matching query
     const kvResults = await env.USER_LICENSES.list({ prefix: 'oauth:' });
     for (const key of kvResults.keys) {
       if (key.name.includes(query)) {
         const record = await env.USER_LICENSES.get(key.name, 'json') as OAuthUserLicense;
         if (record) {
           results.push({
             userId: key.name,
             authType: 'oauth',
             provider: record.provider,
             email: record.email,
             isLicensed: record.licenseExpiry ? record.licenseExpiry > Date.now() : false,
             expiresAt: record.licenseExpiry,
           });
         }
       }
     }

     return results;
   }
   ```

2. Update admin UI to display auth type badge:
   ```html
   <span class="badge ${user.authType === 'oauth' ? 'badge-oauth' : 'badge-wallet'}">
     ${user.authType === 'oauth' ? user.provider : 'NEAR'}
   </span>
   ```

3. Update stats endpoint to include OAuth user counts:
   ```typescript
   // In handleAdminStats
   const oauthUserCount = (await env.USER_LICENSES.list({ prefix: 'oauth:' })).keys.length;
   const oauthLicensedCount = /* count where licenseExpiry > now */;

   return c.json({
     ...existingStats,
     oauth: {
       totalUsers: oauthUserCount,
       licensedUsers: oauthLicensedCount,
     },
   });
   ```
  </action>
  <verify>
- `npm run build` succeeds
- Admin UI compiles without errors
  </verify>
  <done>
- Admin search finds both OAuth and wallet users
- Dashboard shows auth type badges
- Stats include OAuth user counts
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete dual authentication system with OAuth and wallet support</what-built>
  <how-to-verify>
**Test OAuth Flow (Google):**
1. Start extension in debug mode: F5 in VSCode
2. Run command: "SpecFlow: Connect"
3. Select "Google" from auth picker
4. Complete Google sign-in in browser
5. Verify: Extension shows "Authenticated as {email}"
6. Run: `@specflow /status` - should show connected user

**Test OAuth Flow (GitHub):**
1. Disconnect: "SpecFlow: Disconnect"
2. Connect again, select "GitHub"
3. Complete GitHub sign-in
4. Verify: Extension shows "Authenticated as {username}"

**Test Wallet Flow (unchanged):**
1. Disconnect current session
2. Connect, select "NEAR Wallet"
3. Sign with NEAR wallet
4. Verify: Extension shows "Authenticated as {account}.near"

**Test Upgrade Flow (OAuth user):**
1. Connect as OAuth user (Google/GitHub)
2. Run `@specflow /plan-phase 2` (requires Pro)
3. Verify: Upgrade modal shows with user info
4. Click "Subscribe with Card"
5. Verify: Redirects to Stripe checkout

**Test License Check (OAuth user):**
1. After subscription (or manual grant in admin):
2. Verify: `@specflow /status` shows license status
3. Verify: Pro features unlock

**Test Admin Dashboard:**
1. Visit: https://specflow-license-api.vitalpointai.workers.dev/admin
2. Sign in with admin wallet
3. Search for OAuth user by email
4. Verify: Shows OAuth badge, license status
  </how-to-verify>
  <resume-signal>Type "approved" if all flows work, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Google OAuth flow works end-to-end
- [ ] GitHub OAuth flow works end-to-end
- [ ] Wallet auth flow still works (regression test)
- [ ] OAuth users can subscribe via Stripe
- [ ] OAuth user licenses stored in USER_LICENSES KV
- [ ] Admin dashboard shows OAuth users
- [ ] No TypeScript errors in build
</verification>

<success_criteria>
- All tasks completed
- OAuth credentials configured in Worker
- Both auth paths tested and working
- Stripe checkout works for OAuth users
- Admin dashboard updated for dual user types
- Phase 1.5.2 complete
</success_criteria>

<output>
After completion, create `.planning/phases/01.5.2-dual-auth/01.5.2-04-SUMMARY.md`:

# Phase 01.5.2 Plan 04: Testing and Validation Summary

**[Substantive one-liner describing OAuth integration testing and deployment]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- [List with descriptions]

## Decisions Made
- [Any decisions during implementation]

## Issues Encountered
- [Problems and resolutions, or "None"]

## Phase Complete
Phase 1.5.2: Dual Auth is complete. Ready for Phase 2: Chat Participant (if not already done) or Phase 4: Execution Commands.

---
*Phase: 01.5.2-dual-auth*
*Completed: [date]*
</output>
