---
phase: 01.5.2-dual-auth
plan: 02
subsystem: auth
tags: [oauth, near-wallet, vscode-extension, jwt, dual-auth]

# Dependency graph
requires:
  - phase: 01.5.2-dual-auth
    provides: OAuth handlers in Worker (Plan 01)
  - phase: 01.5-licensing
    provides: Wallet auth patterns, license validation
provides:
  - Unified AuthManager supporting OAuth and wallet flows
  - Dual license checking (contract for wallet, API for OAuth)
  - "Connect" command with auth method picker
  - Updated URI handler for OAuth callbacks
affects: [01.5.2-03, 01.5.2-04, 02-chat-participant]

# Tech tracking
tech-stack:
  added: []
  patterns: [unified auth session, dual license backends, auth method picker]

key-files:
  created:
    - src/licensing/authManager.ts
  modified:
    - src/licensing/types.ts
    - src/licensing/validator.ts
    - src/licensing/phaseGate.ts
    - src/extension.ts
    - package.json

key-decisions:
  - "AuthSession type unifies OAuth and wallet sessions with userId, authType, provider"
  - "License check routes to NEAR contract for wallet, API for OAuth users"
  - "Backward-compatible aliases maintained for WalletAuthManager, connectWallet"

patterns-established:
  - "AuthSession with userId supporting both oauth:{provider}:{id} and NEAR account formats"
  - "Dual license backends: checkLicenseOnContract vs checkLicenseOnApi"
  - "Quick pick auth method selector for connect command"

issues-created: []

# Metrics
duration: 12min
completed: 2026-01-15
---

# Phase 01.5.2 Plan 02: Extension Auth Flow Updates Summary

**Unified AuthManager with OAuth (Google/GitHub) and NEAR wallet support, dual license checking backends, and new Connect command with auth picker**

## Performance

- **Duration:** 12 min
- **Started:** 2026-01-15T21:00:00Z
- **Completed:** 2026-01-15T21:12:00Z
- **Tasks:** 3
- **Files modified:** 6

## Accomplishments

- Created unified AuthManager class supporting both OAuth and wallet flows
- Added AuthSession, AuthType, AuthProvider types for dual auth
- Updated LicenseValidator to route license checks based on auth type
- Implemented checkLicenseOnApi() for OAuth users via Worker API
- Created specflow.connect command with auth method picker (Google/GitHub/NEAR)
- Updated URI handler to parse OAuth callback parameters

## Task Commits

Each task was committed atomically:

1. **Task 1: Refactor WalletAuthManager to unified AuthManager** - `1bb4c47` (feat)
2. **Task 2: Update LicenseValidator for dual auth types** - `3ad6cf7` (feat)
3. **Task 3: Update extension.ts commands and URI handler** - `0e7090d` (feat)

**Plan metadata:** `a4410ac` (docs: complete plan)

## Files Created/Modified

- `src/licensing/authManager.ts` - New unified AuthManager with OAuth and wallet flows
- `src/licensing/types.ts` - AuthSession, AuthType, AuthProvider types
- `src/licensing/validator.ts` - Dual license checking (contract vs API)
- `src/licensing/phaseGate.ts` - connect() and disconnect() unified functions
- `src/extension.ts` - New commands, updated URI handler
- `package.json` - specflow.connect and specflow.disconnect commands

## API Changes

| Old | New | Backward Compatible |
|-----|-----|---------------------|
| WalletAuthManager | AuthManager | Yes (alias exported) |
| WalletSession | AuthSession | N/A (internal type) |
| specflow.connectWallet | specflow.connect | Yes (old still works) |
| specflow.disconnectWallet | specflow.disconnect | Yes (old still works) |
| handleAuthCallbackWithToken(id, token, exp) | handleAuthCallbackWithToken({...sessionData}) | No (signature changed) |

## Decisions Made

- AuthSession uses `userId` field that can be either `oauth:{provider}:{id}` or NEAR account ID
- License checking routes to NEAR contract for wallet users, Worker API for OAuth users
- Maintained backward-compatible exports and command aliases
- Quick pick UI lets users choose auth method (Google, GitHub, NEAR Wallet)

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - all verification checks passed. Pre-existing TypeScript errors (missing @types/node) are unrelated to this plan.

## Next Phase Readiness

- Extension now supports both OAuth and wallet authentication
- URI handler ready to receive callbacks from Worker OAuth flows
- Ready for 01.5.2-03-PLAN.md (Upgrade modal with OAuth options)

---
*Phase: 01.5.2-dual-auth*
*Completed: 2026-01-15*
