---
phase: 01.5.2-dual-auth
plan: 03-FIX3
type: fix
---

<objective>
Fix 1 UAT blocker from plan 01.5.2-03-FIX2: Crypto subscription init endpoint crashes with error 1042.

Source: 01.5.2-03-FIX2-ISSUES.md
Priority: 1 blocker
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/01.5.2-dual-auth/01.5.2-03-FIX2-ISSUES.md

**Original plan for reference:**
@.planning/phases/01.5.2-dual-auth/01.5.2-03-FIX2.md

**Handler code:**
@workers/license-api/src/handlers/crypto-subscribe.ts
@workers/license-api/src/services/near-intents.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Diagnose worker crash cause</name>
  <files>workers/license-api/wrangler.toml, workers/license-api/src/handlers/crypto-subscribe.ts</files>
  <action>
1. Check production secrets configuration:
   ```bash
   cd workers/license-api
   npx wrangler secret list
   ```

2. Look for these required secrets/vars for crypto subscription:
   - `CRYPTO_MONTHLY_USD` - Monthly subscription price
   - `NEAR_INTENTS_API_URL` - 1Click API base URL
   - `NEAR_INTENTS_API_KEY` - 1Click API key (optional but may be required)
   - `SETTLEMENT_ACCOUNT` - NEAR account to receive payments (e.g., vitalpointai.near)

3. Check Cloudflare Worker real-time logs for error details:
   ```bash
   npx wrangler tail --format pretty
   ```
   Then in another terminal, trigger the error:
   ```bash
   curl -X POST https://license-api.vitalpointai.workers.dev/api/crypto/subscribe/init \
     -H 'Content-Type: application/json' \
     -d '{}'
   ```

4. Identify the exact error from logs.
  </action>
  <verify>
- Error cause identified from wrangler tail logs
- Missing configuration documented
  </verify>
  <done>
- Root cause identified
- Fix approach determined
  </done>
</task>

<task type="auto">
  <name>Task 2: Add missing environment configuration</name>
  <files>workers/license-api/wrangler.toml</files>
  <action>
Based on Task 1 diagnosis, add missing configuration.

**If missing vars (likely CRYPTO_MONTHLY_USD):**
Add to wrangler.toml [vars] section:
```toml
[vars]
CRYPTO_MONTHLY_USD = "4"
```

**If missing secrets (NEAR_INTENTS_API_URL, NEAR_INTENTS_API_KEY, SETTLEMENT_ACCOUNT):**
```bash
cd workers/license-api
# Set NEAR Intents API URL (1Click API)
npx wrangler secret put NEAR_INTENTS_API_URL
# Enter: https://1click.chaindefuser.com

# Set NEAR Intents API key if required
npx wrangler secret put NEAR_INTENTS_API_KEY
# Enter the API key value

# Set settlement account
npx wrangler secret put SETTLEMENT_ACCOUNT
# Enter: vitalpointai.near
```

**Document all required crypto config in wrangler.toml:**
```toml
# Required for crypto subscriptions:
# - CRYPTO_MONTHLY_USD: Monthly subscription price in USD (var)
# - NEAR_INTENTS_API_URL: 1Click API URL (secret)
# - NEAR_INTENTS_API_KEY: 1Click API key (secret, optional)
# - SETTLEMENT_ACCOUNT: NEAR account to receive payments (secret)
```
  </action>
  <verify>
- `npx wrangler secret list` shows all required secrets
- wrangler.toml has CRYPTO_MONTHLY_USD var
  </verify>
  <done>
- All required configuration in place
  </done>
</task>

<task type="auto">
  <name>Task 3: Add defensive error handling to init handler</name>
  <files>workers/license-api/src/handlers/crypto-subscribe.ts</files>
  <action>
Add early validation and better error messages to handleCryptoSubscribeInit:

```typescript
export async function handleCryptoSubscribeInit(
  c: Context<{ Bindings: Env }>
): Promise<Response> {
  console.log('[init] Handler started');
  try {
    // Validate required configuration early
    if (!c.env.CRYPTO_MONTHLY_USD) {
      console.error('[init] Missing CRYPTO_MONTHLY_USD configuration');
      return c.json({ error: 'Crypto subscriptions not configured' }, 503);
    }
    if (!c.env.NEAR_INTENTS_API_URL) {
      console.error('[init] Missing NEAR_INTENTS_API_URL configuration');
      return c.json({ error: 'Payment service not configured' }, 503);
    }
    if (!c.env.SETTLEMENT_ACCOUNT) {
      console.error('[init] Missing SETTLEMENT_ACCOUNT configuration');
      return c.json({ error: 'Settlement account not configured' }, 503);
    }

    const body = await c.req.json<{ sessionId?: string }>();
    // ... rest of handler
  }
}
```

This prevents crashes from undefined env vars and gives actionable error messages.
  </action>
  <verify>
- `npm run typecheck` passes
- `npm run build` succeeds
  </verify>
  <done>
- Handler validates config before use
- Clear error messages returned instead of crash
  </done>
</task>

<task type="auto">
  <name>Task 4: Deploy and verify fix</name>
  <files>workers/license-api/</files>
  <action>
1. Deploy the updated Worker:
   ```bash
   cd workers/license-api
   npx wrangler deploy
   ```

2. Test the init endpoint:
   ```bash
   curl -X POST https://license-api.vitalpointai.workers.dev/api/crypto/subscribe/init \
     -H 'Content-Type: application/json' \
     -d '{}'
   ```

3. Verify response is either:
   - Success: JSON with intentId, paymentUrl, sessionId
   - Config error: JSON with clear error message (not 1042 crash)

4. If still failing, check wrangler tail for the specific error and iterate.
  </action>
  <verify>
- `curl` returns valid JSON response (not error 1042)
- Either successful subscription init OR clear error message
  </verify>
  <done>
- Init endpoint responds without crashing
- UAT-001 issue resolved
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Worker deployed successfully
- [ ] Init endpoint returns JSON (not error 1042)
- [ ] If success: returns intentId, paymentUrl, sessionId
- [ ] If config missing: returns helpful error message
- [ ] UAT-001 closed in ISSUES.md
</verification>

<success_criteria>
- UAT-001 from 01.5.2-03-FIX2-ISSUES.md resolved
- Crypto subscription init endpoint works or fails gracefully
- Build and deployment successful
- Ready for re-verification
</success_criteria>

<output>
After completion, create `.planning/phases/01.5.2-dual-auth/01.5.2-03-FIX3-SUMMARY.md`:

# Phase 01.5.2 Plan 03 FIX3: Crypto Init Endpoint Fix Summary

**[Substantive one-liner describing what fixed the worker crash]**

## Performance

- **Duration:** [time]
- **Started:** [ISO timestamp]
- **Completed:** [ISO timestamp]
- **Tasks:** 4
- **Files modified:** [count]

## Accomplishments

- [Root cause identified]
- [Configuration fixed]
- [Endpoint working/failing gracefully]

## Files Created/Modified

- [List with descriptions]

## Decisions Made

- [Any decisions during fix]

## Issues Resolved

- UAT-001: Init endpoint returns Error 1042 â†’ FIXED: [root cause]

---
*Phase: 01.5.2-dual-auth*
*Completed: [date]*
</output>
