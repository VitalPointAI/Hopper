---
phase: 01.5.2-dual-auth
plan: 01
type: execute
---

<objective>
Add OAuth authentication (Google, GitHub, email+password) to the Worker alongside existing NEAR wallet auth.

Purpose: Allow fiat-paying users to authenticate without needing a NEAR wallet, reducing friction for non-crypto users.
Output: Working OAuth routes in Worker, USER_LICENSES KV for OAuth users, unified JWT generation.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.5.2-dual-auth/01.5.2-DESIGN.md (architecture design)

# Prior work
@.planning/phases/01.5-licensing/01.5-04-SUMMARY.md (wallet auth patterns)
@.planning/phases/01.5.1-infra-deploy/01.5.1-01-SUMMARY.md (deployed Worker)

# Key source files
@workers/license-api/src/index.ts (Hono router)
@workers/license-api/src/handlers/user-auth.ts (existing wallet auth, JWT creation)
@workers/license-api/src/types.ts (Env interface, type definitions)
@workers/license-api/wrangler.toml (KV bindings, env vars)

**Tech stack available:** Hono, Cloudflare Workers, KV namespaces, JWT (HS256)
**Established patterns:**
- JWT creation with ADMIN_SECRET
- Challenge-based auth flow
- KV storage for state
- CORS-enabled route groups

**Constraining decisions:**
- 01.5-04: JWT session tokens signed with ADMIN_SECRET
- 01.5-02: KV for state storage with TTL
- Design doc: Email+password (not magic link) for v1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add USER_LICENSES KV namespace and OAuth types</name>
  <files>workers/license-api/wrangler.toml, workers/license-api/src/types.ts</files>
  <action>
1. Create USER_LICENSES KV namespace:
   ```bash
   cd workers/license-api && npx wrangler kv namespace create USER_LICENSES
   ```
2. Add binding to wrangler.toml (copy the ID from output)
3. Add to Env interface in types.ts:
   - USER_LICENSES: KVNamespace
4. Add new types to types.ts:
   ```typescript
   // OAuth user license stored in USER_LICENSES KV
   // Key: oauth:{provider}:{userId} (e.g., oauth:google:123456)
   interface OAuthUserLicense {
     id: string;           // Provider-specific user ID
     provider: 'google' | 'github' | 'email';
     email: string;
     displayName?: string;
     licenseExpiry: number | null;  // Unix timestamp, null if no license
     stripeCustomerId?: string;     // Set when they subscribe
     createdAt: number;
     updatedAt: number;
   }

   // Email user stored in USER_LICENSES KV (for email+password auth)
   // Key: email:{email}
   interface EmailUser {
     email: string;
     passwordHash: string;  // bcrypt hash
     createdAt: number;
   }

   // OAuth state stored temporarily in PROCESSED_EVENTS KV
   // Key: oauth_state:{state}
   interface OAuthState {
     provider: 'google' | 'github';
     callback: string;  // VSCode callback URL
     createdAt: number;
   }
   ```
5. Add OAuth-related secrets to wrangler.toml comments:
   - GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET
   - GITHUB_CLIENT_ID, GITHUB_CLIENT_SECRET
  </action>
  <verify>
- `npx wrangler kv namespace list` shows USER_LICENSES
- `npx tsc --noEmit` passes in workers/license-api
  </verify>
  <done>
- USER_LICENSES KV namespace created and bound
- All OAuth types defined in types.ts
- Env interface updated with USER_LICENSES binding
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement OAuth handlers (Google, GitHub)</name>
  <files>workers/license-api/src/handlers/oauth-auth.ts</files>
  <action>
Create new handler file with:

1. **Google OAuth routes:**
   - `GET /auth/oauth/google` - Redirect to Google OAuth
     - Generate state token, store in PROCESSED_EVENTS KV (5-min TTL)
     - Redirect to `accounts.google.com/o/oauth2/v2/auth` with:
       - client_id from env.GOOGLE_CLIENT_ID
       - redirect_uri: `{worker-url}/auth/oauth/google/callback`
       - scope: `email profile`
       - state: generated token
       - response_type: code
   - `GET /auth/oauth/google/callback` - Handle callback
     - Verify state token exists in KV, delete it
     - Exchange code for tokens at `oauth2.googleapis.com/token`
     - Fetch user info from `www.googleapis.com/oauth2/v2/userinfo`
     - Create/update OAuthUserLicense in USER_LICENSES KV
     - Generate JWT with `createOAuthJwt()` (see below)
     - Redirect to VSCode callback URL with token

2. **GitHub OAuth routes:**
   - `GET /auth/oauth/github` - Redirect to GitHub OAuth
     - Same pattern as Google
     - Redirect to `github.com/login/oauth/authorize`
     - scope: `read:user user:email`
   - `GET /auth/oauth/github/callback` - Handle callback
     - Exchange code at `github.com/login/oauth/access_token`
     - Fetch user from `api.github.com/user`
     - Fetch email from `api.github.com/user/emails` (find primary)
     - Create/update OAuthUserLicense, generate JWT, redirect

3. **JWT helper (reuse pattern from user-auth.ts):**
   ```typescript
   async function createOAuthJwt(env: Env, userId: string, provider: string): Promise<string> {
     const header = { alg: 'HS256', typ: 'JWT' };
     const payload = {
       sub: userId,                    // oauth:{provider}:{id}
       type: 'oauth',                  // Different from 'user' (wallet)
       provider: provider,
       iat: Math.floor(Date.now() / 1000),
       exp: Math.floor(Date.now() / 1000) + 24 * 60 * 60,
     };
     // Same signing logic as createUserJwt()
   }
   ```

4. **Error handling:**
   - Invalid state → 400 with error page
   - OAuth provider error → 400 with error message
   - All errors redirect to callback URL with error param

**Security:**
- State tokens are one-time use (deleted after verification)
- 5-minute TTL prevents stale state attacks
- CSRF protection via state parameter
  </action>
  <verify>
- `npx tsc --noEmit` passes
- Handler exports: handleGoogleAuth, handleGoogleCallback, handleGitHubAuth, handleGitHubCallback
  </verify>
  <done>
- Google OAuth flow implemented (redirect + callback)
- GitHub OAuth flow implemented (redirect + callback)
- State management with KV
- JWT generation for OAuth users
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement email+password authentication</name>
  <files>workers/license-api/src/handlers/email-auth.ts</files>
  <action>
Create new handler file with:

1. **POST /auth/email/register** - Create new email user
   - Validate email format (regex)
   - Check email not already registered (lookup in KV)
   - Hash password with bcrypt (use bcryptjs for Workers compatibility):
     ```typescript
     import bcrypt from 'bcryptjs';
     const hash = await bcrypt.hash(password, 10);
     ```
   - Store EmailUser in USER_LICENSES KV (key: `email:{email}`)
   - Create OAuthUserLicense entry (key: `oauth:email:{email}`)
   - Generate JWT and return

2. **POST /auth/email/login** - Login existing user
   - Lookup EmailUser by email
   - Compare password with bcrypt.compare()
   - If valid, generate JWT and return
   - Rate limit: Use KV to track failed attempts per IP (key: `ratelimit:{ip}`)
     - 5 failed attempts → 15-minute lockout
     - Store attempt count with TTL

3. **Request/Response types:**
   ```typescript
   interface EmailRegisterRequest {
     email: string;
     password: string;
     displayName?: string;
   }

   interface EmailLoginRequest {
     email: string;
     password: string;
   }

   interface EmailAuthResponse {
     token: string;
     expiresAt: number;
     userId: string;  // oauth:email:{email}
   }
   ```

4. **Validation:**
   - Email: RFC 5322 basic pattern
   - Password: Minimum 8 characters
   - Return 400 with specific error messages

**Dependencies:** Add bcryptjs to package.json:
```bash
cd workers/license-api && npm install bcryptjs && npm install -D @types/bcryptjs
```
  </action>
  <verify>
- `npm run build` succeeds in workers/license-api
- `npx tsc --noEmit` passes
- Handler exports: handleEmailRegister, handleEmailLogin
  </verify>
  <done>
- Email registration with bcrypt password hashing
- Email login with password verification
- Rate limiting for failed login attempts
- JWT generation consistent with OAuth handlers
  </done>
</task>

<task type="auto">
  <name>Task 4: Register OAuth routes in Hono router</name>
  <files>workers/license-api/src/index.ts</files>
  <action>
Update main router to include OAuth routes:

1. Add route group for OAuth (under existing /auth/*):
   ```typescript
   // OAuth routes (alongside existing wallet auth)
   app.get('/auth/oauth/google', async (c) => {
     const { handleGoogleAuth } = await import('./handlers/oauth-auth');
     return handleGoogleAuth(c);
   });
   app.get('/auth/oauth/google/callback', async (c) => {
     const { handleGoogleCallback } = await import('./handlers/oauth-auth');
     return handleGoogleCallback(c);
   });
   app.get('/auth/oauth/github', async (c) => {
     const { handleGitHubAuth } = await import('./handlers/oauth-auth');
     return handleGitHubAuth(c);
   });
   app.get('/auth/oauth/github/callback', async (c) => {
     const { handleGitHubCallback } = await import('./handlers/oauth-auth');
     return handleGitHubCallback(c);
   });
   ```

2. Add email auth routes:
   ```typescript
   app.post('/auth/email/register', async (c) => {
     const { handleEmailRegister } = await import('./handlers/email-auth');
     return handleEmailRegister(c);
   });
   app.post('/auth/email/login', async (c) => {
     const { handleEmailLogin } = await import('./handlers/email-auth');
     return handleEmailLogin(c);
   });
   ```

3. Verify CORS is enabled for /auth/* (should already be from existing setup)

4. Keep existing /auth/sign and /auth/verify routes for wallet auth

**Route summary after changes:**
- GET /auth/sign - Wallet auth page (existing)
- POST /auth/verify - Wallet signature verify (existing)
- GET /auth/oauth/google - Start Google OAuth
- GET /auth/oauth/google/callback - Google OAuth callback
- GET /auth/oauth/github - Start GitHub OAuth
- GET /auth/oauth/github/callback - GitHub OAuth callback
- POST /auth/email/register - Email registration
- POST /auth/email/login - Email login
  </action>
  <verify>
- `npm run build` succeeds
- Local dev server starts: `npx wrangler dev`
- Routes respond (even if OAuth fails without secrets):
  - `curl http://localhost:8787/auth/oauth/google` returns redirect or error
  - `curl -X POST http://localhost:8787/auth/email/register -H "Content-Type: application/json" -d '{"email":"test@test.com","password":"testpass123"}' --include`
  </verify>
  <done>
- All OAuth routes registered in Hono router
- Email auth routes registered
- Dynamic imports for code splitting
- CORS enabled on all auth routes
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds in workers/license-api
- [ ] `npx tsc --noEmit` passes without errors
- [ ] USER_LICENSES KV namespace exists (`npx wrangler kv namespace list`)
- [ ] All new types compile correctly
- [ ] `npx wrangler dev` starts local dev server
- [ ] Email register/login routes respond to requests
</verification>

<success_criteria>
- All 4 tasks completed
- All verification checks pass
- OAuth handlers created (Google, GitHub)
- Email auth handlers created (register, login)
- Routes registered in Hono router
- Types defined for OAuth user licenses
- USER_LICENSES KV namespace created
</success_criteria>

<output>
After completion, create `.planning/phases/01.5.2-dual-auth/01.5.2-01-SUMMARY.md`:

# Phase 01.5.2 Plan 01: OAuth Infrastructure Summary

**[Substantive one-liner describing OAuth handlers, KV storage, email auth]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- [List with descriptions]

## Decisions Made
- [Any decisions during implementation]

## Issues Encountered
- [Problems and resolutions, or "None"]

## Next Step
Ready for 01.5.2-02-PLAN.md (Extension auth flow updates)

---
*Phase: 01.5.2-dual-auth*
*Completed: [date]*
</output>
