---
phase: 01.5.2-dual-auth
type: design
---

# Phase 1.5.2: Dual Authentication & Payment System

**Goal**: Support both OAuth (Google/Twitter/GitHub/Email) and NEAR wallet authentication with unified license management, minimizing friction for users who don't need crypto.

## Problem Statement

Currently, SpecFlow requires NEAR wallet authentication even for Stripe (credit card) payments. This creates unnecessary friction:
1. Users must understand NEAR wallets to use the extension
2. Fiat-paying customers don't benefit from on-chain license storage
3. The upgrade flow requires wallet connection before showing payment options

## Design Principles

1. **Deferred Authentication**: No auth required until Phase 2+ features (freemium gating)
2. **Payment-Appropriate Identity**: Crypto payers use wallets, fiat payers use OAuth
3. **Single Source of Truth**: All licenses ultimately stored in one place per payment type
4. **Minimal Friction**: Fewest possible steps to upgrade

## Recommended Architecture

### Authentication Paths

```
┌─────────────────────────────────────────────────────────────────┐
│                        UPGRADE MODAL                             │
│  ┌────────────────────┐      ┌────────────────────┐            │
│  │   Pay with Card    │      │   Pay with Crypto  │            │
│  │   ($5/mo)          │      │   ($4/mo - 20% off)│            │
│  └────────┬───────────┘      └────────┬───────────┘            │
└───────────┼───────────────────────────┼─────────────────────────┘
            │                           │
            ▼                           ▼
┌───────────────────────┐   ┌───────────────────────┐
│   OAuth Sign-In       │   │   Wallet Sign-In      │
│   - Google            │   │   - MyNearWallet      │
│   - Twitter/X         │   │   - HERE Wallet       │
│   - GitHub            │   │   - Meteor Wallet     │
│   - Email+Password    │   │   - Ledger            │
└───────────┬───────────┘   └───────────┬───────────┘
            │                           │
            ▼                           ▼
┌───────────────────────┐   ┌───────────────────────┐
│   Stripe Checkout     │   │   Crypto Payment Page │
│   (email = user ID)   │   │   (wallet = user ID)  │
└───────────┬───────────┘   └───────────┬───────────┘
            │                           │
            ▼                           ▼
┌───────────────────────┐   ┌───────────────────────┐
│ License in KV         │   │ License on NEAR       │
│ (user_id → expiry)    │   │ (account_id → expiry) │
│ + Stripe customer_id  │   │ + Intent subscription │
└───────────────────────┘   └───────────────────────┘
```

### Storage Architecture

**Crypto Path (existing):**
- NEAR Contract: `license.specflow.near` - source of truth for license expiry
- KV `CRYPTO_SUBSCRIPTIONS`: Subscription metadata (intent ID, billing day, status)

**Fiat Path (new):**
- KV `USER_LICENSES`: OAuth user ID → license expiry + Stripe customer ID
- KV `SUBSCRIPTIONS`: Stripe customer ID → subscription metadata (existing, repurpose)

This keeps the NEAR contract exclusively for crypto users while fiat users have a simpler KV-based license store.

### JWT Token Strategy

Both paths produce a JWT stored in VSCode secrets:
```typescript
interface AuthSession {
  userId: string;        // OAuth user ID OR NEAR account ID
  authType: 'oauth' | 'wallet';
  token: string;         // JWT signed by Worker
  expiresAt: number;     // Token expiry (24h)
  provider?: string;     // 'google' | 'twitter' | 'github' | 'email' | 'near'
}
```

License validation checks:
1. JWT valid? → Extract userId and authType
2. If wallet: Check NEAR contract
3. If OAuth: Check KV `USER_LICENSES`

## Implementation Tasks

### Plan 01: OAuth Infrastructure (this plan)
- Worker: Add OAuth routes (`/auth/oauth/google`, `/auth/oauth/callback`)
- Worker: Add email/password auth (`/auth/email/register`, `/auth/email/login`)
- Worker: Create `USER_LICENSES` KV namespace for OAuth user licenses
- Worker: Unified JWT generation for both auth types

### Plan 02: Extension Auth Flow Updates
- Rename commands: "SpecFlow: Connect" / "SpecFlow: Disconnect"
- Update upgrade modal: Show auth options based on payment choice
- OAuth callback handling via VSCode URI handler
- License validator: Check both contract and KV based on auth type

### Plan 03: Stripe Flow Updates
- Remove NEAR account requirement from Stripe checkout
- Use OAuth user ID as customer identifier
- Webhook: Write license to `USER_LICENSES` KV instead of requiring NEAR account
- Link Stripe customer to OAuth user ID in metadata

### Plan 04: Testing & Migration
- End-to-end testing of both paths
- Migration path for existing wallet+Stripe users (optional)
- Update admin dashboard to show both license types

## Security Considerations

1. **OAuth tokens**: Use short-lived tokens (24h), stored in VSCode secrets
2. **Email passwords**: Hash with bcrypt, rate-limit login attempts
3. **JWT signing**: Use HS256 with Worker secret, include audience claim
4. **CSRF protection**: State parameter in OAuth flow
5. **No cross-auth**: OAuth users can't claim wallet licenses and vice versa

## Command Renaming

Current:
- "SpecFlow: Connect Wallet"
- "SpecFlow: Disconnect Wallet"
- "SpecFlow: Show License Status"

Proposed:
- "SpecFlow: Connect" (opens modal with auth options)
- "SpecFlow: Disconnect" (clears session regardless of type)
- "SpecFlow: Show License Status" (unchanged)

## Upgrade Flow (Updated)

```
User runs /plan-phase 2 (Pro feature)
        │
        ▼
┌─────────────────────────────┐
│ Not licensed? Show upgrade  │
│ modal with payment options  │
└─────────────────────────────┘
        │
        ├── User clicks "Pay with Card"
        │         │
        │         ▼
        │   OAuth sign-in page
        │   (Google/Twitter/GitHub/Email)
        │         │
        │         ▼
        │   Stripe checkout (prefilled email)
        │         │
        │         ▼
        │   Webhook grants license to OAuth user
        │         │
        │         ▼
        │   Extension refreshes, command works
        │
        └── User clicks "Pay with Crypto"
                  │
                  ▼
            Wallet sign-in page
            (existing flow)
                  │
                  ▼
            Crypto payment page
                  │
                  ▼
            License granted on-chain
                  │
                  ▼
            Extension refreshes, command works
```

## Dependencies

- OAuth providers: Google Cloud Console, Twitter Developer, GitHub OAuth Apps
- Email service: Could use Cloudflare Workers + external SMTP or simple KV-based OTP
- Existing: Stripe integration, NEAR contract, Cloudflare Workers

## Scope Decision: Email Authentication

For email auth, two options:

**Option A: Email + Password (Recommended)**
- Simpler implementation (bcrypt hash in KV)
- No external email service needed for signup
- Password reset via magic link (needs email service)
- More familiar to users

**Option B: Magic Link Only**
- No passwords to manage
- Requires email service for every login
- Better security (no password database)
- More friction per login

Recommendation: Start with Option A (email+password) for v1. Can add magic link later.

## Risk Mitigation

1. **OAuth provider downtime**: Users can always use wallet auth as fallback
2. **KV license data loss**: Stripe is source of truth; can rebuild from subscription status
3. **Migration complexity**: New system, no legacy OAuth users to migrate

## Success Criteria

- [ ] OAuth sign-in works for Google, GitHub (Twitter optional for v1)
- [ ] Email+password registration and login work
- [ ] Stripe checkout works without NEAR wallet
- [ ] License validation checks correct store based on auth type
- [ ] Both payment paths grant functional licenses
- [ ] Commands renamed appropriately

## Estimated Scope

- Plan 01: OAuth infrastructure (Worker) - 4-5 tasks
- Plan 02: Extension auth flow - 3-4 tasks
- Plan 03: Stripe flow updates - 2-3 tasks
- Plan 04: Testing - 2-3 tasks

Total: ~12-15 tasks across 4 plans

---
*Phase: 01.5.2-dual-auth*
*Created: 2026-01-15*
