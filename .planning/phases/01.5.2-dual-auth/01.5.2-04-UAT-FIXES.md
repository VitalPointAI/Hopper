# Phase 01.5.2-04 UAT Fixes

## Issues Fixed

### 1. License Not Granting Access Despite Active Contract License

**Problem:** Extension wasn't granting access to `/plan-phase 2` even though license was active on mainnet contract.

**Root Cause:** Multiple issues:
- Contract returns `expiresAt` in nanoseconds, code was comparing incorrectly
- `checkLicense()` was being called without first checking authentication
- Async initialization race condition in AuthManager

**Fixes:**
- Fixed nanoseconds to milliseconds conversion: `expiresAt / 1_000_000`
- Added `ensureInitialized()` pattern to AuthManager
- Added explicit `isAuthenticated()` check before `checkLicense()` in planPhase.ts

### 2. Disconnected Users Still Had Access

**Problem:** After disconnecting, users could still access Phase 2+ features.

**Root Cause:** The auth check wasn't being performed before the license check.

**Fix:** Added explicit auth check with proper messaging:
- "Connect" button for users with existing license
- "Get Pro License" button for users who need one

### 3. Multi-Chain Wallet Support

**Problem:** Connect command only supported NEAR wallet, not EVM/Solana wallets.

**Fix:**
- Created `/auth/wallet` endpoint on Worker with multi-chain wallet page
- Updated `connect()` to show Google, GitHub, and Wallet options
- Wallet option opens multi-chain wallet page supporting NEAR, Ethereum, Base, Arbitrum, Solana, Polygon, TON, TRON

### 4. Post-Connection User Feedback

**Problem:** After connecting and returning to VSCode, no clear indication of success.

**Fix:**
- Auth callback now auto-opens chat with `/status` command
- `/status` shows connection info, license status, and "Continue Planning" button
- Same pattern applied to payment success callback
- Removed reliance on toast notifications for primary feedback

### 5. FastNEAR RPC URLs

**Problem:** Extension was using slower official NEAR RPC.

**Fix:** Updated `NEAR_RPC_URLS` to use FastNEAR:
- mainnet: `https://rpc.mainnet.fastnear.com`
- testnet: `https://rpc.testnet.fastnear.com`

## Files Modified

- `src/licensing/phaseGate.ts` - Nanoseconds fix, connect() multi-chain support
- `src/licensing/types.ts` - FastNEAR RPC URLs
- `src/licensing/authManager.ts` - `ensureInitialized()`, `startWalletAuth()`
- `src/licensing/validator.ts` - `ensureInitialized()` wrapper
- `src/chat/commands/planPhase.ts` - Auth check before license check
- `src/chat/commands/index.ts` - Status handler improvements, nanoseconds fix
- `src/extension.ts` - Auto-open chat after auth/payment callbacks
- `workers/license-api/src/handlers/wallet-auth-ui.ts` - NEW: Multi-chain wallet page
- `workers/license-api/src/index.ts` - `/auth/wallet` route

## Status

**APPROVED** - Payment processing and license gating working correctly.
