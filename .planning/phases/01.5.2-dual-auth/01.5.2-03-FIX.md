# Phase 01.5.2 Plan 03 FIX: Handle Existing Crypto Subscription

**Issue:** Crypto checkout fails with 409 error when pending subscription exists
**Discovered:** 2026-01-15 (UAT)
**Severity:** Blocker

## Problem

When a user tries to subscribe via crypto but already has a pending subscription, the checkout fails with:
```
{"error":"Subscription already exists","existingIntentId":"...","status":"pending"}
```

This happens because:
1. User starts crypto checkout → creates pending subscription with intent ID
2. User doesn't complete payment (closes browser, navigates away, etc.)
3. User tries to subscribe again → endpoint returns 409 Conflict

The client (upgradeModal.ts) didn't handle this 409 response gracefully.

## Solution

Resume the existing subscription instead of failing. When the API returns 409 with an existing intent ID, the client:
1. Detects the 409 status code
2. Extracts the `existingIntentId` from the response
3. Navigates to the existing payment page using that intent ID

This way, users with pending subscriptions are seamlessly redirected to complete their existing payment.

## Tasks

### Task 1: Update handleCryptoCheckout to handle 409 response

**File:** `src/licensing/upgradeModal.ts`

Added handling for 409 Conflict response in `handleCryptoCheckout` method:
- Check for `response.status === 409` before generic error handling
- Parse response JSON to get `existingIntentId`
- Show "Resuming existing subscription..." message
- Navigate to existing payment page URL

## Files Modified

1. `src/licensing/upgradeModal.ts` - Added 409 handling in handleCryptoCheckout (lines 211-224)

## Verification

1. `npm run compile` - succeeds
2. Test flow:
   - Open upgrade modal with wallet connected
   - Click "Pay with Crypto" to create pending subscription
   - Close browser without completing payment
   - Click "Pay with Crypto" again
   - Should see "Resuming existing subscription..." and open same payment page

## Decision

| Decision | Rationale |
|----------|-----------|
| Resume instead of cancel+restart | Simpler UX - user continues where they left off |
| Same handling for active status | Active subscriptions also return 409, user can see their status on payment page |

---
*Phase: 01.5.2-dual-auth*
*Plan: 03-FIX*
*Completed: 2026-01-15*
