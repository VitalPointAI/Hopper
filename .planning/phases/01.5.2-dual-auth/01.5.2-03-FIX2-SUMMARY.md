---
phase: 01.5.2-dual-auth
plan: 03-FIX2
subsystem: payments
tags: [crypto, near-intents, wallet-connect, vscode-uri]

# Dependency graph
requires:
  - phase: 01.5.2-03
    provides: Crypto payment flow with authenticated wallet
provides:
  - Session-based crypto subscription init (no pre-auth required)
  - Wallet linking endpoint for payment page
  - VSCode redirect after successful payment
affects: [01.5.2-04, payment-flows]

# Tech tracking
tech-stack:
  added: []
  patterns: [session-id-tracking, post-payment-auth]

key-files:
  created: []
  modified:
    - workers/license-api/src/handlers/crypto-subscribe.ts
    - workers/license-api/src/handlers/crypto-payment-ui.ts
    - workers/license-api/src/index.ts
    - workers/license-api/src/types.ts
    - workers/license-api/src/services/crypto-subscription-store.ts
    - src/licensing/upgradeModal.ts

key-decisions:
  - "Session-based init: Create subscription before wallet is known"
  - "Link before payment: Associate wallet before money moves for safety"
  - "VSCode redirect on success: Completes auth loop after payment"

patterns-established:
  - "Anonymous subscription init with later wallet linking"

issues-created: []

# Metrics
duration: 6min
completed: 2026-01-15
---

# Phase 01.5.2 Plan 03 FIX2: Streamlined Payment Flows Summary

**Session-based crypto subscription init with wallet linking and VSCode redirect after payment**

## Performance

- **Duration:** 6 min
- **Started:** 2026-01-15T22:26:06Z
- **Completed:** 2026-01-15T22:32:40Z
- **Tasks:** 7 + 1 deviation fix
- **Files modified:** 8

## Accomplishments

- Session-based crypto subscription init that doesn't require wallet auth upfront
- Wallet linking endpoint for payment page to associate wallet before payment
- VSCode redirect URL in confirm response for seamless auth after payment
- Payment page JS updated to link wallet and redirect on success
- Upgrade modal updated to use new init flow for unauthenticated users

## Task Commits

Each task was committed atomically:

1. **Task 1: Add session-based crypto subscription init** - `ba269d1` (feat)
2. **Task 2: Capture wallet on payment page connect** - `efd9ada` (feat)
3. **Task 3: Add wallet linking endpoint** - `ae025e6` (feat)
4. **Task 4: Add VSCode callback to confirm response** - `468919b` (feat)
5. **Task 5: Redirect to VSCode on payment success** - `cbb3408` (feat)
6. **Task 6: Update upgrade modal for direct payment** - `a389801` (feat)
7. **Task 7: Register init and link routes** - `494415c` (feat)

**Deviation fix:** `b5262bd` (fix - nullable nextChargeDate TypeScript)

**Plan metadata:** (this commit)

## Files Created/Modified

### Worker (workers/license-api/src/)
- `types.ts` - Added sessionId field, made nextChargeDate nullable
- `services/crypto-subscription-store.ts` - Added intent ID and session ID indexes, null safety
- `handlers/crypto-subscribe.ts` - Added handleCryptoSubscribeInit and handleCryptoSubscribeLink handlers
- `handlers/crypto-payment-ui.ts` - Added wallet linking call and VSCode redirect
- `handlers/admin/licenses.ts` - Fixed null-to-undefined conversion
- `handlers/admin/subscriptions.ts` - Fixed null-to-undefined conversion
- `index.ts` - Registered new routes

### Extension (src/)
- `licensing/upgradeModal.ts` - Updated handleCryptoCheckout for unauthenticated flow

## Decisions Made

| Decision | Rationale |
|----------|-----------|
| Session-based init | Allows creating subscription before wallet is known |
| Link before payment | Associates wallet before money moves for safety |
| VSCode redirect on success | Completes the auth loop after payment |

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Handle nullable nextChargeDate in TypeScript**
- **Found during:** Task 1 (session-based init)
- **Issue:** Making nextChargeDate nullable (`string | null`) caused TypeScript errors in admin handlers and subscription store
- **Fix:** Added null checks and converted null to undefined where API expected undefined
- **Files modified:** crypto-subscription-store.ts, admin/licenses.ts, admin/subscriptions.ts
- **Verification:** npm run typecheck passes
- **Committed in:** b5262bd

---

**Total deviations:** 1 auto-fixed (blocking), 0 deferred
**Impact on plan:** Fix was necessary for TypeScript compilation. No scope creep.

## Issues Encountered

None - plan executed successfully with one blocking TypeScript fix.

## Next Phase Readiness

- Crypto payment flow now streamlined: single browser trip (connect wallet + pay + return to VSCode)
- Ready for 01.5.2-04 (Testing and validation)
- Worker needs deployment to production (`wrangler deploy`)

---
*Phase: 01.5.2-dual-auth*
*Plan: 03-FIX2*
*Completed: 2026-01-15*
