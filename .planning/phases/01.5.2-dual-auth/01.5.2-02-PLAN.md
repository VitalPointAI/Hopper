---
phase: 01.5.2-dual-auth
plan: 02
type: execute
---

<objective>
Update extension authentication flows to support both OAuth and NEAR wallet, with unified "Connect" and "Disconnect" commands.

Purpose: Allow users to authenticate with either OAuth providers or NEAR wallet, making the extension accessible to non-crypto users.
Output: Updated auth manager, upgrade modal with OAuth options, unified connect commands.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.5.2-dual-auth/01.5.2-DESIGN.md (architecture design)

# Prior work
@.planning/phases/01.5.2-dual-auth/01.5.2-01-SUMMARY.md (OAuth handlers in Worker)
@.planning/phases/01.5-licensing/01.5-04-SUMMARY.md (wallet auth patterns)

# Key source files
@src/licensing/walletAuth.ts (existing wallet auth manager)
@src/licensing/validator.ts (license validator)
@src/licensing/upgradeModal.ts (upgrade webview)
@src/extension.ts (command registration, URI handler)
@src/licensing/phaseGate.ts (connect/disconnect commands)

**Tech stack available:** VSCode extension APIs, secrets storage, webview, URI handler
**Established patterns:**
- JWT session tokens in VSCode secrets
- URI handler callbacks for browser→extension flow
- Webview modals with CSP nonce
- WalletAuthManager pattern

**Constraining decisions:**
- 01.5-04: JWT tokens signed with ADMIN_SECRET, 24h expiry
- Design doc: Both OAuth and wallet produce compatible JWT sessions
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor WalletAuthManager to unified AuthManager</name>
  <files>src/licensing/authManager.ts (rename from walletAuth.ts), src/licensing/types.ts</files>
  <action>
1. Rename `src/licensing/walletAuth.ts` to `src/licensing/authManager.ts`

2. Update types in `src/licensing/types.ts`:
   ```typescript
   // Unified auth session (replaces WalletSession)
   export interface AuthSession {
     userId: string;         // oauth:{provider}:{id} OR NEAR account ID
     authType: 'oauth' | 'wallet';
     provider: 'google' | 'github' | 'email' | 'near';
     token: string;          // JWT from Worker
     expiresAt: number;      // Unix timestamp ms
     displayName?: string;   // From OAuth profile
     email?: string;         // From OAuth profile
   }
   ```

3. Update AuthManager class (formerly WalletAuthManager):
   - Rename class to `AuthManager`
   - Update `SESSION_STORAGE_KEY` to `specflow.authSession`
   - Change `session` property type to `AuthSession | null`
   - Keep `startAuth()` for wallet flow (calls `/auth/sign`)
   - Add `startOAuth(provider: 'google' | 'github')` method:
     ```typescript
     async startOAuth(provider: 'google' | 'github'): Promise<void> {
       const config = vscode.workspace.getConfiguration('specflow');
       const apiUrl = config.get<string>('licenseApiUrl') ?? '...';

       // Build OAuth URL - callback is handled by Worker, then redirected to VSCode
       const oauthUrl = `${apiUrl}/auth/oauth/${provider}?callback=${encodeURIComponent('vscode://vitalpointai.specflow/auth-callback')}`;

       vscode.window.showInformationMessage(`Opening ${provider} sign-in...`);
       await vscode.env.openExternal(vscode.Uri.parse(oauthUrl));
     }
     ```
   - Add `startEmailAuth()` method for email flow (opens modal - defer to Plan 03)
   - Update `handleCallbackWithToken()` to accept full AuthSession data:
     ```typescript
     async handleCallbackWithToken(session: Omit<AuthSession, 'token' | 'expiresAt'> & { token: string; expiresAt: number }): Promise<boolean>
     ```
   - Update all methods to use `AuthSession` instead of `WalletSession`
   - Add `getAuthType(): 'oauth' | 'wallet' | undefined` method

4. Export both new name and old name for backward compatibility:
   ```typescript
   export { AuthManager };
   export { AuthManager as WalletAuthManager };  // Deprecated, for backward compat
   ```
  </action>
  <verify>
- `npm run build` succeeds
- No TypeScript errors
- Existing tests pass (if any)
  </verify>
  <done>
- AuthManager class supports both OAuth and wallet flows
- AuthSession type includes authType and provider fields
- startOAuth() method implemented for Google/GitHub
- handleCallbackWithToken() accepts full session data
  </done>
</task>

<task type="auto">
  <name>Task 2: Update LicenseValidator for dual auth types</name>
  <files>src/licensing/validator.ts</files>
  <action>
1. Update imports to use AuthManager (not WalletAuthManager)

2. Add method to check license based on auth type:
   ```typescript
   async checkLicense(): Promise<LicenseStatus | null> {
     const session = this.authManager.getSession();
     if (!session || !this.authManager.isAuthenticated()) {
       console.log('License check failed: not authenticated');
       return null;
     }

     if (session.authType === 'wallet') {
       // Existing flow: check NEAR contract
       return this.checkLicenseOnContract(session.userId);
     } else {
       // OAuth flow: check license API
       return this.checkLicenseOnApi(session);
     }
   }
   ```

3. Add `checkLicenseOnApi()` method for OAuth users:
   ```typescript
   private async checkLicenseOnApi(session: AuthSession): Promise<LicenseStatus> {
     const config = vscode.workspace.getConfiguration('specflow');
     const apiUrl = config.get<string>('licenseApiUrl') ?? '...';

     try {
       const response = await fetch(`${apiUrl}/api/license/check`, {
         method: 'GET',
         headers: {
           'Authorization': `Bearer ${session.token}`,
         },
       });

       if (!response.ok) {
         throw new Error(`License check failed: ${response.status}`);
       }

       const data = await response.json() as { isLicensed: boolean; expiresAt: number | null };
       return {
         isLicensed: data.isLicensed,
         expiresAt: data.expiresAt,
         cachedAt: Date.now(),
       };
     } catch (error) {
       console.error('OAuth license check failed:', error);
       return { isLicensed: false, expiresAt: null, cachedAt: Date.now() };
     }
   }
   ```

4. Rename `checkLicenseOnContract()` (was the main logic) for wallet users

5. Update `getAuthenticatedAccountId()` to return userId (works for both types)

6. Add `getAuthType()` method:
   ```typescript
   getAuthType(): 'oauth' | 'wallet' | undefined {
     return this.authManager.getAuthType();
   }
   ```
  </action>
  <verify>
- `npm run build` succeeds
- LicenseValidator compiles without errors
  </verify>
  <done>
- checkLicense() routes to correct backend based on auth type
- checkLicenseOnApi() calls Worker /api/license/check endpoint
- getAuthType() exposed for UI decisions
  </done>
</task>

<task type="auto">
  <name>Task 3: Update extension.ts commands and URI handler</name>
  <files>src/extension.ts, src/licensing/phaseGate.ts</files>
  <action>
1. Update extension.ts URI handler to handle OAuth callbacks:
   ```typescript
   // In handleUri:
   if (uri.path === '/auth-callback') {
     const params = new URLSearchParams(uri.query);

     // Check for error
     const error = params.get('error');
     if (error) {
       vscode.window.showErrorMessage(`Authentication failed: ${error}`);
       return;
     }

     // Parse session data (both OAuth and wallet callbacks send these)
     const userId = params.get('user_id') ?? params.get('account_id');
     const authType = params.get('auth_type') as 'oauth' | 'wallet' ?? 'wallet';
     const provider = params.get('provider') as any ?? 'near';
     const token = params.get('token');
     const expiresAt = params.get('expires_at');
     const displayName = params.get('display_name');
     const email = params.get('email');

     if (userId && token && expiresAt && licenseValidator) {
       const success = await licenseValidator.handleAuthCallbackWithToken({
         userId,
         authType,
         provider,
         token,
         expiresAt: parseInt(expiresAt, 10),
         displayName: displayName ?? undefined,
         email: email ?? undefined,
       });

       if (success) {
         await licenseValidator.checkLicense();
       }
     }
   }
   ```

2. Update command registration in extension.ts:
   - Rename `specflow.connectWallet` → `specflow.connect` (keep old as alias)
   - Rename `specflow.disconnectWallet` → `specflow.disconnect` (keep old as alias)
   ```typescript
   // New unified connect command
   const connectCommand = vscode.commands.registerCommand(
     'specflow.connect',
     async () => {
       if (licenseValidator) {
         // Show quick pick with auth options
         const option = await vscode.window.showQuickPick([
           { label: 'Google', description: 'Sign in with Google', provider: 'google' },
           { label: 'GitHub', description: 'Sign in with GitHub', provider: 'github' },
           { label: 'NEAR Wallet', description: 'Sign in with NEAR wallet', provider: 'wallet' },
         ], { placeHolder: 'Choose sign-in method' });

         if (option) {
           if (option.provider === 'wallet') {
             await licenseValidator.startAuth();
           } else {
             await licenseValidator.getAuthManager().startOAuth(option.provider as 'google' | 'github');
           }
         }
       }
     }
   );
   ```

3. Update package.json commands:
   - Add `specflow.connect` with title "SpecFlow: Connect"
   - Add `specflow.disconnect` with title "SpecFlow: Disconnect"
   - Keep old commands as aliases for backward compatibility

4. Update phaseGate.ts:
   - Update `connectWallet()` to use AuthManager
   - Update `disconnectWallet()` to use AuthManager
   - Keep function names for backward compat, they now call unified auth
  </action>
  <verify>
- `npm run build` succeeds
- Command palette shows "SpecFlow: Connect" and "SpecFlow: Disconnect"
- URI handler compiles without errors
  </verify>
  <done>
- Connect command shows auth method picker
- OAuth providers trigger startOAuth() flow
- URI handler accepts both OAuth and wallet callbacks
- Commands renamed with backward-compatible aliases
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npx tsc --noEmit` passes
- [ ] "SpecFlow: Connect" command shows in command palette
- [ ] "SpecFlow: Disconnect" command shows in command palette
- [ ] No runtime errors when extension loads
</verification>

<success_criteria>
- All 3 tasks completed
- AuthManager class handles both OAuth and wallet flows
- LicenseValidator routes to correct license store based on auth type
- Commands renamed to unified "Connect" / "Disconnect"
- URI handler accepts OAuth callback parameters
</success_criteria>

<output>
After completion, create `.planning/phases/01.5.2-dual-auth/01.5.2-02-SUMMARY.md`:

# Phase 01.5.2 Plan 02: Extension Auth Flow Updates Summary

**[Substantive one-liner describing unified auth manager and command updates]**

## Accomplishments
- [Key outcomes]

## Files Created/Modified
- [List with descriptions]

## Decisions Made
- [Any decisions during implementation]

## Issues Encountered
- [Problems and resolutions, or "None"]

## Next Step
Ready for 01.5.2-03-PLAN.md (Stripe flow updates)

---
*Phase: 01.5.2-dual-auth*
*Completed: [date]*
</output>
