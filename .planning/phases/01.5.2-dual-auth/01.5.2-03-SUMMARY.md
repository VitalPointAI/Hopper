# Phase 01.5.2 Plan 03: Stripe Flow Updates Summary

**OAuth-compatible Stripe checkout flow with dual license store routing for OAuth (KV) and wallet (NEAR contract) users.**

## Accomplishments

- Created `/api/license/check` endpoint for OAuth users to check license status from USER_LICENSES KV
- Updated checkout handler to accept both JWT auth (OAuth) and near_account_id (wallet)
- Created `oauth-license-store.ts` service with grant/revoke/check functions for KV-based licenses
- Updated webhook handler to route license grants based on auth_type metadata
- Modernized upgrade modal to work with AuthSession interface (supports unauthenticated users)

## Files Created/Modified

### Created
- `workers/license-api/src/handlers/license-check.ts` - OAuth license check endpoint with JWT verification
- `workers/license-api/src/services/oauth-license-store.ts` - KV-based license management for OAuth users

### Modified
- `workers/license-api/src/index.ts` - Added `/api/license/check` route
- `workers/license-api/src/handlers/checkout.ts` - Dual auth support (JWT and near_account_id)
- `workers/license-api/src/handlers/stripe-webhook.ts` - Routes to KV or NEAR contract based on auth_type
- `src/licensing/upgradeModal.ts` - Accepts AuthSession | null, triggers auth flow when needed

## Decisions Made

1. **JWT verification pattern**: Reused HMAC-SHA256 pattern from admin-wallet-auth.ts for consistency
2. **Metadata strategy**: Added `auth_type` and `user_id` to customer/subscription metadata for webhook routing
3. **Backward compatibility**: Preserved `near_account_id` field for existing wallet users
4. **Crypto payments**: Require NEAR wallet (OAuth users must use card payments)
5. **Pending payment state**: Stored in globalState for resumption after auth callback

## Technical Details

### License Check Endpoint
- Verifies JWT signature using ADMIN_SECRET
- Returns `{ isLicensed: boolean, expiresAt: number | null }`
- Wallet users receive guidance to check NEAR contract directly

### Checkout Flow
```
OAuth User:
  Headers: Authorization: Bearer {jwt}
  -> Creates customer with auth_type: 'oauth', user_id: 'oauth:{provider}:{id}'

Wallet User:
  Body: { nearAccountId: 'account.near' }
  -> Creates customer with auth_type: 'wallet', near_account_id, user_id
```

### Webhook Routing
```
invoice.paid -> customer metadata
  if auth_type === 'oauth':
    grantOAuthLicense(USER_LICENSES, userId, days)
  else:
    grantLicense(NEAR contract, nearAccountId, days)
```

## Issues Encountered

None.

## Commits

| Task | Commit |
|------|--------|
| Task 1: License check endpoint | `5ca2e0b` |
| Task 2: Checkout handler | `2cefafd` |
| Task 3: Webhook handler | `978d128` |
| Task 4: Upgrade modal | `f320de4` |

## Next Step

Ready for 01.5.2-04-PLAN.md (Testing and validation)

---
*Phase: 01.5.2-dual-auth*
*Completed: 2026-01-15*
