---
phase: 07-planning-depth
plan: 03
type: feature
subsystem: generators
requires:
  - phase: 07-02
    provides: Config selection and persistence
provides:
  - Depth-aware PROJECT.md prompts
  - Depth-aware ROADMAP.md prompts
  - Depth-aware PLAN.md prompts
affects: [newProject, createRoadmap, planPhase]
---

# Plan 07-03: Depth-Aware Prompts

## Objective

<objective>
Modify the LLM prompts used in /new-project, /create-roadmap, and /plan-phase to vary their detail level based on the configured planning depth (quick/standard/comprehensive).
</objective>

## Tasks

<tasks>
<task type="auto" id="1">
  <name>Create depth-aware prompt templates</name>
  <files>src/config/prompts.ts</files>
  <action>
Create src/config/prompts.ts with prompt modifier functions:

getProjectExtractionPrompt(depth: PlanningDepth): string
- quick: Request only name, description, coreValue, 3-5 requirements
- standard: Full extraction with requirements, outOfScope, constraints
- comprehensive: Full extraction plus: risks, assumptions, stakeholders, success metrics

getPhaseExtractionPrompt(depth: PlanningDepth): string
- quick: Target 2-4 phases, minimal dependencies, no research flags
- standard: Target 3-8 phases, dependencies, research flags where needed
- comprehensive: Target 5-12 phases, detailed dependencies, research topics, milestones

getPlanGenerationPrompt(depth: PlanningDepth): string
- quick: 2-3 tasks per plan, minimal verification, no checkpoints
- standard: 3-5 tasks per plan, verification criteria, checkpoints for significant tasks
- comprehensive: 4-7 tasks per plan, detailed verification, checkpoints after each major task, TDD guidance

Each function returns the full prompt string with depth-specific instructions embedded.
  </action>
  <verify>All three prompt functions return appropriate content for each depth</verify>
  <done>Functions compile and return different prompts per depth level</done>
</task>

<task type="auto" id="2">
  <name>Update /new-project with depth-aware prompt</name>
  <files>src/chat/commands/newProject.ts</files>
  <action>
Modify handleNewProject to use depth-aware prompt:

1. Import getProjectExtractionPrompt from '../../config/prompts'
2. Import ConfigManager from '../../config'
3. Before LLM extraction:
   a. Check if .planning/config.json exists
   b. If exists, load config and get planningDepth
   c. If not exists, use 'standard' as default
4. Replace hardcoded EXTRACTION_PROMPT with:
   const extractionPrompt = getProjectExtractionPrompt(depth);
5. Use extractionPrompt in the messages array

Note: For new projects, config won't exist yet at extraction time. Use 'standard' as initial prompt depth, then let user select final depth after PROJECT.md creation.
  </action>
  <verify>/new-project uses standard depth by default</verify>
  <done>Extraction prompt varies based on configured depth</done>
</task>

<task type="auto" id="3">
  <name>Update /create-roadmap with depth-aware prompt</name>
  <files>src/chat/commands/createRoadmap.ts</files>
  <action>
Modify handleCreateRoadmap to use depth-aware prompt:

1. Import getPhaseExtractionPrompt from '../../config/prompts'
2. Import ConfigManager from '../../config'
3. At start of function (after workspace check):
   a. Create ConfigManager with workspaceUri
   b. Load config (will return defaults if missing)
   c. Get planningDepth from config
4. Replace hardcoded PHASE_EXTRACTION_PROMPT with:
   const phasePrompt = getPhaseExtractionPrompt(config.planningDepth);
5. Use phasePrompt in the messages array
6. Show depth indicator in output:
   stream.markdown(`**Planning depth:** ${config.planningDepth}\n\n`);
  </action>
  <verify>/create-roadmap generates phases appropriate to depth</verify>
  <done>Quick depth generates fewer phases, comprehensive generates more</done>
</task>

<task type="auto" id="4">
  <name>Update config module exports</name>
  <files>src/config/index.ts</files>
  <action>
Update src/config/index.ts to re-export:
- getProjectExtractionPrompt from './prompts'
- getPhaseExtractionPrompt from './prompts'
- getPlanGenerationPrompt from './prompts'
  </action>
  <verify>All prompt functions exported from config module</verify>
  <done>Import { getPlanGenerationPrompt } from './config' works</done>
</task>

<task type="checkpoint:human-verify" id="5">
  <what-built>Depth-aware prompts for project, roadmap, and plan generation</what-built>
  <how-to-verify>
    1. Set quick depth in .planning/config.json and run /create-roadmap
    2. Verify fewer phases generated (2-4)
    3. Set comprehensive depth and run /create-roadmap
    4. Verify more phases with research topics (5-12)
    5. Run npm run compile to verify no type errors
  </how-to-verify>
  <resume-signal>Mark approved to continue</resume-signal>
</task>
</tasks>

## Verification

<verification>
- [ ] npm run compile succeeds
- [ ] src/config/prompts.ts exports all three prompt functions
- [ ] Quick depth produces minimal output
- [ ] Standard depth produces balanced output
- [ ] Comprehensive depth produces detailed output
- [ ] /create-roadmap shows planning depth indicator
</verification>

## Success Criteria

<success-criteria>
- Prompts vary meaningfully based on planning depth
- Quick depth suitable for rapid prototyping
- Comprehensive depth suitable for enterprise projects
- Existing commands work with default depth
- Depth selection propagates to all planning commands
</success-criteria>
