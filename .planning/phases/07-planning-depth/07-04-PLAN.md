---
phase: 07-planning-depth
plan: 04
type: feature
subsystem: executor
requires:
  - phase: 07-03
    provides: Depth-aware prompts
provides:
  - Execution mode gating
  - Task confirmation flow
  - Mode-aware checkpoint behavior
affects: [executePlan]
---

# Plan 07-04: Gate Implementation

## Objective

<objective>
Implement execution mode gating in /execute-plan so that yolo mode auto-executes all tasks, guided mode pauses only at explicit checkpoints, and manual mode confirms before every task.
</objective>

## Tasks

<tasks>
<task type="auto" id="1">
  <name>Create execution gate helpers</name>
  <files>src/config/executionGates.ts</files>
  <action>
Create src/config/executionGates.ts with gate helper functions:

shouldPauseAtCheckpoint(mode: ExecutionMode, checkpointType: 'human-verify' | 'decision'): boolean
- yolo: Always return false (skip all checkpoints)
- guided: Return true for all checkpoint types
- manual: Return true for all checkpoint types

shouldConfirmTask(mode: ExecutionMode, taskType: 'auto' | 'checkpoint:human-verify' | 'checkpoint:decision'): boolean
- yolo: Always return false
- guided: Return false for 'auto', true for checkpoints
- manual: Return true for all task types

confirmTaskExecution(task: AutoExecutionTask, stream: vscode.ChatResponseStream): Promise<boolean>
- Show task preview: name, files, action summary (first 100 chars)
- Display "Execute" and "Skip" buttons
- Return true if Execute clicked, false if Skip clicked
- Use vscode.window.showInformationMessage with modal: true for confirmation

getModeDescription(mode: ExecutionMode): string
- Return user-friendly description for the current mode
- yolo: "Auto-executing all tasks without confirmation"
- guided: "Pausing at checkpoints for review"
- manual: "Confirming each task before execution"
  </action>
  <verify>Gate functions return correct values for each mode</verify>
  <done>All gate helpers compile and export correctly</done>
</task>

<task type="auto" id="2">
  <name>Integrate gates into /execute-plan</name>
  <files>src/chat/commands/executePlan.ts</files>
  <action>
Modify handleExecutePlan to respect execution mode:

1. Import ConfigManager and gate functions from '../../config'
2. After loading plan (after parsePlanMd succeeds):
   a. Create ConfigManager with workspaceUri
   b. Load config to get executionMode
   c. Show mode indicator: stream.markdown(`**Execution mode:** ${getModeDescription(config.executionMode)}\n\n`);

3. Modify checkpoint handling (isCheckpointVerify/isCheckpointDecision blocks):
   a. Call shouldPauseAtCheckpoint(config.executionMode, checkpointType)
   b. If false (yolo mode), auto-approve and continue
   c. If true, render checkpoint UI as before

4. For manual mode - add confirmation before auto tasks:
   a. Before executing an auto task, check shouldConfirmTask(config.executionMode, task.type)
   b. If true, show task preview with "Execute this task?" prompt
   c. If user declines, skip task and mark as skipped in results
   d. Track skipped tasks separately in results array

5. Update completion summary to show skipped task count for manual mode
  </action>
  <verify>/execute-plan behaves differently per execution mode</verify>
  <done>yolo skips checkpoints, guided pauses at checkpoints, manual confirms each task</done>
</task>

<task type="auto" id="3">
  <name>Update config module exports</name>
  <files>src/config/index.ts</files>
  <action>
Update src/config/index.ts to re-export:
- shouldPauseAtCheckpoint from './executionGates'
- shouldConfirmTask from './executionGates'
- confirmTaskExecution from './executionGates'
- getModeDescription from './executionGates'
  </action>
  <verify>All gate functions exported from config module</verify>
  <done>Import { shouldPauseAtCheckpoint } from './config' works</done>
</task>

<task type="checkpoint:human-verify" id="4">
  <what-built>Execution mode gating for /execute-plan</what-built>
  <how-to-verify>
    1. Set executionMode: "yolo" in config.json and run /execute-plan
    2. Verify checkpoints are auto-approved without pausing
    3. Set executionMode: "manual" and run /execute-plan
    4. Verify confirmation prompt appears before each task
    5. Test skipping a task and verify it appears in summary
    6. Set executionMode: "guided" and verify normal checkpoint behavior
  </how-to-verify>
  <resume-signal>Mark approved to continue</resume-signal>
</task>
</tasks>

## Verification

<verification>
- [ ] npm run compile succeeds
- [ ] Yolo mode auto-executes without any pauses
- [ ] Guided mode pauses only at explicit checkpoints
- [ ] Manual mode confirms before every task
- [ ] Skipped tasks tracked and shown in summary
- [ ] Mode indicator displayed at execution start
</verification>

## Success Criteria

<success-criteria>
- Execution mode meaningfully affects execution flow
- Yolo mode suitable for trusted, tested plans
- Manual mode provides maximum control for risky changes
- Guided mode balances speed with review points
- Users can change mode anytime via config.json
</success-criteria>
