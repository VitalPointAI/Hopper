---
phase: 10-fix-execution
plan: 01
type: execute
---

<objective>
Fix git staging failure when PLAN.md contains placeholder file paths.

Purpose: The execution flow crashes when `task.files` contains template text like `[Identify affected files from the issue context]` that gets passed to git staging.
Output: Robust execution that validates file paths and handles git errors gracefully.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-fix-execution/10-CONTEXT.md

**Key files:**
@src/chat/executor/planParser.ts
@src/chat/commands/executePlan.ts

**Root cause analysis:**
- planParser.ts:166-175 - `<files>` content is split by comma into array
- If content is `[Identify affected files...]`, array becomes `['[Identify affected files...]']`
- executePlan.ts:1436-1439 - If `task.files.length > 0`, passes to `stageFiles()`
- Git fails because bracket text is not a valid path

**Fix approach:**
1. Filter invalid file paths in planParser.ts (bracket placeholders)
2. Make git failures non-fatal in executePlan.ts (warn, don't crash)
</context>

<tasks>

<task type="auto">
  <name>Filter invalid file paths in plan parser</name>
  <files>src/chat/executor/planParser.ts</files>
  <action>
In the parseTasksXml function, after splitting files by comma (around line 174):

1. Add validation to filter out invalid file paths:
   - Filter out entries that start with `[` (placeholder text like `[Identify affected files...]`)
   - Filter out entries that contain only whitespace
   - Filter out entries that start with `{` (template variables)

2. Update the files assignment:
```typescript
let files: string[] | undefined;
if (filesMatch) {
  const parsed = filesMatch[1].trim().split(/,\s*/).filter(f =>
    f.length > 0 &&
    !f.startsWith('[') &&
    !f.startsWith('{')
  );
  files = parsed.length > 0 ? parsed : undefined;
}
```

This ensures `task.files` is either a valid array of paths or undefined, never placeholder text.
  </action>
  <verify>Read the updated planParser.ts to confirm the validation is in place</verify>
  <done>planParser.ts filters out placeholder file paths, only real paths pass through</done>
</task>

<task type="auto">
  <name>Make git staging failures non-fatal</name>
  <files>src/chat/commands/executePlan.ts</files>
  <action>
In the task completion section (around line 1436-1460), improve git error handling:

1. Add validation BEFORE attempting to stage (belt and suspenders):
```typescript
// Filter to only existing files before staging
const validFiles = task.files.filter(f =>
  !f.startsWith('[') &&
  !f.startsWith('{') &&
  f.trim().length > 0
);

if (isGitRepo && autoCommitEnabled && validFiles.length > 0) {
```

2. In the catch block for git errors (around line 1456-1459), downgrade from error to warning:
   - Already shows `*Git commit failed: ${gitErrorMsg}*` - this is fine
   - Make sure it doesn't re-throw or set task.success = false
   - Log to output channel as warning, not error

3. Ensure the task result still shows success: true even if git failed:
   - Git commit is a side effect, not the core task
   - Task succeeded if LLM completed the work
   - Move the results.push() BEFORE the git block, or ensure git errors don't affect it

The key change: git failures should warn but not fail the task.
  </action>
  <verify>Read the updated executePlan.ts to confirm git error handling is non-fatal</verify>
  <done>Git staging errors produce warnings but don't crash execution; task still marked successful</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] planParser.ts validates file paths (rejects placeholders)
- [ ] executePlan.ts handles git errors gracefully
- [ ] TypeScript compiles without errors: `npm run compile`
- [ ] Extension loads without errors
</verification>

<success_criteria>
- Placeholder text like `[Identify affected files...]` never reaches git staging
- Git staging failures don't crash execution flow
- Tasks complete successfully even if git commit fails
- Phase 10 complete
</success_criteria>

<output>
After completion, create `.planning/phases/10-fix-execution/10-01-SUMMARY.md`
</output>
