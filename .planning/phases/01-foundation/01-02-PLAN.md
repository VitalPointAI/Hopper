---
phase: 01-foundation
plan: 02
type: execute
---

<objective>
Implement the NEAR AI API client using the OpenAI SDK configured for NEAR AI's compatible endpoint.

Purpose: Provide a reusable client that handles authentication and API calls to NEAR AI, abstracted from VSCode-specific code.
Output: Working NEAR AI client module that can be used by the Language Model provider.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md (will exist after Plan 01)

**From research - NEAR AI API details:**
- Endpoint: https://api.near.ai/v1
- Auth: JSON-stringified auth object from ~/.nearai/config.json
- Model format: provider::accounts/provider/models/model-name
- Example model: fireworks::accounts/fireworks/models/qwen2p5-72b-instruct
- OpenAI-compatible: Uses standard chat completions API

**Pitfalls from research:**
- Auth must be JSON.stringify(auth), not just API key
- Config file at ~/.nearai/config.json
- Need fallback for users without config file
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add OpenAI SDK and create client module</name>
  <files>package.json, src/client/nearAiClient.ts, src/client/types.ts</files>
  <action>
1. **Install OpenAI SDK:**
   ```bash
   npm install openai
   ```

2. **Create src/client/types.ts** - Type definitions:
   ```typescript
   export interface NearAiConfig {
     auth: {
       account_id: string;
       public_key: string;
       signature: string;
       // May have additional fields
     };
   }

   export interface NearAiModel {
     id: string;           // e.g., "fireworks::accounts/fireworks/models/qwen2p5-72b-instruct"
     name: string;         // Display name
     provider: string;     // e.g., "fireworks"
     maxInputTokens: number;
     maxOutputTokens: number;
   }
   ```

3. **Create src/client/nearAiClient.ts** - Client wrapper:
   - `createNearAiClient(authSignature: string): OpenAI` - Factory function
   - Base URL: https://api.near.ai/v1
   - API key: The JSON-stringified auth object
   - Export available models as constants (hardcode known models for now)

**Known models to include:**
- fireworks::accounts/fireworks/models/qwen2p5-72b-instruct (Qwen 2.5 72B)
- Add more as discovered

**Avoid:**
- Don't read config file in client module (auth module handles that)
- Don't add streaming helpers here (provider handles that)
- Don't add error handling beyond what OpenAI SDK provides
  </action>
  <verify>
ls -la src/client/
npm run compile
grep -l "api.near.ai" src/client/nearAiClient.ts
  </verify>
  <done>
- src/client/nearAiClient.ts exists with createNearAiClient function
- src/client/types.ts exists with type definitions
- Package.json has openai dependency
- Build succeeds
  </done>
</task>

<task type="auto">
  <name>Task 2: Create auth module for config file handling</name>
  <files>src/auth/nearAuth.ts</files>
  <action>
1. **Create src/auth/nearAuth.ts** - Authentication handling:

```typescript
import * as fs from 'fs';
import * as path from 'path';
import * as os from 'os';
import type { NearAiConfig } from '../client/types';

/**
 * Get auth signature from ~/.nearai/config.json
 * Returns null if file doesn't exist or is invalid
 */
export function getAuthFromConfigFile(): string | null {
  try {
    const configPath = path.join(os.homedir(), '.nearai', 'config.json');
    const configContent = fs.readFileSync(configPath, 'utf-8');
    const config: NearAiConfig = JSON.parse(configContent);

    if (!config.auth) {
      return null;
    }

    // NEAR AI expects JSON-stringified auth object as API key
    return JSON.stringify(config.auth);
  } catch {
    return null;
  }
}

/**
 * Check if NEAR AI auth is configured
 */
export function isAuthConfigured(): boolean {
  return getAuthFromConfigFile() !== null;
}

/**
 * Get config file path for user guidance
 */
export function getConfigFilePath(): string {
  return path.join(os.homedir(), '.nearai', 'config.json');
}
```

2. **Consider VSCode SecretStorage for future:**
   - Add TODO comment for storing auth in VSCode secrets
   - For now, rely on config file (matches nearai CLI behavior)

**Avoid:**
- Don't throw errors for missing config - return null and let caller handle
- Don't import vscode module here - keep auth module pure Node.js for testability
  </action>
  <verify>
ls -la src/auth/
npm run compile
grep -l "config.json" src/auth/nearAuth.ts
  </verify>
  <done>
- src/auth/nearAuth.ts exists
- Exports getAuthFromConfigFile, isAuthConfigured, getConfigFilePath
- Build succeeds
- No vscode imports in auth module
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm install` includes openai dependency
- [ ] `npm run compile` succeeds
- [ ] src/client/ directory has nearAiClient.ts and types.ts
- [ ] src/auth/ directory has nearAuth.ts
- [ ] No TypeScript errors
- [ ] Auth module doesn't import vscode (stays pure Node.js)
</verification>

<success_criteria>

- NEAR AI client module created with factory function
- Auth module handles config file reading
- Types defined for config and models
- Build succeeds
- Ready for provider implementation (Plan 01-03)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
