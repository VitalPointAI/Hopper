---
phase: 01-foundation
plan: 02-FIX
type: fix
---

<objective>
Fix 3 UAT issues from plan 01-02 (NEAR AI API client implementation).

Source: 01-02-ISSUES.md
Priority: 2 blocker, 1 major, 0 minor

The implementation was based on outdated NEAR AI documentation. The current NEAR AI Cloud API uses:
- Base URL: `https://cloud-api.near.ai/v1`
- Standard Bearer token authentication (API keys from dashboard)
- Dynamic model list from `/v1/model/list` endpoint
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/01-foundation/01-02-ISSUES.md

**Original plan for reference:**
@.planning/phases/01-foundation/01-02-PLAN.md

**Updated research with correct API info:**
@.planning/phases/01-foundation/01-RESEARCH.md

**Files to modify:**
@src/client/nearAiClient.ts
@src/client/types.ts
@src/auth/nearAuth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix API base URL and update client module</name>
  <files>src/client/nearAiClient.ts, src/client/types.ts</files>
  <action>
1. **Update base URL in src/client/nearAiClient.ts:**
   - Change from `https://api.near.ai/v1` to `https://cloud-api.near.ai/v1`

2. **Update createNearAiClient function:**
   - Accept `apiKey: string` parameter (standard Bearer token, not JSON-stringified auth)
   - Remove any special auth handling - OpenAI SDK handles Bearer token automatically

3. **Update types.ts:**
   - Remove old NearAiConfig interface (config.json structure no longer needed)
   - Update NearAiModel interface to match API response:
     ```typescript
     export interface NearAiModel {
       modelId: string;              // e.g., "deepseek-ai/DeepSeek-V3.1"
       inputCostPerToken: TokenCost;
       outputCostPerToken: TokenCost;
       metadata: {
         modelDisplayName: string;
         modelDescription: string;
         contextLength: number;
         verifiable: boolean;
         modelIcon?: string;
         ownedBy: string;
         aliases?: string[];
       };
     }

     export interface TokenCost {
       amount: number;
       scale: number;
       currency: string;
     }
     ```

4. **Remove hardcoded NEAR_AI_MODELS constant** - will be fetched dynamically

**Avoid:**
- Don't add model fetching logic here (that's Task 2)
- Keep client module focused on client creation only
  </action>
  <verify>
npm run compile
grep -l "cloud-api.near.ai" src/client/nearAiClient.ts
  </verify>
  <done>
- Base URL is https://cloud-api.near.ai/v1
- createNearAiClient accepts apiKey string parameter
- Types updated to match API response
- Hardcoded models removed
- Build succeeds
  </done>
</task>

<task type="auto">
  <name>Task 2: Add dynamic model fetching</name>
  <files>src/client/nearAiClient.ts</files>
  <action>
1. **Add fetchModels function:**
   ```typescript
   export async function fetchNearAiModels(apiKey: string): Promise<NearAiModel[]> {
     const response = await fetch('https://cloud-api.near.ai/v1/model/list', {
       headers: {
         'Authorization': `Bearer ${apiKey}`,
         'Content-Type': 'application/json'
       }
     });

     if (!response.ok) {
       throw new Error(`Failed to fetch models: ${response.status}`);
     }

     const data = await response.json();
     return data; // Array of NearAiModel
   }
   ```

2. **Export the function** for use by the provider

**Note:** The provider will call this once on activation and cache the results. No caching logic needed in the client module.

**Avoid:**
- Don't add caching here (provider handles that)
- Don't add retry logic (keep simple for now)
  </action>
  <verify>
npm run compile
grep -l "fetchNearAiModels" src/client/nearAiClient.ts
  </verify>
  <done>
- fetchNearAiModels function exists and is exported
- Calls correct endpoint: https://cloud-api.near.ai/v1/model/list
- Uses Bearer token authentication
- Build succeeds
  </done>
</task>

<task type="auto">
  <name>Task 3: Rewrite auth module for API key storage</name>
  <files>src/auth/nearAuth.ts</files>
  <action>
1. **Remove old config.json reading logic entirely**

2. **Create new auth module focused on API key management:**
   ```typescript
   /**
    * NEAR AI Cloud Auth Module
    *
    * Users get API keys from https://cloud.near.ai/ dashboard.
    * Keys are stored in VSCode SecretStorage (handled by extension).
    * This module provides utilities for the extension to use.
    */

   // Secret storage key name
   export const NEAR_AI_API_KEY_SECRET = 'nearai.apiKey';

   /**
    * Validate API key format (basic check)
    * NEAR AI keys appear to be standard format
    */
   export function isValidApiKeyFormat(key: string): boolean {
     return typeof key === 'string' && key.length > 0 && !key.includes(' ');
   }

   /**
    * Get instructions for obtaining API key
    */
   export function getApiKeyInstructions(): string {
     return `To get your NEAR AI API key:
   1. Go to https://cloud.near.ai/
   2. Sign in or create an account
   3. Purchase credits in the "Credits" section
   4. Go to "API Keys" section
   5. Generate a new key
   6. Copy the key and paste it when prompted`;
   }
   ```

3. **Remove all imports of fs, path, os** - no longer reading config files

4. **Keep module pure Node.js** - no vscode imports (extension will use SecretStorage API)

**Avoid:**
- Don't import vscode here - keep testable
- Don't implement SecretStorage operations - extension.ts handles that
- Don't keep any old config.json logic
  </action>
  <verify>
npm run compile
grep -v "config.json" src/auth/nearAuth.ts || echo "No config.json references"
grep -v "fs\|path\|os" src/auth/nearAuth.ts | head -5
  </verify>
  <done>
- Auth module rewritten for API key approach
- No config.json references
- No fs/path/os imports
- Exports NEAR_AI_API_KEY_SECRET constant
- Exports isValidApiKeyFormat and getApiKeyInstructions utilities
- Build succeeds
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run compile` succeeds
- [ ] Base URL is `https://cloud-api.near.ai/v1`
- [ ] No hardcoded models in client module
- [ ] fetchNearAiModels function exists
- [ ] Auth module has no config.json references
- [ ] No TypeScript errors
</verification>

<success_criteria>
- UAT-001 fixed: Auth module uses API key approach (not config.json)
- UAT-002 fixed: Models fetched dynamically (not hardcoded)
- UAT-003 fixed: Correct base URL (cloud-api.near.ai)
- Build succeeds
- Ready for re-verification
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-FIX-SUMMARY.md`

Then update 01-02-ISSUES.md to move issues to "Resolved Issues" section.
</output>
