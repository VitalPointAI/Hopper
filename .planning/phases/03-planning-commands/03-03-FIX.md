---
phase: 03-planning-commands
plan: 03-FIX
type: fix
---

<objective>
Fix 3 UAT issues from plan 03-03.

Source: 03-03-ISSUES.md
Priority: 0 critical, 2 major, 1 minor
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/03-planning-commands/03-03-ISSUES.md

**Original plan for reference:**
@.planning/phases/03-planning-commands/03-03-PLAN.md

**Key source files:**
@src/chat/commands/planPhase.ts
@src/chat/generators/planGenerator.ts
@src/licensing/validator.ts
</context>

<tasks>

<task type="auto">
  <name>Fix UAT-001: Add license gating to /plan-phase</name>
  <files>src/chat/commands/planPhase.ts</files>
  <action>
Add license validation at the start of handlePlanPhase:

1. After workspace check, add license check:
   - Use ctx.licenseValidator.isAuthenticated() first
   - If not authenticated: show "Please connect your NEAR wallet" with button to authenticate
   - If authenticated: use ctx.licenseValidator.checkLicense() to verify Pro license
   - If not licensed: show "Pro license required for /plan-phase" with subscribe button

2. Pattern to follow (from command context):
   ```typescript
   // Check license - /plan-phase requires Pro
   if (!licenseValidator.isAuthenticated()) {
     stream.markdown('## Wallet Connection Required\n\n');
     stream.markdown('Please connect your NEAR wallet to use planning commands.\n\n');
     stream.button({
       command: 'specflow.connectWallet',
       title: 'Connect Wallet'
     });
     return { metadata: { lastCommand: 'plan-phase' } };
   }

   const licenseStatus = await licenseValidator.checkLicense();
   if (!licenseStatus?.isLicensed) {
     stream.markdown('## Pro License Required\n\n');
     stream.markdown('The `/plan-phase` command requires a Pro license.\n\n');
     stream.markdown('**Subscribe to unlock:**\n');
     stream.markdown('- `/plan-phase` - Create detailed execution plans\n');
     stream.markdown('- `/execute-plan` - Execute plans automatically\n');
     stream.markdown('- Full session management features\n\n');
     stream.button({
       command: 'specflow.subscribe',
       title: 'Subscribe'
     });
     return { metadata: { lastCommand: 'plan-phase' } };
   }
   ```

3. Place this check after the workspace folder check (line 216-221) and before the ROADMAP.md check

Avoid: Don't block basic commands like /help, /status, /new-project - only gate Phase 3+ commands.
  </action>
  <verify>
- npm run compile succeeds
- Run /plan-phase without wallet connected - should show wallet connection message
- Run /plan-phase without Pro license - should show subscribe message
  </verify>
  <done>
- License check runs before any plan generation
- Unauthenticated users see wallet connection prompt
- Users without Pro license see subscribe prompt with feature list
- Licensed users proceed normally
  </done>
</task>

<task type="auto">
  <name>Fix UAT-002: Replace GSD references with SpecFlow paths</name>
  <files>src/chat/generators/planGenerator.ts</files>
  <action>
Replace the execution_context section to use SpecFlow-appropriate references:

1. In createPlanMd function (around line 91-95), change:
   ```typescript
   <execution_context>
   ~/.claude/get-shit-done/workflows/execute-phase.md
   ~/.claude/get-shit-done/templates/summary.md
   ~/.claude/get-shit-done/references/checkpoints.md
   </execution_context>
   ```

   To:
   ```typescript
   <execution_context>
   Execute tasks sequentially, committing after each task completion.
   Follow the plan's verification and success criteria.
   Create SUMMARY.md after all tasks complete.
   </execution_context>
   ```

2. This removes external GSD file references since SpecFlow is a standalone extension
3. The execution context now provides inline guidance rather than referencing Claude Code paths

Avoid: Don't add new external file references - keep SpecFlow self-contained.
  </action>
  <verify>
- npm run compile succeeds
- Generate a test plan and verify execution_context contains inline guidance, not GSD paths
  </verify>
  <done>
- execution_context no longer references ~/.claude/get-shit-done
- Generated PLAN.md files are self-contained
- Plans provide inline execution guidance
  </done>
</task>

<task type="auto">
  <name>Fix UAT-003: Show usage help when no argument provided</name>
  <files>src/chat/commands/planPhase.ts</files>
  <action>
Change behavior when no phase argument is provided:

1. Find the section where targetPhaseNum is undefined (around line 288-305)
2. Instead of auto-detecting and defaulting to Phase 1, show usage help:

   Change from:
   ```typescript
   if (targetPhaseNum === undefined) {
     stream.progress('Detecting next unplanned phase...');
     // ... auto-detection logic
     stream.markdown(`No phase specified. Planning for **Phase ${targetPhaseNum}**.\n\n`);
   }
   ```

   To:
   ```typescript
   if (targetPhaseNum === undefined) {
     stream.markdown('## Usage\n\n');
     stream.markdown('**`/plan-phase <phase-number>`**\n\n');
     stream.markdown('Create a detailed execution plan for a specific phase.\n\n');
     stream.markdown('**Examples:**\n');
     stream.markdown('- `/plan-phase 1` - Plan for Phase 1\n');
     stream.markdown('- `/plan-phase 2` - Plan for Phase 2\n');
     stream.markdown('- `/plan-phase 1.5` - Plan for inserted Phase 1.5\n\n');
     stream.markdown('**Available phases:**\n');
     for (const p of phases) {
       stream.markdown(`- Phase ${p.number}: ${p.name}\n`);
     }
     stream.markdown('\n');
     return { metadata: { lastCommand: 'plan-phase' } };
   }
   ```

3. Remove the auto-detection code that defaults to Phase 1

Avoid: Don't silently default - always be explicit about what the command does.
  </action>
  <verify>
- npm run compile succeeds
- Run /plan-phase with no argument - should show usage help, not start planning
  </verify>
  <done>
- Running /plan-phase without argument shows usage help
- Available phases are listed for user reference
- No silent defaulting to Phase 1
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All critical issues fixed
- [ ] All major issues fixed
- [ ] Minor issues fixed or documented as deferred
- [ ] Original acceptance criteria from issues met
- [ ] npm run compile succeeds without errors
</verification>

<success_criteria>
- All UAT issues from 03-03-ISSUES.md addressed
- Tests pass
- Ready for re-verification with /gsd:verify-work 03-03
</success_criteria>

<output>
After completion, create `.planning/phases/03-planning-commands/03-03-FIX-SUMMARY.md`
</output>
