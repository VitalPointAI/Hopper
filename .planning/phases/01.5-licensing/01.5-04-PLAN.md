---
phase: 01.5-licensing
plan: 04
type: execute
---

<objective>
Implement license validation in the VSCode extension with upgrade modal UI and phase gating.

Purpose: Gate Phase 2+ features behind valid license, provide seamless upgrade experience with dual payment options.
Output: License validator, upgrade modal webview, and phase gate integration in extension.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.5-licensing/01.5-RESEARCH.md
@.planning/phases/01.5-licensing/01.5-CONTEXT.md
@.planning/phases/01-foundation/01-03-SUMMARY.md

**Requires from previous plans:**
- 01.5-01: NEAR license contract deployed with is_licensed view method
- 01.5-02: Cloudflare Worker with /api/checkout endpoint
- 01.5-03: Cloudflare Worker with /api/crypto-checkout endpoint

**Existing extension structure (from Phase 1):**
- src/extension.ts - activation entry point
- src/provider/nearAiProvider.ts - Language Model provider
- src/auth/nearAuth.ts - API key management

**From CONTEXT.md essential requirements:**
- Smooth upgrade UX (modal dialog in VSCode, not web redirect)
- Pricing cards showing both options side-by-side
- Seamless post-payment (instant access, no manual steps)
- Gate is solid (Phase 2+ genuinely requires valid license)

**Patterns from research:**
- Cache license status locally with TTL (1 hour)
- Use NEAR RPC view_call for is_licensed (no signing needed)
- Webview for modal UI with CSS styling
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create license validator module with caching</name>
  <files>src/licensing/validator.ts, src/licensing/types.ts, src/licensing/nearRpc.ts</files>
  <action>
1. Create src/licensing/types.ts:
   - LicenseStatus interface: { isLicensed: boolean, expiresAt: number | null, cachedAt: number }
   - LicenseConfig: { contractId: string, rpcUrl: string, cacheTtlMs: number }

2. Create src/licensing/nearRpc.ts:
   - viewIsLicensed(accountId: string, config: LicenseConfig) -> Promise<boolean>
   - viewGetExpiry(accountId: string, config: LicenseConfig) -> Promise<number | null>
   - Use fetch() to NEAR RPC with view_call method (no signing needed for view functions)
   - Handle errors gracefully (network issues = treat as not licensed for safety)

3. Create src/licensing/validator.ts:
   - LicenseValidator class with:
     - constructor(config: LicenseConfig, context: vscode.ExtensionContext)
     - checkLicense(nearAccountId: string) -> Promise<LicenseStatus>
     - clearCache(nearAccountId: string) - for forcing refresh after payment
     - Private: licenseCache Map<string, LicenseStatus>
   - Cache logic: if cached and (now - cachedAt) < cacheTtlMs, return cached
   - Default cacheTtlMs: 1 hour (3600000ms)

4. Add configuration to package.json contributes.configuration:
   - specflow.license.contractId (default: "license.specflow.near")
   - specflow.license.nearNetwork ("mainnet" | "testnet")

Read NEAR account ID from extension settings (specflow.nearAccountId) - user sets this.
  </action>
  <verify>npm run compile succeeds, validator module exports correctly</verify>
  <done>License validator calls NEAR contract, caches results, handles errors gracefully</done>
</task>

<task type="auto">
  <name>Task 2: Create upgrade modal webview with pricing cards</name>
  <files>src/licensing/upgradeModal.ts, src/licensing/upgradeModal.html</files>
  <action>
1. Create src/licensing/upgradeModal.html as template string in upgradeModal.ts:
   - Professional modal layout with title "Upgrade to SpecFlow Pro"
   - Two pricing cards side-by-side:
     - Left: Stripe (Fiat) - "$X/month" with "Subscribe" button
     - Right: Crypto - "$Y/month (20% off)" with "Pay with Crypto" button
   - Feature list: "Unlimited phases", "Full GSD workflow", "Priority support"
   - Close button (X) in corner
   - CSS: Modern, clean design matching VSCode's color scheme
   - Use CSS variables for VSCode theme integration (--vscode-* vars)

2. Create src/licensing/upgradeModal.ts:
   - UpgradeModalPanel class extending webview panel pattern
   - show(context: vscode.ExtensionContext, nearAccountId: string) -> void
   - Private: createWebviewPanel() with proper options (enableScripts: true)
   - Handle messages from webview:
     - "stripe-checkout": Open Stripe checkout URL in browser
     - "crypto-checkout": Open crypto checkout flow
     - "close": Dispose panel
   - postMessage to webview: pricing info, checkout URLs

3. Checkout flow:
   - Call Cloudflare Worker /api/checkout with nearAccountId
   - Open returned URL in external browser (vscode.env.openExternal)
   - For crypto: similar flow with /api/crypto-checkout
   - After payment, user returns to VSCode (success_url can deep-link back)

Use vscode.Uri.joinPath for webview resource URIs.
  </action>
  <verify>npm run compile succeeds, modal can be instantiated</verify>
  <done>Upgrade modal shows dual pricing cards, handles checkout button clicks</done>
</task>

<task type="auto">
  <name>Task 3: Integrate phase gate and upgrade prompt</name>
  <files>src/licensing/phaseGate.ts, src/extension.ts, package.json</files>
  <action>
1. Create src/licensing/phaseGate.ts:
   - checkPhaseAccess(phaseNumber: number, validator: LicenseValidator, context: ExtensionContext) -> Promise<boolean>
   - Logic: if phaseNumber <= 1, return true (Phase 1 always free)
   - If phaseNumber > 1, check license
   - If not licensed, show upgrade modal and return false
   - If licensed, return true

2. Update src/extension.ts:
   - Import and instantiate LicenseValidator on activation
   - Export checkPhaseAccess function for use by future chat commands
   - Register command "specflow.showUpgradeModal" for manual trigger

3. Update package.json contributes.commands:
   - Add "specflow.showUpgradeModal" command with title "Upgrade to Pro"

4. Add configuration to package.json contributes.configuration:
   - specflow.nearAccountId: User's NEAR account for license lookup
   - specflow.licenseApiUrl: Cloudflare Worker URL (default prod URL)

5. Wire it together:
   - phaseGate uses validator to check
   - If unlicensed, shows modal via upgradeModal.show()
   - Chat participant (Phase 2) will call checkPhaseAccess before executing

Store API URL as config so users can point to different environments (dev/prod).
  </action>
  <verify>npm run compile succeeds, specflow.showUpgradeModal command is registered</verify>
  <done>Phase gate checks license before Phase 2+, shows upgrade modal if unlicensed</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>License validation system with upgrade modal UI</what-built>
  <how-to-verify>
    1. Run: npm run compile (should succeed)
    2. Press F5 to launch Extension Development Host
    3. Open Command Palette (Cmd+Shift+P / Ctrl+Shift+P)
    4. Run: "SpecFlow: Upgrade to Pro"
    5. Verify: Modal appears with:
       - Professional styling matching VSCode theme
       - Two pricing cards side-by-side (Stripe and Crypto)
       - 20% discount shown on crypto option
       - Close button works
    6. Click "Subscribe" button
    7. Verify: Browser opens (will fail without real Stripe setup, but should attempt)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run compile` succeeds without errors
- [ ] License validator exports and can be imported
- [ ] Upgrade modal renders with correct styling
- [ ] specflow.showUpgradeModal command is registered
- [ ] Phase gate logic correctly allows Phase 1, gates Phase 2+
- [ ] Configuration settings are defined in package.json
</verification>

<success_criteria>

- License validator calls NEAR RPC view function
- License status cached with 1-hour TTL
- Upgrade modal shows professional dual-pricing UI
- Stripe and crypto checkout buttons trigger external URLs
- Phase gate function ready for chat participant integration
- Phase 1 always accessible, Phase 2+ requires valid license
</success_criteria>

<output>
After completion, create `.planning/phases/01.5-licensing/01.5-04-SUMMARY.md`

Include note: "Phase 1.5 complete. License gating ready for Phase 2 chat participant integration."
</output>
