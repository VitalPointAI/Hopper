---
phase: 01.5-licensing
plan: 01
type: execute
---

<objective>
Create NEAR smart contract for license storage with account_id to expiry timestamp mapping.

Purpose: On-chain source of truth for license validation, enabling decentralized license verification.
Output: Compiled WASM contract ready for deployment, with unit tests passing.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.5-licensing/01.5-RESEARCH.md

**Tech stack from research:**
- near-sdk-rs 5.x (modern `near_sdk::store` collections)
- cargo-near for building
- wasm32-unknown-unknown target

**Patterns from research:**
- LookupMap<AccountId, u64> for storage (single char prefix)
- Admin-only grant_license via require! check
- Block timestamp for expiry comparison

**Don't hand-roll:**
- Custom role system (use simple admin check)
- Complex access control (require! + admin pattern sufficient)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NEAR license contract with storage and methods</name>
  <files>contracts/license/Cargo.toml, contracts/license/src/lib.rs</files>
  <action>
Create Rust project structure for NEAR contract:

1. Create contracts/license/Cargo.toml with:
   - near-sdk = "5.6" dependency
   - crate-type = ["cdylib"]
   - Profile release with opt-level = "z", lto = true

2. Create contracts/license/src/lib.rs implementing:
   - LicenseContract struct with LookupMap<AccountId, u64> (prefix "l") and admin: AccountId
   - #[init] new(admin: AccountId) constructor
   - grant_license(account_id, duration_days) - admin only, extends from current or block_timestamp
   - is_licensed(account_id) -> bool - checks expiry > block_timestamp
   - get_expiry(account_id) -> Option<u64> - returns raw expiry timestamp

Use near_sdk::store::LookupMap (NOT deprecated near_sdk::collections).
Use #[near(contract_state)] and #[near] attributes (modern SDK pattern).
Add #[derive(PanicOnDefault)] to prevent uninitialized use.

Duration calculation: duration_days as u64 * 24 * 60 * 60 * 1_000_000_000 (nanoseconds).
  </action>
  <verify>cargo check --manifest-path contracts/license/Cargo.toml succeeds</verify>
  <done>Contract compiles without errors, has all 4 methods implemented</done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests and build WASM</name>
  <files>contracts/license/src/lib.rs</files>
  <action>
1. Add #[cfg(test)] module with unit tests:
   - test_new_initializes_admin: Verify admin is set correctly
   - test_grant_license_by_admin: Admin can grant, is_licensed returns true
   - test_grant_license_unauthorized: Non-admin call panics
   - test_license_expiry: Expired license returns false for is_licensed
   - test_extend_license: Granting to existing account extends from current expiry

2. Set up Rust toolchain and build:
   - rustup target add wasm32-unknown-unknown (if not present)
   - cargo build --manifest-path contracts/license/Cargo.toml --target wasm32-unknown-unknown --release

Use near_sdk::test_utils for testing context setup.
Use VMContextBuilder to set predecessor_account_id and block_timestamp.
  </action>
  <verify>cargo test --manifest-path contracts/license/Cargo.toml passes, target/wasm32-unknown-unknown/release/license.wasm exists</verify>
  <done>All 5 unit tests pass, WASM artifact built successfully</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cargo check --manifest-path contracts/license/Cargo.toml` succeeds
- [ ] `cargo test --manifest-path contracts/license/Cargo.toml` passes all tests
- [ ] `cargo build --manifest-path contracts/license/Cargo.toml --target wasm32-unknown-unknown --release` produces WASM
- [ ] WASM file exists at contracts/license/target/wasm32-unknown-unknown/release/license.wasm
</verification>

<success_criteria>

- Contract has LookupMap storage with admin pattern
- All 4 public methods implemented (new, grant_license, is_licensed, get_expiry)
- Unit tests cover happy path and authorization
- WASM artifact ready for deployment
</success_criteria>

<output>
After completion, create `.planning/phases/01.5-licensing/01.5-01-SUMMARY.md`
</output>
