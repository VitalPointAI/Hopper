---
phase: 01.5-licensing
plan: 05
type: execute
---

<objective>
Create admin dashboard for license and subscription management within the existing Cloudflare Worker.

Purpose: Enable administrative oversight of licenses, subscriptions, revenue metrics, and pricing configuration.
Output: Admin UI served from Cloudflare Pages/Worker with protected routes for dashboard, license management, and pricing.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.5-licensing/01.5-02-PLAN.md
@.planning/phases/01.5-licensing/01.5-03-PLAN.md

**Requires from previous plans:**
- Cloudflare Worker (workers/license-api) with subscription endpoints
- NEAR contract for license storage
- Stripe and crypto subscription tracking in KV
- Subscription management patterns established

**Architecture decision:**
Serve admin UI from the same Cloudflare Worker using:
- Static HTML/JS for simple dashboard (no build step needed)
- Htmx or Alpine.js for interactivity (CDN-loaded, no bundler)
- Protected /admin/* routes with admin authentication

**Admin authentication:**
- Simple approach: shared secret in Authorization header
- Admin secret stored in Worker secret (ADMIN_SECRET)
- Future: upgrade to proper OAuth if needed

**Key features:**
- Dashboard: active licenses, subscription counts, revenue
- License management: search, manual grant, revoke
- Subscription management: view, cancel
- Pricing: update monthly price (stored in KV)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add admin authentication middleware and routes</name>
  <files>workers/license-api/src/middleware/admin-auth.ts, workers/license-api/src/index.ts, workers/license-api/wrangler.toml</files>
  <action>
1. Update workers/license-api/wrangler.toml:
   - Add secret: ADMIN_SECRET
   - Add KV namespace: ADMIN_SETTINGS (for pricing config)

2. Create workers/license-api/src/middleware/admin-auth.ts:
   - adminAuth middleware for Hono
   - Check Authorization header: "Bearer {ADMIN_SECRET}"
   - Return 401 if missing or invalid
   - Allow request to proceed if valid

3. Update workers/license-api/src/index.ts:
   - Create admin router: const admin = new Hono()
   - Apply adminAuth middleware to admin router
   - Mount admin router at /admin/*
   - Add placeholder routes:
     - GET /admin/dashboard
     - GET /admin/licenses
     - GET /admin/subscriptions
     - GET /admin/settings
  </action>
  <verify>wrangler dev --local succeeds, /admin/* returns 401 without auth header</verify>
  <done>Admin routes protected by secret-based authentication</done>
</task>

<task type="auto">
  <name>Task 2: Implement admin API endpoints for data access</name>
  <files>workers/license-api/src/handlers/admin/dashboard.ts, workers/license-api/src/handlers/admin/licenses.ts, workers/license-api/src/handlers/admin/subscriptions.ts, workers/license-api/src/services/admin-stats.ts</files>
  <action>
1. Create workers/license-api/src/services/admin-stats.ts:
   - getSubscriptionStats(env):
     - Count active Stripe subscriptions from SUBSCRIPTIONS KV
     - Count active crypto subscriptions from CRYPTO_SUBSCRIPTIONS KV
     - Calculate monthly revenue (count * price)
     - Return { stripeActive, cryptoActive, totalActive, monthlyRevenue }
   - getLicenseStats(env):
     - Query NEAR contract for total licenses (if contract supports)
     - Or estimate from subscription counts
     - Return { totalLicenses, expiringThisWeek }

2. Create workers/license-api/src/handlers/admin/dashboard.ts:
   - GET /admin/api/stats:
     - Call getSubscriptionStats and getLicenseStats
     - Return JSON with all metrics

3. Create workers/license-api/src/handlers/admin/licenses.ts:
   - GET /admin/api/licenses?search=:
     - Search by nearAccountId prefix
     - Query NEAR contract for license expiry
     - Return { licenses: [{ nearAccountId, expiry, source }] }
   - POST /admin/api/licenses/grant:
     - Accept { nearAccountId, durationDays }
     - Call grantLicense on NEAR contract
     - Return { success, expiry }
   - POST /admin/api/licenses/revoke:
     - Accept { nearAccountId }
     - Set expiry to now on NEAR contract (or 0)
     - Return { success }

4. Create workers/license-api/src/handlers/admin/subscriptions.ts:
   - GET /admin/api/subscriptions?type=stripe|crypto:
     - List subscriptions from appropriate KV
     - Return { subscriptions: [...] }
   - POST /admin/api/subscriptions/cancel:
     - Accept { nearAccountId, type }
     - Cancel via Stripe API or NEAR Intents
     - Return { success, activeUntil }
  </action>
  <verify>wrangler dev --local succeeds, admin API endpoints return data</verify>
  <done>Admin API endpoints provide stats, license management, subscription management</done>
</task>

<task type="auto">
  <name>Task 3: Create admin dashboard UI with htmx</name>
  <files>workers/license-api/src/handlers/admin/ui.ts, workers/license-api/src/admin-ui/dashboard.html, workers/license-api/src/admin-ui/licenses.html, workers/license-api/src/admin-ui/subscriptions.html, workers/license-api/src/admin-ui/settings.html</files>
  <action>
1. Create workers/license-api/src/admin-ui/ directory with HTML templates:

2. Create dashboard.html:
   - Simple HTML with htmx for dynamic updates
   - Stats cards: Active Licenses, Stripe Subs, Crypto Subs, Monthly Revenue
   - Use hx-get="/admin/api/stats" hx-trigger="load" to fetch data
   - Tailwind CSS via CDN for styling

3. Create licenses.html:
   - Search input with hx-get="/admin/api/licenses?search=" hx-trigger="keyup"
   - Table of licenses with nearAccountId, expiry, actions
   - Grant license form: nearAccountId input, duration dropdown, submit button
   - Revoke button with confirmation

4. Create subscriptions.html:
   - Tabs for Stripe / Crypto subscriptions
   - Table with nearAccountId, status, nextCharge, actions
   - Cancel button with confirmation

5. Create settings.html:
   - Pricing form: monthly price input
   - Save button that POSTs to /admin/api/settings/pricing

6. Create workers/license-api/src/handlers/admin/ui.ts:
   - Serve HTML files for /admin/dashboard, /admin/licenses, etc.
   - Include navigation header on all pages
   - Inline the HTML as template literals (avoid file system access in Workers)
  </action>
  <verify>wrangler dev --local succeeds, /admin/dashboard renders HTML with stats</verify>
  <done>Admin dashboard UI with htmx for license/subscription management</done>
</task>

<task type="auto">
  <name>Task 4: Implement pricing configuration endpoint</name>
  <files>workers/license-api/src/handlers/admin/settings.ts, workers/license-api/src/services/pricing.ts</files>
  <action>
1. Create workers/license-api/src/services/pricing.ts:
   - getPricing(env) -> { monthlyUsd, cryptoMonthlyUsd, cryptoDiscount }
     - Read from ADMIN_SETTINGS KV with fallback to env vars
   - setPricing(env, { monthlyUsd }) -> void
     - Write to ADMIN_SETTINGS KV
     - Crypto price auto-calculated: monthlyUsd * (1 - cryptoDiscount)

2. Create workers/license-api/src/handlers/admin/settings.ts:
   - GET /admin/api/settings/pricing:
     - Return current pricing from getPricing()
   - POST /admin/api/settings/pricing:
     - Accept { monthlyUsd }
     - Call setPricing()
     - Return { success, newPricing }

3. Update checkout handlers to use getPricing():
   - Stripe checkout: use dynamic price from KV
   - Crypto subscribe: use calculated crypto price from KV

Note: Stripe price changes require creating new Price objects in Stripe.
For simplicity, store our target price in KV and document that Stripe
Price ID needs manual update in Stripe dashboard when price changes.
  </action>
  <verify>wrangler dev --local succeeds, pricing can be read and updated</verify>
  <done>Pricing configuration stored in KV, admin can update via settings</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] /admin/* routes require ADMIN_SECRET authentication
- [ ] Dashboard shows subscription and license stats
- [ ] License search, grant, and revoke work
- [ ] Subscription listing and cancellation work
- [ ] Pricing can be viewed and updated
- [ ] UI renders with htmx interactivity
- [ ] All admin routes use consistent styling
- [ ] wrangler.toml has ADMIN_SETTINGS KV namespace
</verification>

<success_criteria>

- Admin authentication protects all /admin/* routes
- Dashboard displays key metrics (licenses, subscriptions, revenue)
- License management: search, grant, revoke
- Subscription management: list, cancel
- Pricing configuration stored in KV
- Simple htmx-based UI (no build step)
- All functionality accessible via protected API endpoints
</success_criteria>

<output>
After completion, create `.planning/phases/01.5-licensing/01.5-05-SUMMARY.md`
</output>
