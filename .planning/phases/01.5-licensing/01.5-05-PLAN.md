---
phase: 01.5-licensing
plan: 05
type: execute
---

<objective>
Add admin wallet authentication and read-only API endpoints to the Cloudflare Worker.

Purpose: Enable secure admin access to subscription and license data for dashboard consumption.
Output: Protected /admin/* routes with wallet-based auth and data retrieval endpoints.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Auto-selected based on dependency graph:
@.planning/phases/01.5-licensing/01.5-02-SUMMARY.md
@.planning/phases/01.5-licensing/01.5-03-SUMMARY.md
@.planning/phases/01.5-licensing/01.5-04-SUMMARY.md

# Key files from prior phases:
@workers/license-api/src/index.ts
@workers/license-api/src/types.ts
@workers/license-api/src/services/subscription-store.ts
@workers/license-api/src/services/crypto-subscription-store.ts
@src/licensing/walletAuth.ts

**Tech stack available:**
- Hono web framework on Cloudflare Workers
- KV namespaces: SUBSCRIPTIONS, CRYPTO_SUBSCRIPTIONS, PROCESSED_EVENTS
- NEAR JSON-RPC for contract calls
- @near-js/crypto for signature verification

**Established patterns:**
- Wallet auth: challenge → sign → verify → JWT (from 01.5-04)
- KV storage with nearAccountId keys
- Date-indexed KV for subscription queries

**Constraining decisions:**
- [01.5-04]: Wallet auth required for license operations (prevents account impersonation)
- [01.5-02]: Cloudflare Worker with Hono handles all license API

**Admin authentication design:**
Admin wallet must match the NEAR contract admin account (LICENSE_CONTRACT_ADMIN env var).
Use same challenge/signature pattern from extension wallet auth, adapted for Worker.
Admin JWT grants access to /admin/* routes.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add admin wallet authentication middleware</name>
  <files>workers/license-api/src/middleware/admin-auth.ts, workers/license-api/src/services/admin-wallet-auth.ts, workers/license-api/wrangler.toml, workers/license-api/src/types.ts</files>
  <action>
1. Update workers/license-api/src/types.ts:
   - Add to Env: ADMIN_WALLET (string - the admin NEAR account ID)
   - Add AdminSession interface: { nearAccountId: string, issuedAt: number, expiresAt: number }

2. Update workers/license-api/wrangler.toml:
   - Add ADMIN_WALLET to [vars] with placeholder value
   - Add comment: "# Set to contract admin account (e.g., specflow.testnet)"

3. Create workers/license-api/src/services/admin-wallet-auth.ts:
   - generateAdminChallenge(env): Create random challenge, store in KV with 5-min TTL
   - verifyAdminSignature(env, { nearAccountId, signature, challenge }):
     - Verify nearAccountId matches env.ADMIN_WALLET
     - Verify signature using @near-js/crypto (same pattern as extension)
     - Return { valid: boolean, error?: string }
   - createAdminJwt(nearAccountId): Create JWT with 24-hour expiry using HMAC-SHA256
   - verifyAdminJwt(token): Verify and decode JWT, return AdminSession or null
   - Use env.ADMIN_SECRET as JWT signing key (add to secrets in wrangler.toml comment)

4. Create workers/license-api/src/middleware/admin-auth.ts:
   - adminAuth middleware for Hono:
     - Check Authorization header: "Bearer {jwt}"
     - Call verifyAdminJwt, attach session to context
     - Return 401 if missing/invalid

5. Update workers/license-api/src/index.ts:
   - Add auth routes (NOT protected by adminAuth):
     - GET /admin/auth/challenge - returns { challenge } for wallet to sign
     - POST /admin/auth/verify - accepts { nearAccountId, signature, challenge }, returns { token } or 401
   - Create admin router: const admin = new Hono()
   - Apply adminAuth middleware to admin router
   - Mount admin router at /admin/* (auth routes excluded from middleware)
  </action>
  <verify>wrangler dev --local succeeds, GET /admin/auth/challenge returns challenge, /admin/* routes (except /auth/*) return 401 without valid JWT</verify>
  <done>Admin authentication via wallet signature, JWT-based session for /admin/* routes</done>
</task>

<task type="auto">
  <name>Task 2: Implement admin data API endpoints</name>
  <files>workers/license-api/src/handlers/admin/stats.ts, workers/license-api/src/handlers/admin/licenses.ts, workers/license-api/src/handlers/admin/subscriptions.ts, workers/license-api/src/services/admin-stats.ts</files>
  <action>
1. Create workers/license-api/src/services/admin-stats.ts:
   - getSubscriptionStats(env):
     - List all keys from SUBSCRIPTIONS KV (use list() with cursor pagination)
     - Count active (status === 'active') vs cancelled
     - List all keys from CRYPTO_SUBSCRIPTIONS KV
     - Count active vs cancelled vs past_due
     - Calculate estimated monthly revenue: (stripeActive * 5) + (cryptoActive * 4)
     - Return { stripeActive, stripeCancelled, cryptoActive, cryptoCancelled, cryptoPastDue, estimatedMonthlyRevenue }

2. Create workers/license-api/src/handlers/admin/stats.ts:
   - GET /admin/api/stats:
     - Call getSubscriptionStats(env)
     - Return JSON with all metrics

3. Create workers/license-api/src/handlers/admin/licenses.ts:
   - GET /admin/api/licenses:
     - Accept query param: search (nearAccountId prefix)
     - List keys from SUBSCRIPTIONS KV matching prefix
     - List keys from CRYPTO_SUBSCRIPTIONS KV matching prefix
     - For each match, query NEAR contract for current license status (is_licensed, get_expiry)
     - Return { licenses: [{ nearAccountId, expiry, source: 'stripe'|'crypto', subscriptionStatus }] }
     - Limit to 50 results

4. Create workers/license-api/src/handlers/admin/subscriptions.ts:
   - GET /admin/api/subscriptions:
     - Accept query param: type ('stripe'|'crypto'|'all', default 'all')
     - List subscriptions from appropriate KV namespace(s)
     - Return { subscriptions: [{ nearAccountId, type, status, nextCharge, ... }] }
     - Limit to 100 results

5. Update workers/license-api/src/index.ts:
   - Import and mount admin handlers on admin router:
     - GET /admin/api/stats
     - GET /admin/api/licenses
     - GET /admin/api/subscriptions
  </action>
  <verify>wrangler dev --local succeeds, with valid admin JWT: /admin/api/stats returns counts, /admin/api/licenses returns license data, /admin/api/subscriptions returns subscription list</verify>
  <done>Admin API provides stats, license search, subscription listing - all protected by wallet auth</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] /admin/auth/challenge returns a challenge string
- [ ] /admin/auth/verify accepts valid admin wallet signature and returns JWT
- [ ] /admin/auth/verify rejects non-admin wallet signatures
- [ ] /admin/api/* routes return 401 without valid JWT
- [ ] /admin/api/stats returns subscription counts and revenue estimate
- [ ] /admin/api/licenses returns license data with NEAR contract status
- [ ] /admin/api/subscriptions returns subscription list from KV
- [ ] wrangler.toml has ADMIN_WALLET configured
</verification>

<success_criteria>

- Admin wallet authentication protects /admin/* routes
- Wallet signature verification matches contract admin
- Stats endpoint returns subscription metrics from KV
- License search queries both KV and NEAR contract
- Subscription listing supports filtering by type
- All admin endpoints return proper JSON responses
</success_criteria>

<output>
After completion, create `.planning/phases/01.5-licensing/01.5-05-SUMMARY.md`
</output>
