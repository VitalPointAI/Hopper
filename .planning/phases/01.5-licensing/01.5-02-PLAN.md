---
phase: 01.5-licensing
plan: 02
type: execute
---

<objective>
Create Stripe **recurring subscription** integration with Cloudflare Worker webhook handler that grants and auto-renews licenses on-chain.

Purpose: Enable fiat payment flow where Stripe automatically charges each billing period and updates NEAR contract via auditable serverless function.
Output: Cloudflare Worker with Stripe subscription webhooks, checkout session creation, subscription management, and NEAR contract calls.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.5-licensing/01.5-RESEARCH.md
@.planning/phases/01.5-licensing/01.5-01-PLAN.md

**Requires from 01.5-01:**
- NEAR license contract deployed (or deployable)
- grant_license method callable from backend

**Architecture decision:**
Using Cloudflare Workers for webhook server because:
- Auditable serverless functions (transparent deployment)
- Globally distributed (low latency for webhooks)
- Edge runtime is lightweight and fast
- Wrangler CLI for deployment automation

**Tech stack:**
- Cloudflare Workers with Hono (lightweight web framework)
- stripe npm package (works in Workers)
- Cloudflare KV for subscription tracking and idempotency

**Subscription model:**
- Monthly recurring billing via Stripe Subscriptions
- Each `invoice.paid` event extends license by 30 days on-chain
- Users can cancel anytime, license remains valid until period end
- Subscription state tracked in Cloudflare KV for fast lookups

**Patterns from research:**
- Raw body handling for webhook signature verification
- stripe.webhooks.constructEvent() for signature verification
- Store near_account_id in Stripe customer metadata
- Idempotency via event.id tracking (use Cloudflare KV)

**Key webhook events for subscriptions:**
- `invoice.paid` - Extend license for another billing period
- `customer.subscription.updated` - Handle plan changes
- `customer.subscription.deleted` - Mark subscription ended (license continues until expiry)

**Pitfalls to avoid:**
- Missing customer metadata (can't link payment to NEAR account)
- Duplicate event processing (store processed event IDs in KV)
- Granting wrong duration (must match billing period)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Cloudflare Worker project with Stripe SDK</name>
  <files>workers/license-api/package.json, workers/license-api/wrangler.toml, workers/license-api/src/index.ts, workers/license-api/src/types.ts</files>
  <action>
Create Cloudflare Worker project structure:

1. workers/license-api/package.json with:
   - Dependencies: hono, stripe
   - DevDependencies: wrangler, typescript, @cloudflare/workers-types
   - Scripts: "dev": "wrangler dev", "deploy": "wrangler deploy"

2. workers/license-api/wrangler.toml with:
   - name = "specflow-license-api"
   - main = "src/index.ts"
   - compatibility_date = "2024-01-01"
   - KV namespace bindings:
     - PROCESSED_EVENTS (idempotency)
     - SUBSCRIPTIONS (track stripe_customer_id â†’ near_account_id + status)
   - Secrets: STRIPE_SECRET_KEY, STRIPE_WEBHOOK_SECRET, STRIPE_PRICE_ID
   - Secrets: NEAR_PRIVATE_KEY, LICENSE_CONTRACT_ID, NEAR_NETWORK
   - Vars: NEAR_RPC_URL, LICENSE_DURATION_DAYS = "30"

3. workers/license-api/src/types.ts with:
   - Env interface for Cloudflare bindings (secrets, KV namespaces)
   - SubscriptionRecord type: { nearAccountId, stripeCustomerId, stripeSubscriptionId, status, currentPeriodEnd }
   - CheckoutRequest, WebhookPayload types

4. workers/license-api/src/index.ts with Hono app:
   - POST /webhook/stripe - raw body handling for subscription events
   - POST /api/checkout - JSON body (creates subscription checkout)
   - POST /api/subscription/cancel - Cancel subscription at period end
   - GET /api/subscription/status - Get subscription status
   - GET /api/health - status check
   - Export default { fetch: app.fetch }

Use Hono's c.req.raw for raw body access in webhook handler.

**Future-proofing for admin dashboard:**
Structure the worker to accommodate future admin routes (`/admin/*`). The same worker
will eventually serve admin UI (Cloudflare Pages or static HTML) with routes for:
- Dashboard (revenue, active licenses, subscription metrics)
- License management (search, grant, revoke)
- Subscription management (cancel, refund)
- Pricing updates (stored in KV or D1)
This is planned for 01.5-05 and influences directory structure now.
  </action>
  <verify>cd workers/license-api && npm install && wrangler dev --local succeeds</verify>
  <done>Worker project compiles, routes defined, bindings configured in wrangler.toml</done>
</task>

<task type="auto">
  <name>Task 2: Implement Stripe subscription webhook handler with NEAR contract integration</name>
  <files>workers/license-api/src/handlers/stripe-webhook.ts, workers/license-api/src/services/near-contract.ts, workers/license-api/src/services/idempotency.ts, workers/license-api/src/services/subscription-store.ts</files>
  <action>
1. Create workers/license-api/src/services/near-contract.ts:
   - grantLicense(env, accountId, durationDays) using direct NEAR RPC
   - Sign transaction with NEAR_PRIVATE_KEY from env
   - Call contract.grant_license via JSON-RPC (function_call action)
   - Use NEAR_RPC_URL for network endpoint

Note: near-api-js may not work in Workers - use direct JSON-RPC instead:
   - Create signed transaction manually
   - POST to NEAR_RPC_URL with broadcast_tx_commit

2. Create workers/license-api/src/services/idempotency.ts:
   - isProcessed(kv, eventId) -> Promise<boolean> using KV.get
   - markProcessed(kv, eventId) using KV.put with 7-day expiry

3. Create workers/license-api/src/services/subscription-store.ts:
   - getSubscription(kv, stripeCustomerId) -> SubscriptionRecord | null
   - saveSubscription(kv, record) with TTL matching subscription period
   - updateSubscriptionStatus(kv, stripeCustomerId, status)

4. Create workers/license-api/src/handlers/stripe-webhook.ts:
   - Get raw body from request for signature verification
   - Construct event using stripe.webhooks.constructEventAsync() (async version for Workers)
   - Check idempotency via KV BEFORE processing
   - Handle 'invoice.paid':
     - Extract customer from invoice
     - Get NEAR account from customer metadata
     - Grant license for LICENSE_DURATION_DAYS (30)
     - Update subscription record with new period end
   - Handle 'customer.subscription.updated':
     - Update subscription status in KV
     - Log plan changes
   - Handle 'customer.subscription.deleted':
     - Mark subscription as cancelled in KV
     - License continues until existing expiry (no immediate revoke)
   - Return Response with { received: true }
   - Catch errors, return 400 for signature failures

5. Wire handler into index.ts app.post('/webhook/stripe', ...)
  </action>
  <verify>wrangler dev --local succeeds, handler code compiles correctly</verify>
  <done>Webhook handler processes subscription events, extends license on invoice.paid, tracks subscription state</done>
</task>

<task type="auto">
  <name>Task 3: Implement Stripe subscription checkout and management endpoints</name>
  <files>workers/license-api/src/handlers/checkout.ts, workers/license-api/src/handlers/subscription-manage.ts, workers/license-api/src/index.ts</files>
  <action>
1. Create workers/license-api/src/handlers/checkout.ts:
   - Handler accepting { nearAccountId: string, successUrl: string, cancelUrl: string }
   - Create or retrieve Stripe customer with metadata.near_account_id = nearAccountId
   - Create checkout session with:
     - mode: 'subscription' (NOT 'payment')
     - customer: customer.id
     - line_items: [{ price: env.STRIPE_PRICE_ID, quantity: 1 }]
     - success_url, cancel_url
     - subscription_data: { metadata: { near_account_id: nearAccountId } }
   - Return { sessionId, url } for redirect

2. Create workers/license-api/src/handlers/subscription-manage.ts:
   - cancelSubscription(nearAccountId):
     - Look up subscription by nearAccountId in KV
     - Call stripe.subscriptions.update with cancel_at_period_end: true
     - Return { cancelledAt, activeUntil }
   - getSubscriptionStatus(nearAccountId):
     - Look up subscription in KV
     - Return { status, currentPeriodEnd, cancelAtPeriodEnd }

3. Update index.ts:
   - Wire POST /api/checkout to checkout handler
   - Wire POST /api/subscription/cancel to cancelSubscription
   - Wire GET /api/subscription/status to getSubscriptionStatus

4. Create workers/license-api/.dev.vars.example with all required secrets:
   - STRIPE_SECRET_KEY, STRIPE_WEBHOOK_SECRET, STRIPE_PRICE_ID
   - NEAR_PRIVATE_KEY, LICENSE_CONTRACT_ID, NEAR_NETWORK, NEAR_RPC_URL

5. Add workers/license-api/README.md:
   - Setup instructions for wrangler
   - How to create KV namespaces (PROCESSED_EVENTS, SUBSCRIPTIONS)
   - How to set secrets with wrangler secret put
   - Stripe webhook setup (events to subscribe: invoice.paid, customer.subscription.*)
  </action>
  <verify>wrangler dev --local succeeds, all routes respond</verify>
  <done>Checkout creates subscription, cancel/status endpoints work, documentation complete</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd workers/license-api && npm install` succeeds
- [ ] `wrangler dev --local` starts worker successfully
- [ ] Checkout uses mode: 'subscription' (verified in code)
- [ ] Webhook handles invoice.paid, customer.subscription.updated, customer.subscription.deleted
- [ ] invoice.paid extends license by LICENSE_DURATION_DAYS
- [ ] Customer metadata includes near_account_id (verified in code)
- [ ] Subscription state tracked in SUBSCRIPTIONS KV namespace
- [ ] Cancel endpoint sets cancel_at_period_end (not immediate delete)
- [ ] KV idempotency check exists before processing (verified in code)
- [ ] wrangler.toml has all required bindings including SUBSCRIPTIONS KV
</verification>

<success_criteria>

- Cloudflare Worker project structure complete
- Stripe Subscriptions mode (recurring billing, not one-time)
- invoice.paid extends NEAR contract license by billing period
- Subscription state tracked in Cloudflare KV
- Cancel endpoint allows graceful cancellation at period end
- Status endpoint returns subscription details
- KV-based idempotency prevents duplicate processing
- .dev.vars.example documents all required secrets
</success_criteria>

<output>
After completion, create `.planning/phases/01.5-licensing/01.5-02-SUMMARY.md`
</output>
