---
phase: 01.5-licensing
plan: 02
type: execute
---

<objective>
Create Stripe subscription integration with Cloudflare Worker webhook handler that grants licenses on-chain.

Purpose: Enable fiat payment flow where successful Stripe payments automatically update NEAR contract via auditable serverless function.
Output: Cloudflare Worker with Stripe webhook handling, checkout session creation, and NEAR contract calls.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.5-licensing/01.5-RESEARCH.md
@.planning/phases/01.5-licensing/01.5-01-PLAN.md

**Requires from 01.5-01:**
- NEAR license contract deployed (or deployable)
- grant_license method callable from backend

**Architecture decision:**
Using Cloudflare Workers for webhook server because:
- Auditable serverless functions (transparent deployment)
- Globally distributed (low latency for webhooks)
- Edge runtime is lightweight and fast
- Wrangler CLI for deployment automation

**Tech stack:**
- Cloudflare Workers with Hono (lightweight web framework)
- stripe npm package (works in Workers)
- near-api-js (may need polyfills for Workers runtime)

**Patterns from research:**
- Raw body handling for webhook signature verification
- stripe.webhooks.constructEvent() for signature verification
- Store near_account_id in Stripe customer metadata
- Idempotency via event.id tracking (use Cloudflare KV)

**Pitfalls to avoid:**
- Missing customer metadata (can't link payment to NEAR account)
- Duplicate event processing (store processed event IDs in KV)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Cloudflare Worker project with Stripe SDK</name>
  <files>workers/license-api/package.json, workers/license-api/wrangler.toml, workers/license-api/src/index.ts, workers/license-api/src/types.ts</files>
  <action>
Create Cloudflare Worker project structure:

1. workers/license-api/package.json with:
   - Dependencies: hono, stripe
   - DevDependencies: wrangler, typescript, @cloudflare/workers-types
   - Scripts: "dev": "wrangler dev", "deploy": "wrangler deploy"

2. workers/license-api/wrangler.toml with:
   - name = "specflow-license-api"
   - main = "src/index.ts"
   - compatibility_date = "2024-01-01"
   - KV namespace binding for idempotency: PROCESSED_EVENTS
   - Secrets: STRIPE_SECRET_KEY, STRIPE_WEBHOOK_SECRET, STRIPE_PRICE_ID
   - Secrets: NEAR_PRIVATE_KEY, LICENSE_CONTRACT_ID, NEAR_NETWORK
   - Vars: NEAR_RPC_URL (for direct RPC calls)

3. workers/license-api/src/types.ts with:
   - Env interface for Cloudflare bindings (secrets, KV)
   - CheckoutRequest, WebhookPayload types

4. workers/license-api/src/index.ts with Hono app:
   - POST /webhook/stripe - raw body handling
   - POST /api/checkout - JSON body
   - GET /api/health - status check
   - Export default { fetch: app.fetch }

Use Hono's c.req.raw for raw body access in webhook handler.

**Future-proofing for admin dashboard:**
Structure the worker to accommodate future admin routes (`/admin/*`). The same worker
will eventually serve admin UI (Cloudflare Pages or static HTML) with routes for:
- Dashboard (revenue, active licenses)
- License management (search, grant, revoke)
- Pricing updates (stored in KV or D1)
This is deferred to a future phase but influences directory structure now.
  </action>
  <verify>cd workers/license-api && npm install && wrangler dev --local succeeds</verify>
  <done>Worker project compiles, routes defined, bindings configured in wrangler.toml</done>
</task>

<task type="auto">
  <name>Task 2: Implement Stripe webhook handler with NEAR contract integration</name>
  <files>workers/license-api/src/handlers/stripe-webhook.ts, workers/license-api/src/services/near-contract.ts, workers/license-api/src/services/idempotency.ts</files>
  <action>
1. Create workers/license-api/src/services/near-contract.ts:
   - grantLicense(env, accountId, durationDays) using direct NEAR RPC
   - Sign transaction with NEAR_PRIVATE_KEY from env
   - Call contract.grant_license via JSON-RPC (function_call action)
   - Use NEAR_RPC_URL for network endpoint

Note: near-api-js may not work in Workers - use direct JSON-RPC instead:
   - Create signed transaction manually
   - POST to NEAR_RPC_URL with broadcast_tx_commit

2. Create workers/license-api/src/services/idempotency.ts:
   - isProcessed(kv, eventId) -> Promise<boolean> using KV.get
   - markProcessed(kv, eventId) using KV.put with 7-day expiry

3. Create workers/license-api/src/handlers/stripe-webhook.ts:
   - Get raw body from request for signature verification
   - Construct event using stripe.webhooks.constructEventAsync() (async version for Workers)
   - Check idempotency via KV BEFORE processing
   - Handle 'invoice.paid': Extract customer, get NEAR account from metadata, grant license
   - Handle 'customer.subscription.deleted': Log only
   - Return Response with { received: true }
   - Catch errors, return 400 for signature failures

4. Wire handler into index.ts app.post('/webhook/stripe', ...)
  </action>
  <verify>wrangler dev --local succeeds, handler code compiles correctly</verify>
  <done>Webhook handler processes invoice.paid, calls NEAR contract, uses KV for idempotency</done>
</task>

<task type="auto">
  <name>Task 3: Implement Stripe checkout session creation endpoint</name>
  <files>workers/license-api/src/handlers/checkout.ts, workers/license-api/src/index.ts</files>
  <action>
1. Create workers/license-api/src/handlers/checkout.ts:
   - Handler accepting { nearAccountId: string, successUrl: string, cancelUrl: string }
   - Create or retrieve Stripe customer with metadata.near_account_id = nearAccountId
   - Create checkout session with:
     - mode: 'subscription'
     - customer: customer.id
     - line_items: [{ price: env.STRIPE_PRICE_ID, quantity: 1 }]
     - success_url, cancel_url
   - Return { sessionId, url } for redirect

2. Update index.ts:
   - Wire POST /api/checkout to handler

3. Create workers/license-api/.dev.vars.example with all required secrets:
   - STRIPE_SECRET_KEY, STRIPE_WEBHOOK_SECRET, STRIPE_PRICE_ID
   - NEAR_PRIVATE_KEY, LICENSE_CONTRACT_ID, NEAR_NETWORK, NEAR_RPC_URL

4. Update README or add workers/license-api/README.md:
   - Setup instructions for wrangler
   - How to create KV namespace
   - How to set secrets with wrangler secret put
  </action>
  <verify>wrangler dev --local succeeds, all routes respond</verify>
  <done>Checkout endpoint creates Stripe session linked to NEAR account, documentation complete</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd workers/license-api && npm install` succeeds
- [ ] `wrangler dev --local` starts worker successfully
- [ ] Webhook route handles raw body (verified in code)
- [ ] Checkout route uses JSON body (verified in code)
- [ ] Customer metadata includes near_account_id (verified in code)
- [ ] KV idempotency check exists before processing (verified in code)
- [ ] wrangler.toml has all required bindings
</verification>

<success_criteria>

- Cloudflare Worker project structure complete
- Stripe signature verification using official SDK async method
- invoice.paid triggers NEAR contract grant_license call
- Checkout creates customer with NEAR account in metadata
- KV-based idempotency prevents duplicate processing
- .dev.vars.example documents all required secrets
</success_criteria>

<output>
After completion, create `.planning/phases/01.5-licensing/01.5-02-SUMMARY.md`
</output>
