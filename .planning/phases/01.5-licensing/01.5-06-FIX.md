---
phase: 01.5-licensing
plan: 06-FIX
type: fix
---

<objective>
Fix 3 UAT issues from plan 01.5-06.

Source: 01.5-06-ISSUES.md
Priority: 0 critical, 3 major, 0 minor
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/01.5-licensing/01.5-06-ISSUES.md

**Original plan for reference:**
@.planning/phases/01.5-licensing/01.5-06-PLAN.md

**Key files:**
@workers/license-api/src/handlers/admin/licenses.ts
@workers/license-api/src/handlers/admin/ui.ts
@workers/license-api/src/services/admin-stats.ts
@src/telemetry/telemetryService.ts
</context>

<tasks>

<task type="auto">
  <name>Fix UAT-001: License search can't find directly-granted licenses</name>
  <files>workers/license-api/src/handlers/admin/licenses.ts</files>
  <action>
The license search only queries KV for subscriptions (near: and crypto_sub: prefixes), missing licenses granted directly via admin grant. The on-chain license exists but has no subscription record.

**Root cause:** `handleAdminLicenses` only looks for accounts with subscription records in KV, not on-chain licenses without subscription backing.

**Fix approach:**
1. When a search query is provided, first check if it's a valid NEAR account ID
2. If so, query the contract directly for that specific account's license status
3. If license exists on-chain but no subscription record, include it with source "manual" or "admin"
4. This allows admin to find and verify any license they granted

**Implementation:**
- Add early check: if `search` looks like a complete NEAR account ID (contains `.near`, `.testnet`, or is 64 hex chars)
- Call `queryContractLicense` directly on that account
- If license found on-chain and not already in results, add it with source "admin"
- Continue with existing subscription-based search for additional results
  </action>
  <verify>
1. Run `wrangler dev`
2. Log into admin, go to Licenses page
3. Grant license to a new account (e.g., newtest2.testnet)
4. Search for that account - should appear in results with source "admin"
  </verify>
  <done>Directly-granted licenses appear in search results</done>
</task>

<task type="auto">
  <name>Fix UAT-002: Add cancel button to subscriptions list</name>
  <files>workers/license-api/src/handlers/admin/subscriptions.ts</files>
  <action>
The cancel button is in the UI code but may not be showing. Investigation needed to verify.

**Root cause check:**
1. Look at `subscriptionsFragment` - cancel button is conditional on `sub.status === 'active'`
2. Look at `handleAdminSubscriptions` - verify it returns `status` field properly

**If status field mapping issue:**
- Check how subscription status is being mapped from KV record to response
- Ensure Stripe `status` and crypto `status` are both being passed correctly

**If button is actually there but test missed it:**
- Document that cancel button only shows for active subscriptions
- Ensure the test subscription was active (not cancelled/pending)

Check the handleAdminSubscriptions handler in subscriptions.ts to verify the subscription data is being passed correctly to subscriptionsFragment.
  </action>
  <verify>
1. In wrangler dev, go to /admin/subscriptions
2. Verify active subscriptions have a Cancel button
3. Click Cancel on one, confirm dialog appears
4. After cancel, status changes and button disappears
  </verify>
  <done>Cancel button appears on active subscriptions and works</done>
</task>

<task type="auto">
  <name>Fix UAT-003: Extension telemetry not reaching API</name>
  <files>src/telemetry/telemetryService.ts, src/extension.ts</files>
  <action>
Telemetry shows 0 installs despite active usage. The extension uses `process.env.SPECFLOW_API_URL` which won't work in bundled extension.

**Root cause:** `process.env.SPECFLOW_API_URL` is evaluated at runtime, but VS Code extensions are bundled and env vars aren't available at runtime. The fallback URL `https://license.specflow.dev` may be wrong or not reachable.

**Fix approach:**
1. Change telemetry URL to use configuration API:
   - Read from VS Code settings: `vscode.workspace.getConfiguration('specflow').get('apiUrl')`
   - Use same pattern as the license validator for consistency
2. OR hardcode the correct production URL (simpler, since it rarely changes)

**Implementation:**
- In telemetryService.ts, change:
  ```typescript
  const TELEMETRY_API_URL = process.env.SPECFLOW_API_URL || 'https://license.specflow.dev';
  ```
  To use the same approach as license validator (check extension.ts for pattern).
- Likely need to pass API URL from extension.ts or read from config

Also verify:
- The telemetry endpoint at /api/telemetry is registered in workers/license-api/src/index.ts
- The URL the extension is using matches the deployed worker URL
  </action>
  <verify>
1. Check that trackActivation is called in extension.ts activate()
2. Build extension and run in Extension Development Host
3. Check Worker logs for POST /api/telemetry requests
4. Verify Total Installs count increases on dashboard
  </verify>
  <done>Extension activation events are tracked and visible in dashboard</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All critical issues fixed
- [ ] All major issues fixed
- [ ] Minor issues fixed or documented as deferred
- [ ] Original acceptance criteria from issues met
</verification>

<success_criteria>
- All UAT issues from 01.5-06-ISSUES.md addressed
- License search finds directly-granted licenses
- Cancel button works on subscriptions page
- Telemetry tracking records extension activations
- Ready for re-verification with /gsd:verify-work
</success_criteria>

<output>
After completion, create `.planning/phases/01.5-licensing/01.5-06-FIX-SUMMARY.md`
</output>
