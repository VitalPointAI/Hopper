# Fix Summary: 01.5-02 UAT Issues

**Fix Plan:** 01.5-02-FIX.md
**Completed:** 2026-01-13
**Commit:** `41509e6`

## Issues Resolved

### UAT-002: invoice.paid webhook cannot complete without deployed NEAR contract

**Status:** RESOLVED

**Root Cause:**
The NEAR license contract was built in phase 01.5-01 but never deployed to testnet. The Stripe webhook handler couldn't call `grantLicense()` without a deployed contract.

**Fix Applied:**

1. **Updated contract dependencies** - Upgraded near-sdk from 5.6 to 5.24 for compatibility with cargo-near 0.18.0

2. **Configured Rust toolchain** - Set Rust 1.86 override for contracts/license (cargo-near 0.18.0 requires Rust <1.87 due to WASM bulk memory operation incompatibility)

3. **Deployed contract to testnet** - Used `cargo near deploy` to deploy to specflow.testnet

4. **Initialized contract** - Called `new()` with specflow.testnet as admin

5. **Rewrote near-contract.ts** - Complete rewrite to use @near-js/crypto and @near-js/transactions libraries instead of manual borsh serialization. Key changes:
   - Use `KeyPair.fromString()` for Ed25519 key handling
   - Use `createTransaction()` for proper transaction construction
   - Use `Signature` class with `KeyType.ED25519` for signature wrapping
   - Use `SignedTransaction` class with `.encode()` for borsh serialization

**Technical Details:**

The original implementation attempted to use Web Crypto API for Ed25519 signing, which doesn't work in Cloudflare Workers for signing operations. The fix uses the @near-js libraries which provide their own Ed25519 implementation via tweetnacl.

Files modified:
- `contracts/license/Cargo.toml` - near-sdk 5.6 â†’ 5.24
- `contracts/license/.cargo/config.toml` - Rust 1.86 toolchain override
- `workers/license-api/package.json` - Added @near-js/crypto, @near-js/transactions, borsh
- `workers/license-api/src/services/near-contract.ts` - Complete rewrite

## Verification

All verification criteria from 01.5-02-FIX.md passed:

- [x] Contract deployed to testnet and responds to view calls
- [x] .dev.vars configured with contract credentials
- [x] invoice.paid webhook successfully calls grantLicense()
- [x] Subscription saved to KV after successful payment
- [x] Status endpoint returns subscription data

**On-chain verification:**
```bash
near view specflow.testnet is_licensed '{"account_id": "test.testnet"}'
# Returns: true

near view specflow.testnet get_expiry '{"account_id": "test.testnet"}'
# Returns: timestamp ~30 days in future
```

## Re-verification Status

Ready for `/gsd:verify-work 01.5-02` re-verification.

---

*Phase: 01.5-licensing*
*Fix Plan: 01.5-02-FIX*
*Completed: 2026-01-13*
