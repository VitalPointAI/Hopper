---
phase: 01.5-licensing
plan: 03
subsystem: payments
tags: [near-intents, crypto, subscriptions, cloudflare-workers, cron]

# Dependency graph
requires:
  - phase: 01.5-02
    provides: Cloudflare Worker with Hono app, NEAR contract client, subscription patterns
provides:
  - NEAR Intents crypto subscription service
  - Crypto subscription endpoints (subscribe, confirm, status, cancel)
  - Cloudflare Cron Trigger for recurring charges
  - KV-based subscription storage with date indexing
affects: [01.5-04, deployment, billing]

# Tech tracking
tech-stack:
  added: [@defuse-protocol/one-click-sdk-typescript, @x402/core]
  patterns: [ANY_INPUT swap for recurring deposits, date-indexed KV queries]

key-files:
  created:
    - workers/license-api/src/services/near-intents.ts
    - workers/license-api/src/services/crypto-subscription-store.ts
    - workers/license-api/src/handlers/crypto-subscribe.ts
    - workers/license-api/src/handlers/cron-handler.ts
  modified:
    - workers/license-api/package.json
    - workers/license-api/wrangler.toml
    - workers/license-api/src/types.ts
    - workers/license-api/src/index.ts

key-decisions:
  - "Used ANY_INPUT swap type instead of subscription pre-authorization (SDK limitation)"
  - "Persistent deposit addresses with 1-year deadline for recurring payments"
  - "Date-indexed KV storage for efficient cron subscription queries"
  - "3 retry attempts before auto-cancelling past_due subscriptions"

patterns-established:
  - "Pattern: ANY_INPUT deposits as recurring payment addresses"
  - "Pattern: Secondary KV index by charge date for efficient cron processing"

issues-created: []

# Metrics
duration: 25min
completed: 2026-01-13
---

# Plan 03: NEAR Intents Crypto Subscriptions Summary

**NEAR Intents recurring crypto subscription system using ANY_INPUT deposit addresses with 20% discount and daily cron-triggered charge processing**

## Performance

- **Duration:** 25 min
- **Started:** 2026-01-13T16:15:00Z
- **Completed:** 2026-01-13T16:40:00Z
- **Tasks:** 3
- **Files modified:** 8

## Accomplishments
- Integrated NEAR Intents 1Click SDK for crypto payment processing
- Created persistent deposit addresses for recurring subscription payments
- Implemented full subscription lifecycle (create, confirm, status, cancel)
- Built daily cron trigger for automatic charge processing with retry logic

## Task Commits

Each task was committed atomically:

1. **Task 1: Add NEAR Intents SDK and crypto subscription types** - `0ee69b3` (feat)
2. **Task 2: Implement crypto subscription creation endpoint** - `a657952` (feat)
3. **Task 3: Implement recurring charge scheduler via Cron Trigger** - `61dd65a` (feat)

**Plan metadata:** (this commit) (docs: complete plan)

## Files Created/Modified

**Created:**
- `workers/license-api/src/services/near-intents.ts` - NEAR Intents 1Click SDK integration
- `workers/license-api/src/services/crypto-subscription-store.ts` - KV subscription storage with date indexing
- `workers/license-api/src/handlers/crypto-subscribe.ts` - Subscription endpoints (subscribe, confirm, status, cancel)
- `workers/license-api/src/handlers/cron-handler.ts` - Daily recurring charge processor

**Modified:**
- `workers/license-api/package.json` - Added @defuse-protocol/one-click-sdk-typescript, @x402/core
- `workers/license-api/wrangler.toml` - Added CRYPTO_SUBSCRIPTIONS KV, cron trigger, new vars
- `workers/license-api/src/types.ts` - Added CryptoSubscription and related types
- `workers/license-api/src/index.ts` - Added crypto routes and scheduled handler export

## Decisions Made

1. **Used ANY_INPUT swap type** - The NEAR Intents 1Click SDK does not have native subscription/pre-authorization. Used ANY_INPUT swap type to create persistent deposit addresses that can receive recurring payments over time.

2. **1-year deposit address lifetime** - Set deadline to 1 year for subscription deposit addresses to remain active, allowing long-term recurring payments.

3. **Date-indexed KV storage** - Created secondary index by charge date to efficiently query subscriptions due for processing without scanning all records.

4. **3 retry maximum** - Auto-cancel subscriptions after 3 consecutive failed payment attempts to avoid indefinite past_due states.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing Critical] Adapted to SDK capabilities**
- **Found during:** Task 2 (NEAR Intents service implementation)
- **Issue:** Plan assumed SDK has subscription pre-authorization, but 1Click SDK only supports one-time swaps
- **Fix:** Used ANY_INPUT swap type with long deadline to create persistent deposit addresses for recurring payments
- **Files modified:** workers/license-api/src/services/near-intents.ts
- **Verification:** Types compile, endpoints respond correctly
- **Committed in:** a657952 (Task 2 commit)

---

**Total deviations:** 1 auto-fixed (1 missing critical), 0 deferred
**Impact on plan:** SDK adaptation was necessary for correctness. The ANY_INPUT pattern achieves the same goal of recurring crypto payments with minor UX difference (user sends to deposit address vs pre-authorization).

## Issues Encountered

None beyond the SDK capability adaptation noted above.

## Next Phase Readiness

- Crypto subscription endpoints ready for frontend integration
- Cron trigger configured for daily processing at 6 AM UTC
- KV namespaces defined (IDs need to be created with `wrangler kv:namespace create`)
- NEAR_INTENTS_API_KEY secret needs to be configured in production

---
*Phase: 01.5-licensing*
*Completed: 2026-01-13*
