---
phase: 01.5-licensing
plan: 03
type: execute
---

<objective>
Add x402 crypto payment flow with NEAR Intents for any-token-to-USDC conversion to the Cloudflare Worker.

Purpose: Enable crypto-native payment option with 20% discount, settling to vitalpointai.near as USDC.
Output: Crypto payment endpoints in the license-api worker using x402 protocol and NEAR Intents.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.5-licensing/01.5-RESEARCH.md
@.planning/phases/01.5-licensing/01.5-02-PLAN.md

**Requires from 01.5-02:**
- Cloudflare Worker (workers/license-api) running
- NEAR contract client for granting licenses
- Hono app with existing routes

**Tech stack from research:**
- @x402/core for payment types and verification
- @defuse-protocol/one-click-sdk-typescript for NEAR Intents

**Patterns from research:**
- x402 payment request format for 402 responses
- NEAR Intents 1Click handles cross-chain token swaps
- Payment settles to vitalpointai.near as USDC

**Open questions from research:**
- x402 NEAR native facilitator status unclear - start with Base (USDC)
- NEAR Intents has no testnet - use mainnet with small amounts or mock locally

**Pricing:**
- Fiat: $X/month (from STRIPE_PRICE_ID)
- Crypto: 20% discount = $X * 0.8
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add x402 dependencies and crypto checkout endpoint</name>
  <files>workers/license-api/package.json, workers/license-api/src/handlers/crypto-checkout.ts, workers/license-api/wrangler.toml</files>
  <action>
1. Add dependencies to workers/license-api/package.json:
   - @x402/core (for payment types and verification)

Note: @x402/express is Express-specific; use @x402/core directly for Workers.

2. Update workers/license-api/wrangler.toml with new vars/secrets:
   - CRYPTO_PRICE_USD = "4.00" (20% off $5 example)
   - X402_NETWORK = "base-sepolia" (or "base" for prod)
   - DESTINATION_ADDRESS (EVM address for x402 settlement)
   - NEAR_INTENTS_JWT (for 1Click API auth, if using)

3. Create workers/license-api/src/handlers/crypto-checkout.ts:
   - POST handler accepting { nearAccountId: string }
   - Generate x402-compatible payment request:
     - paymentType: "exact"
     - price: { amount: CRYPTO_PRICE_USD, currency: "USD" }
     - network: X402_NETWORK
     - recipient: DESTINATION_ADDRESS
     - description: "SpecFlow Pro License (30 days)"
     - Extra metadata: { nearAccountId } for linking payment to license
   - Return payment request JSON for client

4. Update src/index.ts to add route:
   - POST /api/crypto-checkout
  </action>
  <verify>npm install && wrangler dev --local succeeds with new routes</verify>
  <done>Crypto checkout endpoint returns x402 payment request with 20% discounted pricing</done>
</task>

<task type="auto">
  <name>Task 2: Implement x402 payment verification callback</name>
  <files>workers/license-api/src/handlers/crypto-callback.ts, workers/license-api/src/services/x402-verify.ts, workers/license-api/src/index.ts</files>
  <action>
1. Create workers/license-api/src/services/x402-verify.ts:
   - verifyPayment(paymentProof, expectedAmount, expectedRecipient) -> boolean
   - Use @x402/core verification functions
   - Check: signature valid, amount >= expected, recipient matches
   - Extract payer address from proof

2. Create workers/license-api/src/handlers/crypto-callback.ts:
   - POST /api/crypto-payment/callback accepting x402 payment proof
   - Parse nearAccountId from proof metadata
   - Call verifyPayment() to validate
   - If valid: call grantLicense(nearAccountId, 30)
   - Return { success: true, license: { days: 30, expiresAt: timestamp } }
   - If invalid: return 400 with error

3. Update workers/license-api/src/index.ts:
   - Add POST /api/crypto-payment/callback route

4. Update .dev.vars.example with crypto config:
   - CRYPTO_PRICE_USD, X402_NETWORK, DESTINATION_ADDRESS

Note: For MVP, the client-side x402 payment flow (wallet connect, transaction signing)
will be handled in the extension (Plan 04). This plan focuses on the server-side
verification and license granting.
  </action>
  <verify>wrangler dev --local succeeds, crypto callback route responds</verify>
  <done>Crypto callback verifies x402 proof and grants license on valid payment</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm install` adds @x402/core package
- [ ] `wrangler dev --local` starts successfully
- [ ] Crypto checkout returns x402-formatted payment request
- [ ] Payment callback verifies proof before granting
- [ ] 20% discount reflected in CRYPTO_PRICE_USD
- [ ] wrangler.toml has crypto-related vars
- [ ] .dev.vars.example includes all crypto configuration
</verification>

<success_criteria>

- x402 payment request generation working
- Payment callback verifies proof signature and amount
- NEAR contract called on successful crypto payment
- 20% crypto discount implemented via CRYPTO_PRICE_USD config
- All crypto endpoints added to existing Cloudflare Worker
</success_criteria>

<output>
After completion, create `.planning/phases/01.5-licensing/01.5-03-SUMMARY.md`
</output>
