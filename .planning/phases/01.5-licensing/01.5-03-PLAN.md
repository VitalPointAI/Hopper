---
phase: 01.5-licensing
plan: 03
type: execute
---

<objective>
Add **recurring crypto subscriptions** using NEAR Intents subscription pattern with x402 for initial payment verification.

Purpose: Enable crypto-native recurring payment option with 20% discount, using pre-authorized NEAR Intents for automatic monthly renewal, settling to vitalpointai.near as USDC.
Output: Crypto subscription endpoints with NEAR Intents pre-authorization, recurring charge scheduler, and license auto-renewal.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01.5-licensing/01.5-RESEARCH.md
@.planning/phases/01.5-licensing/01.5-02-PLAN.md

**Requires from 01.5-02:**
- Cloudflare Worker (workers/license-api) running
- NEAR contract client for granting licenses
- Hono app with existing routes
- Subscription tracking patterns in KV

**NEAR Intents Subscription Pattern:**

The NEAR Intents 1Click API supports a "subscription" flow where users pre-authorize
recurring payments. The pattern works as follows:

1. **Initial Authorization**: User signs a single transaction that creates a
   "subscription intent" with:
   - Monthly amount (e.g., $4 USDC equivalent)
   - Recipient account (vitalpointai.near)
   - Billing day (day of month)
   - Source tokens user approves for conversion

2. **Recurring Execution**: Each billing cycle, our backend calls the 1Click API
   to execute the pre-authorized intent. The API:
   - Converts user's tokens to USDC
   - Transfers to vitalpointai.near
   - Returns success/failure

3. **Failure Handling**: If execution fails (insufficient balance, revoked),
   subscription marked as lapsed, license not extended.

**Tech stack:**
- @defuse-protocol/one-click-sdk-typescript for NEAR Intents
- @x402/core for initial payment verification (optional fallback)
- Cloudflare Workers Cron Triggers for recurring charge execution

**Pricing:**
- Fiat: $5/month (from STRIPE_PRICE_ID)
- Crypto: 20% discount = $4/month USDC equivalent
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add NEAR Intents SDK and crypto subscription types</name>
  <files>workers/license-api/package.json, workers/license-api/src/types.ts, workers/license-api/wrangler.toml</files>
  <action>
1. Add dependencies to workers/license-api/package.json:
   - @defuse-protocol/one-click-sdk-typescript (NEAR Intents 1Click)
   - @x402/core (payment verification, optional fallback)

2. Update workers/license-api/wrangler.toml:
   - Add KV namespace: CRYPTO_SUBSCRIPTIONS (track subscription intents)
   - Add vars:
     - CRYPTO_MONTHLY_USD = "4.00" (20% off $5)
     - NEAR_INTENTS_API_URL = "https://1click.chaindefuser.com"
     - SETTLEMENT_ACCOUNT = "vitalpointai.near"
   - Add secrets:
     - NEAR_INTENTS_API_KEY (for 1Click API auth)
   - Add cron trigger for daily subscription processing:
     ```toml
     [triggers]
     crons = ["0 6 * * *"]  # Run daily at 6 AM UTC
     ```

3. Update workers/license-api/src/types.ts:
   - Add CryptoSubscription type:
     ```typescript
     interface CryptoSubscription {
       nearAccountId: string;
       intentId: string;  // NEAR Intents subscription intent ID
       monthlyAmountUsd: string;
       billingDay: number;  // 1-28
       status: 'active' | 'past_due' | 'cancelled';
       lastChargeDate: string | null;
       nextChargeDate: string;
       createdAt: string;
     }
     ```
  </action>
  <verify>npm install && wrangler dev --local succeeds</verify>
  <done>NEAR Intents SDK installed, subscription types defined, cron trigger configured</done>
</task>

<task type="auto">
  <name>Task 2: Implement crypto subscription creation endpoint</name>
  <files>workers/license-api/src/handlers/crypto-subscribe.ts, workers/license-api/src/services/near-intents.ts, workers/license-api/src/services/crypto-subscription-store.ts, workers/license-api/src/index.ts</files>
  <action>
1. Create workers/license-api/src/services/near-intents.ts:
   - createSubscriptionIntent(nearAccountId, monthlyAmountUsd, billingDay):
     - Call NEAR Intents 1Click API to create subscription intent
     - Return { intentId, authorizationUrl } for user to sign
   - executeSubscriptionCharge(intentId):
     - Call 1Click API to execute pre-authorized charge
     - Return { success, txHash, error }
   - cancelSubscription(intentId):
     - Revoke the subscription intent
     - Return { success }

2. Create workers/license-api/src/services/crypto-subscription-store.ts:
   - saveCryptoSubscription(kv, sub: CryptoSubscription)
   - getCryptoSubscription(kv, nearAccountId) -> CryptoSubscription | null
   - listDueSubscriptions(kv, date) -> CryptoSubscription[]
   - updateCryptoSubscriptionStatus(kv, nearAccountId, status, lastChargeDate)

3. Create workers/license-api/src/handlers/crypto-subscribe.ts:
   - POST /api/crypto/subscribe accepting { nearAccountId: string, billingDay?: number }
   - Default billingDay to current day of month (1-28, cap at 28)
   - Call createSubscriptionIntent() to get authorization URL
   - Save pending subscription to KV
   - Return { intentId, authorizationUrl, monthlyAmount: CRYPTO_MONTHLY_USD }

4. Create POST /api/crypto/subscribe/confirm:
   - Called after user signs authorization
   - Verify intent is authorized via 1Click API
   - Execute first charge immediately
   - If successful: grant 30-day license, mark subscription active
   - Save subscription with next charge date (billingDay next month)
   - Return { success, license: { days: 30, expiresAt } }

5. Update src/index.ts with new routes
  </action>
  <verify>wrangler dev --local succeeds, subscribe endpoint returns authorization URL</verify>
  <done>Crypto subscription creation flow working, first charge executes on confirmation</done>
</task>

<task type="auto">
  <name>Task 3: Implement recurring charge scheduler via Cron Trigger</name>
  <files>workers/license-api/src/handlers/cron-handler.ts, workers/license-api/src/index.ts</files>
  <action>
1. Create workers/license-api/src/handlers/cron-handler.ts:
   - handleScheduled(event, env) for Cloudflare Cron Trigger
   - Get today's date
   - Query CRYPTO_SUBSCRIPTIONS KV for subscriptions due today:
     - status === 'active' AND nextChargeDate <= today
   - For each due subscription:
     - Call executeSubscriptionCharge(intentId)
     - If success:
       - Call grantLicense(nearAccountId, 30)
       - Update lastChargeDate = today
       - Update nextChargeDate = today + 1 month
       - Log success
     - If failure:
       - Mark status = 'past_due'
       - Log failure with reason
       - (License continues until current expiry, but no extension)
   - Return summary of processed subscriptions

2. Add retry logic for past_due subscriptions:
   - If past_due and < 3 retry attempts, try again
   - After 3 failures, mark as 'cancelled'

3. Update src/index.ts to export scheduled handler:
   ```typescript
   export default {
     fetch: app.fetch,
     scheduled: handleScheduled,
   }
   ```

4. Add GET /api/crypto/subscription/status endpoint:
   - Return subscription details for a nearAccountId
   - Include: status, nextChargeDate, monthlyAmount

5. Add POST /api/crypto/subscription/cancel endpoint:
   - Call cancelSubscription(intentId) to revoke on NEAR Intents
   - Mark subscription as 'cancelled' in KV
   - License continues until current expiry
   - Return { cancelledAt, activeUntil }
  </action>
  <verify>wrangler dev --local succeeds, cron handler compiles, management endpoints respond</verify>
  <done>Recurring charges scheduled daily, retry logic for failures, cancel/status endpoints working</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm install` adds @defuse-protocol/one-click-sdk-typescript
- [ ] `wrangler dev --local` starts successfully
- [ ] Subscribe endpoint returns NEAR Intents authorization URL
- [ ] Confirm endpoint executes first charge and grants license
- [ ] Cron handler processes due subscriptions
- [ ] Failed charges marked as past_due with retry
- [ ] Cancel endpoint revokes intent and updates KV
- [ ] Status endpoint returns subscription details
- [ ] 20% discount reflected in CRYPTO_MONTHLY_USD
- [ ] wrangler.toml has cron trigger and CRYPTO_SUBSCRIPTIONS KV
</verification>

<success_criteria>

- NEAR Intents subscription pattern implemented
- Users pre-authorize recurring monthly charges
- Cron trigger executes charges daily for due subscriptions
- Successful charges extend license by 30 days
- Failed charges marked past_due with retry attempts
- Cancel gracefully revokes without immediate license loss
- 20% crypto discount via CRYPTO_MONTHLY_USD config
- All crypto subscription endpoints integrated with existing Worker
</success_criteria>

<output>
After completion, create `.planning/phases/01.5-licensing/01.5-03-SUMMARY.md`
</output>
