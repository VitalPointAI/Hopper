---
phase: 01.5-licensing
plan: 06
subsystem: api, ui
tags: [cloudflare-workers, hono, htmx, near-connect, admin-dashboard]

# Dependency graph
requires:
  - phase: 01.5-05
    provides: Admin wallet authentication, protected API routes, data endpoints
provides:
  - Admin dashboard UI with multi-wallet authentication
  - License grant/revoke action endpoints
  - Subscription cancel action endpoint
  - Crypto payment page with wallet selector
  - Telemetry tracking for conversion rate analytics
affects: [01.5-07-deployment-if-exists]

# Tech tracking
tech-stack:
  added:
    - "@hot-labs/near-connect (multi-wallet connector)"
  patterns: [htmx-spa, nep-413-signature, wallet-selector]

key-files:
  created:
    - workers/license-api/src/handlers/admin/actions.ts
    - workers/license-api/src/handlers/crypto-payment-ui.ts
    - workers/license-api/src/handlers/telemetry.ts
    - workers/license-api/src/services/telemetry-store.ts
    - src/telemetry/telemetryService.ts
  modified:
    - workers/license-api/src/handlers/admin/ui.ts
    - workers/license-api/src/services/admin-wallet-auth.ts
    - workers/license-api/src/handlers/crypto-subscribe.ts
    - workers/license-api/src/handlers/stripe-webhook.ts
    - workers/license-api/src/services/admin-stats.ts
    - workers/license-api/src/index.ts
    - workers/license-api/src/types.ts
    - workers/license-api/wrangler.toml
    - src/extension.ts
    - src/licensing/validator.ts

key-decisions:
  - "near-connect library for multi-wallet support (Meteor, HOT, MyNearWallet, Intear)"
  - "NEP-413 signature verification with Borsh serialization"
  - "Network configuration via NEAR_NETWORK env var (not hardcoded)"
  - "htmx:configRequest event for JWT header injection"
  - "License revoke deferred - contract only supports grant (extend expiry)"
  - "Telemetry uses anonymous hashed machine ID for privacy"
  - "Conversion tracking: install -> login -> upgrade flow"

patterns-established:
  - "near-connect: new NearConnector({network, features}) -> connector.connect() -> signMessage()"
  - "NEP-413: Borsh-encode payload, prepend tag (2^31+413), SHA-256 hash, verify signature"
  - "htmx auth: Add event listener BEFORE htmx.js loads to catch configRequest events"
  - "Crypto payment: Redirect to /pay/:intentId page with wallet selector"

issues-created: []

# Metrics
duration: ~45min
completed: 2026-01-14
---

# Phase 01.5 Plan 06: Admin Dashboard UI Summary

**Admin dashboard with multi-wallet authentication via near-connect and crypto payment wallet selector**

## Performance

- **Duration:** ~45 min (including debugging)
- **Completed:** 2026-01-14
- **Tasks:** 2 main + 2 additional (near-connect integration)
- **Files created:** 2
- **Files modified:** 6
- **Commits:** 8

## Accomplishments

- Admin dashboard with htmx/Tailwind CSS served from Worker
- Multi-wallet authentication via @hot-labs/near-connect
- NEP-413 signature verification (Borsh serialization + SHA-256)
- License management: search and grant functionality
- Subscription management: listing and cancellation
- Crypto payment page at /pay/:intentId with wallet selector
- Dynamic network configuration from NEAR_NETWORK env var
- Telemetry tracking for conversion analytics (installs, logins, upgrades)
- Dashboard displays conversion rate metrics (Total Installs, Logged In, Pro Users, Conversion %)

## Task Commits

1. **feat(01.5-06): implement admin action endpoints** - `ed3e47a`
2. **feat(01.5-06): implement admin dashboard HTML UI** - `5b94c9d`
3. **fix(01.5-06): use Meteor Wallet for admin login** - `a882e0b`
4. **fix(01.5-06): use Meteor Wallet injected provider directly** - `4d9b135`
5. **feat(01.5-06): integrate near-connect for multi-wallet support** - `656bf7d`
6. **fix(01.5-06): use correct near-connect API methods** - `a7691b5`
7. **fix(01.5-06): use testnet network for near-connect** - `77c84f4`
8. **fix(01.5-06): read NEAR network from environment config** - `d92571e`
9. **fix(01.5-06): implement NEP-413 signature verification** - `35f1a24`
10. **fix(01.5-06): fix htmx auth header timing and ADMIN_SECRET requirement** - `d195349`

## Files Created/Modified

### Created
- `workers/license-api/src/handlers/admin/actions.ts` - POST endpoints for grant, revoke, cancel
- `workers/license-api/src/handlers/crypto-payment-ui.ts` - /pay/:intentId page with near-connect wallet selector
- `workers/license-api/src/handlers/telemetry.ts` - POST /api/telemetry endpoint for extension events
- `workers/license-api/src/services/telemetry-store.ts` - KV storage for installation/conversion tracking
- `src/telemetry/telemetryService.ts` - VS Code extension telemetry client

### Modified
- `workers/license-api/src/handlers/admin/ui.ts` - Dashboard with conversion metrics cards
- `workers/license-api/src/services/admin-wallet-auth.ts` - NEP-413 verification, Borsh serialization
- `workers/license-api/src/services/admin-stats.ts` - Includes telemetry stats in dashboard data
- `workers/license-api/src/handlers/crypto-subscribe.ts` - Returns /pay/:intentId URL, marks upgrade
- `workers/license-api/src/handlers/stripe-webhook.ts` - Marks upgrade on subscription creation
- `workers/license-api/src/index.ts` - Admin UI routes, telemetry route
- `workers/license-api/src/types.ts` - TELEMETRY KV namespace, telemetry types
- `workers/license-api/wrangler.toml` - TELEMETRY KV binding
- `src/extension.ts` - Calls trackActivation on activate
- `src/licensing/validator.ts` - Calls trackLogin/trackUpgrade

## Decisions Made

- **near-connect over Meteor-only**: User requested multi-wallet support
- **NEP-413 standard**: Wallets sign SHA-256 hash of Borsh-encoded payload, not raw message
- **NEAR_NETWORK env var**: Network must be configurable for testnet/mainnet switching
- **htmx:configRequest timing**: Event listener must be registered before htmx.js loads
- **License revoke deferred**: Contract only has grant_license; revoke would need contract update

## Issues Encountered & Fixed

1. **connector.openModal not a function**: near-connect uses `connector.connect()`, not `openModal()`
2. **Wrong network (mainnet)**: Changed to read from `c.env.NEAR_NETWORK`
3. **Invalid signature (401)**: Implemented full NEP-413 verification with Borsh serialization
4. **500 Internal Server Error**: ADMIN_SECRET env var was missing in .dev.vars
5. **401 on htmx requests**: Event listener setup was after htmx loaded; moved script order

## API Endpoints Added

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/admin/api/licenses/grant` | POST | Grant license to NEAR account |
| `/admin/api/licenses/revoke` | POST | (Deferred - not implemented) |
| `/admin/api/subscriptions/cancel` | POST | Cancel subscription (Stripe or crypto) |
| `/admin/login` | GET | Login page with wallet selector |
| `/admin/dashboard` | GET | Stats dashboard with conversion metrics |
| `/admin/licenses` | GET | License management page |
| `/admin/subscriptions` | GET | Subscription management page |
| `/pay/:intentId` | GET | Crypto payment page with wallet selector |
| `/api/telemetry` | POST | Record extension telemetry events |

## Architecture Notes

### near-connect Integration
```javascript
import { NearConnector } from 'https://esm.sh/@hot-labs/near-connect';
const connector = new NearConnector({
  network: 'testnet', // from NEAR_NETWORK env
  features: { signMessage: true }
});
const wallet = await connector.connect();
const signResult = await connector.signMessage({ message, nonce, recipient });
```

### NEP-413 Signature Verification
```
1. Create 32-byte random nonce
2. Borsh-serialize: { message: String, nonce: [u8;32], recipient: String, callbackUrl: Option<String> }
3. Prepend tag: 2^31 + 413 = 2147484061 (4 bytes, little-endian)
4. SHA-256 hash the combined bytes
5. Verify ed25519 signature against hash
```

### htmx Auth Header Injection
```html
<!-- BEFORE htmx.js loads -->
<script>
  document.addEventListener('htmx:configRequest', function(event) {
    var token = localStorage.getItem('specflow_admin_token');
    if (token) event.detail.headers['Authorization'] = 'Bearer ' + token;
  });
</script>
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
```

### Telemetry & Conversion Tracking
```
Extension Events → POST /api/telemetry → TELEMETRY KV
                                              ↓
Dashboard ← GET /admin/api/stats ← getTelemetryStats()

Flow tracked:
1. activate: Extension starts (anonymous installId)
2. login: User authenticates with NEAR wallet
3. upgrade: User becomes licensed (free → pro)

Conversion Rate = (Pro Users / Logged In Users) × 100
```

Dashboard shows 4 telemetry cards:
- **Total Installs**: All unique extension installations
- **Logged In**: Users who authenticated with NEAR wallet
- **Pro Users**: Users who upgraded to licensed status
- **Conversion Rate**: Percentage of logged-in users who upgraded

## Phase 1.5 Completion Status

This phase (01.5-06) completes the Phase 1.5 Licensing milestone:

- [x] 01.5-01: NEAR License Contract
- [x] 01.5-02: Stripe Integration
- [x] 01.5-03: Crypto Payments via NEAR Intents
- [x] 01.5-04: VS Code Extension License Validation
- [x] 01.5-05: Admin API Endpoints
- [x] 01.5-06: Admin Dashboard UI (with telemetry/conversion tracking)

**Phase 1.5 is now complete.**

---
*Phase: 01.5-licensing*
*Completed: 2026-01-14*
