---
phase: 01.5-licensing
plan: 06
type: execute
---

<objective>
Create admin dashboard UI and implement administrative action endpoints for license/subscription management.

Purpose: Provide visual interface for admin operations and enable license grant/revoke and subscription cancellation.
Output: htmx-based dashboard served from Worker with full admin functionality.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Auto-selected based on dependency graph:
@.planning/phases/01.5-licensing/01.5-05-PLAN.md
@.planning/phases/01.5-licensing/01.5-02-SUMMARY.md
@.planning/phases/01.5-licensing/01.5-03-SUMMARY.md

# Key files from prior phases:
@workers/license-api/src/index.ts
@workers/license-api/src/services/near-contract.ts
@contracts/license/src/lib.rs

**Tech stack available:**
- Hono web framework on Cloudflare Workers
- htmx for dynamic UI updates (CDN-loaded)
- Tailwind CSS (CDN-loaded)
- NEAR contract with grant_license method

**Established patterns:**
- Admin auth via JWT from 01.5-05
- NEAR contract calls via JSON-RPC (near-contract.ts)
- KV-based subscription storage

**Constraining decisions:**
- [01.5-05]: Admin API endpoints at /admin/api/*
- [01.5-01]: NEAR contract only has grant_license (no revoke - set expiry to past)
- [01.5-02/03]: Stripe and crypto subscription cancel via existing handlers

**UI architecture:**
Serve static HTML from Worker routes. Use htmx for AJAX calls to admin API.
No build step - inline HTML as template literals.
Admin must authenticate via wallet before accessing dashboard.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement administrative action endpoints</name>
  <files>workers/license-api/src/handlers/admin/actions.ts, workers/license-api/src/index.ts</files>
  <action>
1. Create workers/license-api/src/handlers/admin/actions.ts:

   POST /admin/api/licenses/grant:
   - Accept { nearAccountId: string, durationDays: number }
   - Validate inputs (nearAccountId format, durationDays 1-365)
   - Call grantLicense on NEAR contract (reuse near-contract.ts pattern)
   - Return { success: true, nearAccountId, expiry: number }
   - On error: { success: false, error: string }

   POST /admin/api/licenses/revoke:
   - Accept { nearAccountId: string }
   - Call grantLicense with durationDays = 0 (sets expiry to now, effectively revoking)
   - Note: NEAR contract extends from max(current, now), so granting 0 days = expiry at block_timestamp
   - Actually, this won't work - need different approach:
     - Option A: Add revoke_license to NEAR contract (requires redeploy)
     - Option B: Mark as revoked in KV, check KV before contract in extension
   - For now: Return error explaining revocation not yet supported, log to ISSUES.md
   - TODO: Add revoke_license to contract in future phase

   POST /admin/api/subscriptions/cancel:
   - Accept { nearAccountId: string, type: 'stripe' | 'crypto' }
   - For stripe: Call existing handleCancelSubscription logic
   - For crypto: Call existing handleCryptoSubscriptionCancel logic
   - Return { success: true, activeUntil: string }

2. Update workers/license-api/src/index.ts:
   - Mount action handlers on admin router:
     - POST /admin/api/licenses/grant
     - POST /admin/api/licenses/revoke
     - POST /admin/api/subscriptions/cancel
  </action>
  <verify>wrangler dev --local succeeds, POST /admin/api/licenses/grant with valid JWT creates license on NEAR contract</verify>
  <done>Admin can grant licenses and cancel subscriptions via API</done>
</task>

<task type="auto">
  <name>Task 2: Create admin dashboard HTML UI</name>
  <files>workers/license-api/src/handlers/admin/ui.ts, workers/license-api/src/index.ts</files>
  <action>
1. Create workers/license-api/src/handlers/admin/ui.ts with HTML templates as template literals:

   baseLayout(title, content): Wraps content in HTML shell with:
   - Tailwind CSS via CDN (https://cdn.tailwindcss.com)
   - htmx via CDN (https://unpkg.com/htmx.org@1.9.10)
   - Navigation header with links: Dashboard | Licenses | Subscriptions
   - JWT token passed via htmx headers (hx-headers='{"Authorization": "Bearer TOKEN"}')
   - Token stored in localStorage after login

   loginPage(): Simple login form that:
   - Explains admin must sign with NEAR wallet
   - Button to get challenge from /admin/auth/challenge
   - Instructions to sign with NEAR CLI or wallet
   - Input for signature, submit to /admin/auth/verify
   - On success, store JWT in localStorage, redirect to dashboard

   dashboardPage(): Stats dashboard with:
   - Cards showing: Stripe Active, Crypto Active, Monthly Revenue
   - hx-get="/admin/api/stats" hx-trigger="load" to fetch data
   - Auto-refresh every 60 seconds

   licensesPage(): License management with:
   - Search input: hx-get="/admin/api/licenses?search=" hx-trigger="keyup changed delay:300ms"
   - Results table: nearAccountId, expiry date, source, status
   - Grant form: nearAccountId input, duration dropdown (30/90/365 days), submit button
   - Form uses hx-post="/admin/api/licenses/grant"

   subscriptionsPage(): Subscription listing with:
   - Filter tabs: All | Stripe | Crypto
   - Table: nearAccountId, type, status, next charge date
   - Cancel button per row using hx-post with hx-confirm

2. Update workers/license-api/src/index.ts:
   - Add UI routes (protected by adminAuth middleware):
     - GET /admin/dashboard - dashboardPage()
     - GET /admin/licenses - licensesPage()
     - GET /admin/subscriptions - subscriptionsPage()
   - Add login route (NOT protected):
     - GET /admin/login - loginPage()
   - Redirect /admin to /admin/login if no valid JWT, else /admin/dashboard
  </action>
  <verify>wrangler dev --local succeeds, /admin/login renders login form, /admin/dashboard shows stats after authentication</verify>
  <done>Admin dashboard UI with htmx for license/subscription management</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Admin dashboard with wallet auth, stats, license management, and subscription management</what-built>
  <how-to-verify>
    1. Run: cd workers/license-api && wrangler dev --local
    2. Visit: http://localhost:8787/admin/login
    3. Verify login page renders with wallet auth instructions
    4. Get challenge: curl http://localhost:8787/admin/auth/challenge
    5. Sign challenge with NEAR CLI: near sign-message --accountId specflow.testnet --message "{challenge}"
    6. Submit signature to /admin/auth/verify and get JWT
    7. Visit /admin/dashboard with JWT - verify stats load
    8. Visit /admin/licenses - verify search works, grant form submits
    9. Visit /admin/subscriptions - verify listing loads
    10. Test grant license - verify NEAR contract updated
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] /admin/login renders login UI
- [ ] Wallet signature flow works (challenge → sign → JWT)
- [ ] Dashboard shows subscription stats from API
- [ ] License search returns results
- [ ] License grant creates on-chain license
- [ ] Subscription cancellation works
- [ ] All UI pages use consistent styling
- [ ] htmx requests include JWT auth header
</verification>

<success_criteria>

- Admin can log in via wallet signature
- Dashboard displays live subscription metrics
- License management: search and grant functional
- Subscription management: list and cancel functional
- UI renders correctly with Tailwind styling
- All actions properly authenticated
- Phase 1.5 Licensing complete
</success_criteria>

<output>
After completion, create `.planning/phases/01.5-licensing/01.5-06-SUMMARY.md`

Note: This completes Phase 1.5. Update ROADMAP.md to mark phase complete.
</output>
