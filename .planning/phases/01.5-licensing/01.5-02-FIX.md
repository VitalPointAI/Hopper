---
phase: 01.5-licensing
plan: 01.5-02-FIX
type: fix
---

<objective>
Fix UAT-002 by deploying NEAR license contract to testnet.

Source: 01.5-02-ISSUES.md
Priority: 0 critical, 1 major, 0 minor

Root cause: Contract was built in 01.5-01 but never deployed. The Stripe webhook cannot call grantLicense() without a deployed contract.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/01.5-licensing/01.5-02-ISSUES.md

**Contract built in:**
@.planning/phases/01.5-licensing/01.5-01-SUMMARY.md

**License API that needs the contract:**
@workers/license-api/src/services/near-contract.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deploy license contract to NEAR testnet</name>
  <files>contracts/license/</files>
  <action>
Deploy the compiled WASM to testnet using near-cli or cargo-near:

1. Verify WASM exists at contracts/license/target/wasm32-unknown-unknown/release/license.wasm
2. Create a testnet account for the contract (e.g., license.specflow.testnet or use existing sub-account)
3. Deploy using near-cli: `near deploy --accountId <contract-account> --wasmFile contracts/license/target/wasm32-unknown-unknown/release/license.wasm`
4. Initialize the contract: `near call <contract-account> new '{"admin": "<admin-account>"}' --accountId <admin-account>`

Note: Use cargo-near if available: `cargo near deploy`

The admin account should be an account you control (can be the same as contract account for testnet).
  </action>
  <verify>
- `near view <contract-account> is_licensed '{"account_id": "test.testnet"}'` returns false
- `near view <contract-account> get_expiry '{"account_id": "test.testnet"}'` returns null
- Contract responds to queries (deployed and initialized)
  </verify>
  <done>Contract deployed to testnet, responds to view calls</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Configure .dev.vars with deployed contract credentials</action>
  <instructions>
I deployed the contract to testnet.

You need to add these to workers/license-api/.dev.vars:

```
NEAR_PRIVATE_KEY=ed25519:xxx  # Admin account private key (from ~/.near-credentials/testnet/)
LICENSE_CONTRACT_ID=<contract-account-from-task-1>
NEAR_NETWORK=testnet
NEAR_RPC_URL=https://rpc.testnet.fastnear.com
FASTNEAR_API_KEY=xxx  # Optional but recommended for rate limits
```

To get your private key:
1. Check ~/.near-credentials/testnet/<admin-account>.json
2. Copy the private_key value
  </instructions>
  <verification>Check .dev.vars has NEAR_PRIVATE_KEY and LICENSE_CONTRACT_ID set</verification>
  <resume-signal>Type "done" when .dev.vars is configured</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Test grant_license from license-api</name>
  <files>workers/license-api/</files>
  <action>
Start the license-api worker and test the full Stripe → NEAR flow:

1. Start worker: cd workers/license-api && npx wrangler dev
2. Start Stripe CLI: stripe listen --forward-to localhost:8787/webhook/stripe
3. Create checkout: curl -X POST http://localhost:8787/api/checkout -H "Content-Type: application/json" -d '{"nearAccountId": "test.testnet", "successUrl": "https://example.com/success", "cancelUrl": "https://example.com/cancel"}'
4. Complete checkout in browser with test card 4242 4242 4242 4242
5. Check worker logs for "Granted X-day license to test.testnet, tx: ..."
6. Verify on-chain: near view <contract> get_expiry '{"account_id": "test.testnet"}'

If grantLicense fails, check:
- NEAR_PRIVATE_KEY is correct format (ed25519:xxx...)
- LICENSE_CONTRACT_ID matches deployed contract
- Admin account has the private key you configured
  </action>
  <verify>
- Worker logs show successful license grant with transaction hash
- `near view <contract> get_expiry '{"account_id": "test.testnet"}'` returns a future timestamp
- Subscription status endpoint shows subscription data (not "none")
  </verify>
  <done>Full Stripe payment → NEAR license grant flow works end-to-end</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Contract deployed to testnet and responds to view calls
- [ ] .dev.vars configured with contract credentials
- [ ] invoice.paid webhook successfully calls grantLicense()
- [ ] Subscription saved to KV after successful payment
- [ ] Status endpoint returns subscription data
</verification>

<success_criteria>
- UAT-002 resolved: invoice.paid webhook completes successfully
- Full payment → license grant → subscription tracking flow works
- Ready for re-verification with /gsd:verify-work 01.5-02
</success_criteria>

<output>
After completion, create `.planning/phases/01.5-licensing/01.5-02-FIX-SUMMARY.md`
</output>
